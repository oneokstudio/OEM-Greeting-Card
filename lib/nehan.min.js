/*!
 nehan.js
 Copyright (C) 2010 - 2015 Watanabe Masaki<lambda.watanabe[at]gmail.com>
 repository: https://github.com/tategakibunko/nehan.js
 url: http://tb.antiscroll.com/

 licensed under MIT license.

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/
var Nehan=Nehan||{};Nehan.version="5.3.2",Nehan.Config={lang:"ja-JP",debug:!1,kerning:!0,hyphenate:!0,danglingHyphenate:!0,maxRollbackCount:20,maxYieldCount:2e4,maxPageCount:5e3,useVerticalGlyphIfEnable:!0,enableAutoCloseTag:!1,allowedInlineStyleProps:[]},Nehan.Display={root:"document",flow:"tb-rl",boxFlow:{hori:"lr-tb",vert:"tb-rl"},width:screen.width,height:screen.height,fontSize:16,minFontSize:12,maxFontSize:90,minTableCellSize:48,rubyRate:.5,boldRate:.12,lineHeight:2,spaceSizeRate:{thinsp:.2,nbsp:.38,ensp:.5,emsp:1},tabCount:4,fontColor:"000000",linkColor:"0000FF",fontImgRoot:"https://raw.githubusercontent.com/tategakibunko/nehan.js/master/char-img",fontFamily:"'ヒラギノ明朝 Pro W3','Hiragino Mincho Pro','HiraMinProN-W3','IPA明朝','IPA Mincho', 'Meiryo','メイリオ','ＭＳ 明朝','MS Mincho', monospace",fontSizeNames:{"xx-large":"33px","x-large":"24px",large:"18px",medium:"16px",small:"13px","x-small":"10px","xx-small":"8px",larger:"1.2em",smaller:"0.8em"},getMeasure:function(t){return this[t.getPropMeasure()]},getExtent:function(t){return this[t.getPropExtent()]},getVertBlockDir:function(){return this.boxFlow.vert.splice("-")[1]},getStdFont:function(){var t=new Nehan.Font(this.fontSize);return t.family=this.fontFamily,t.weight="normal",t.style="normal",t},getStdBoxFlow:function(){return Nehan.BoxFlows.getByName(this.flow)},getStdVertFlow:function(){return Nehan.BoxFlows.getByName(this.boxFlow.vert)},getStdHoriFlow:function(){return Nehan.BoxFlows.getByName(this.boxFlow.hori)},getRtFontSize:function(t){return Math.round(this.rubyRate*t)},getPaletteFontColor:function(t){return t.getValue().toLowerCase()!==this.fontColor.toLowerCase()?t.getPaletteValue():this.fontColor}},Nehan.Client=function(){function t(){this.userAgent=navigator.userAgent.toLowerCase(),this.name=navigator.appName.toLowerCase(),this.version=parseInt(navigator.appVersion,10),this._parseUserAgent(this.userAgent)}return t.prototype.isWindows=function(){return this.userAgent.indexOf("windows")>=0},t.prototype.isMacintosh=function(){return this.userAgent.indexOf("macintosh")>=0},t.prototype.isIphone=function(){return this.userAgent.indexOf("iphone")>=0},t.prototype.isIpod=function(){return this.userAgent.indexOf("ipod")>=0},t.prototype.isIpad=function(){return this.userAgent.indexOf("ipad")>=0},t.prototype.isAppleMobileFamily=function(){return this.isIphone()||this.isIpod()||this.isIpad()},t.prototype.isAndroid=function(){return this.userAgent.indexOf("android")>=0},t.prototype.isSmartPhone=function(){return this.isAppleMobileFamily()||this.isAndroid()},t.prototype.isWebkit=function(){return this.userAgent.indexOf("webkit")>=0},t.prototype.isIE=function(){return"msie"===this.name},t.prototype.isTrident=function(){return this.isIE()&&this.version>=11},t.prototype.isChrome=function(){return"chrome"===this.name},t.prototype.isSafari=function(){return"safari"===this.name},t.prototype.isFirefox=function(){return"firefox"===this.name},t.prototype._parseUserAgent=function(t){return t.indexOf("trident")>=0&&t.indexOf("msie")<0?(this.name="msie",void(this.version=this._parseVersionPureTrident(t))):t.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(?:\.\d+)*)/)?(this.name=RegExp.$1.toLowerCase(),void(this.version=this._parseVersionNormalClient(t,parseInt(RegExp.$2,10)))):this.isAppleMobileFamily()?(this.name="safari",void(this.version=this._parseVersionAppleMobileFamily(t))):void 0},t.prototype._parseVersionPureTrident=function(t){return t.match(/rv:([\.\d]+)/)?parseInt(RegExp.$1,10):this.version},t.prototype._parseVersionNormalClient=function(t,e){return t.match(/version\/([\.\d]+)/)?parseInt(RegExp.$1,10):e},t.prototype._parseVersionAppleMobileFamily=function(t){return t.match(/os ([\d_]+) like/)?parseInt(RegExp.$1,10):this.version},t}(),Nehan.Env=function(){var t=new Nehan.Client,e=!(t.isIE()&&t.version<=8),n=t.isIE()&&t.version>=10,r=t.isChrome()&&t.version>=24,i=t.isSafari()&&t.version>=5,o=r||i||n;return{client:t,isTransformEnable:e,isVerticalGlyphEnable:o}}(),Nehan.LexingRule=function(){var t=["br","hr","img","input","link","meta","wbr","?xml","!doctype","page-break","end-page","pbr"],e=function(e){return Nehan.List.exists(t,Nehan.Closure.eq(e))};return{getSingleTagNames:function(){return t},isSingleTag:function(t){return e(t)||!1},addSingleTagByName:function(n){n=n.toLowerCase(),e(n)||t.push(n)}}}(),Nehan.Class={},Nehan.Class.extend=function(t,e){function n(){}n.prototype=e.prototype,t.superClass_=e.prototype,t.prototype=new n,t.prototype.constructor=t},Nehan.List={iter:function(t,e){for(var n=0,r=t.length;r>n&&e(t[n],n)!==!1;n++);},reviter:function(t,e){for(var n=t.length-1;n>=0&&e(t[n],n)!==!1;n--);},forall:function(t,e){for(var n=0,r=t.length;r>n;n++)if(e(t[n],n)===!1)return!1;return!0},map:function(t,e){for(var n=[],r=0,i=t.length;i>r;r++)n.push(e(t[r],r));return n},fold:function(t,e,n){for(var r=e,i=0,o=t.length;o>i;i++)r=n(r,t[i],i);return r},filter:function(t,e){for(var n=[],r=0,i=t.length;i>r;r++)e(t[r],r)&&n.push(t[r]);return n},find:function(t,e){for(var n=0,r=t.length;r>n;n++){var i=t[n];if(e(i,n))return i}return null},revfind:function(t,e){for(var n=t.length-1;n>=0;n--){var r=t[n];if(e(r,n))return r}return null},indexOf:function(t,e){for(var n=0,r=t.length;r>n;n++){var i=t[n];if(e(i,n))return n}return-1},exists:function(t,e){for(var n=0,r=t.length;r>n;n++)if(e(t[n],n))return!0;return!1},mem:function(t,e){for(var n=0,r=t.length;r>n;n++)if(t[n]==e)return!0;return!1},sum:function(t,e,n){return this.fold(t,e,function(t,e){return t+n(e)})},minobj:function(t,e){var n=null,r=null;return this.iter(t,function(t,i){var o=e(t,i);(null===r||r>o)&&(n=t,r=o)}),n},maxobj:function(t,e){var n=null,r=null;return this.iter(t,function(t,i){var o=e(t,i);(null===r||o>r)&&(n=t,r=o)}),n},refcopy:function(t){for(var e=[],n=0,r=t.length;r>n;n++)e[n]=t[n];return e},count:function(t,e){for(var n=0,r=0,i=t.length;i>r;r++)e(t[r],r)&&n++;return n},create:function(t,e){for(var n=[],r=0;t>r;r++)n.push("undefined"!=typeof e?e:r);return n},first:function(t){return t[0]||null},last:function(t){var e=t.length;return 0===e?null:t[e-1]},zip:function(t,e){for(var n=[],r=0,i=Math.min(t.length,e.length);i>r;r++)n[r]=[t[r],e[r]];return n},zipObj:function(t,e){var n={};if(t.length!==e.length)throw"invalid args:List.zipObj";for(var r=0,i=t.length;i>r;r++)n[t[r]]=e[r];return n},reverse:function(t){var e=[];return this.reviter(t,function(t){e.push(t)}),e}},Nehan.Args={copy:function(t,e){t=t||{};for(var n in e)t[n]=e[n];return t},copy2:function(t,e){t=t||{};for(var n in e)"object"==typeof t[n]?this.copy2(t[n],e[n]):t[n]=e[n];return t},merge:function(t,e,n){t=t||{};for(var r in e)t[r]="undefined"==typeof n[r]?e[r]:n[r];return t}},Nehan.Obj=function(){var t=function(e){var n;if(null===e||"object"!=typeof e)return e;if(e instanceof Array){n=[];for(var r=0;r<e.length;r++)n[r]=t(e[r]);return n}if(e instanceof Object){n={};for(var i in e)e.hasOwnProperty(i)&&(n[i]=t(e[i]));return n}throw"Obj::clone(unsupported type)"};return{isEmpty:function(t){for(var e in t)return!1;return!0},clone:function(e){return t(e)},map:function(t,e){var n={};return this.iter(t,function(t,r){n[t]=e(t,r)}),n},exists:function(t,e){for(var n in t)if(e(n,t[n]))return!0;return!1},filter:function(t,e){var n={};return this.iter(t,function(t,r){e(t,r)&&(n[t]=r)}),n},iter:function(t,e){for(var n in t)e(n,t[n])},forall:function(t,e){for(var n in t)if(!e(n,t[n]))return!1;return!0}}}(),Nehan.Utils={convBase:function(t,e){if(0===t)return[0];for(var n=[],r=t;r>0;)n.unshift(r%e),r=Math.floor(r/e);return n},trimHeadCRLF:function(t){return t.replace(/^\n+/,"")},trimFootCRLF:function(t){return t.replace(/\n+$/,"")},trimCRLF:function(t){return this.trimFootCRLF(this.trimHeadCRLF(t))},trim:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},cutQuote:function(t){return t.replace(/['\"]/g,"")},capitalize:function(t){return""===t?"":t.charAt(0).toUpperCase()+t.slice(1)},filenameConcat:function(t,e){return t=""===t?"":"/"===t.slice(-1)?t:t+"/",e=""===e?"":"/"===e[0]?e.substring(1,e.length):e,t+e},camelToChain:function(t){return t.replace(/([A-Z])/g,function(t,e){return"-"+e.toLowerCase()})},camelize:function(t){var e=this;return t.indexOf("-")<0?t:Nehan.List.map(t.split("-"),function(t,n){return 0===n?t:e.capitalize(t)}).join("")}},Nehan.Const={cssVenderPrefixes:["-moz","-webkit","-o","-ms"],cssCorders:["top-left","top-right","bottom-left","bottom-right"],cssBorderRadius:["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius"],cssBoxDirs:["top","right","bottom","left"],cssBoxDirsLogical:["before","end","after","start"],cssBoxCornersLogical:["start-before","end-before","end-after","start-after"],css2dIndex:{1:[0,0],2:[0,1]},css4dIndex:{1:[0,0,0,0],2:[0,1,0,1],3:[0,1,2,1],4:[0,1,2,3]},space:"&nbsp;",clearFix:"<div style='clear:both'></div>"},Nehan.Css={toString:function(t){var e=[];for(var n in t)e.push(n+":"+t[n]);return e.join(";")},addNehanPrefix:function(t){return 0===t.indexOf("nehan-")?t:"nehan-"+t},addNehanHeaderPrefix:function(t){return"nehan-header-"+t},addNehanTocLinkPrefix:function(t){return"nehan-toc-link-"+t},setCssValueWithVender:function(t,e,n){return t[e]=n,Nehan.List.iter(Nehan.Const.cssVenderPrefixes,function(r){t[r+"-"+e]=n}),t}},Nehan.Html={escape:function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},unescape:function(t){var e=document.createElement("div");return e.innerHTML=t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\r/g,"&#13;").replace(/\n/g,"&#10;"),e.textContent||e.innerText},attr:function(t){var e=[];for(var n in t)"undefined"!=typeof t[n]&&""!==t[n]&&e.push(n+"='"+this.escape(t[n]+"")+"'");return e==[]?"":e.join(" ")},tagWrap:function(t,e,n){return[this.tagStart(t,n||{}),e,this.tagEnd(t)].join("")},tagSingle:function(t,e){return"<"+t+" "+this.attr(e)+"/>"},tagStart:function(t,e){return"<"+t+" "+this.attr(e)+">"},tagEnd:function(t){return"</"+t+">"}},Nehan.Uri=function(){function t(t){this.address=this._normalize(t||"")}return t.prototype._normalize=function(t){return t.replace(/\s/g,"")},t.prototype.getAddress=function(){return this.address},t.prototype.getAnchorName=function(){var t=this.address.indexOf("#");if(0>t)return"";var e=this.address.substring(t+1);return e.length>0?e:""},t}(),Nehan.TagAttrLexer=function(){function t(t){this.buff=t,this._error=!1}var e=/[^=\s]+/;return t.prototype.isEnd=function(){return this._error||""===this.buff},t.prototype.get=function(){var t=this._peek();if(null===t)return null;switch(t){case"=":return this._step(1),t;case"'":case'"':return this._getLiteral(t);case" ":return this._step(1),this.get();default:return this._getSymbol()}},t.prototype._peek=function(){return this.buff?this.buff.charAt(0):null},t.prototype._step=function(t){this.buff=this.buff.substring(t)},t.prototype._getSymbol=function(){var t=this.buff.match(e),n=t?t[0]:null;return n&&this._step(n.length),n},t.prototype._getLiteral=function(t){var e=this.buff.indexOf(t,1);if(0>e)return console.error("TagAttrLexer::syntax error:literal not closed(%s)",this.buff),this._error=!0,null;var n=this.buff.substring(1,e);return this._step(e+1),n},t}(),Nehan.TagAttrParser={parse:function(t){for(var e=new Nehan.TagAttrLexer(t),n=null,r=null,i={};null!==r||!e.isEnd();)n=e.get(),null===n?r&&(i[r]="true",r=null):"="===n&&r?(i[r]=e.get()||"true",r=null):r?(i[r]="true",r=n):n&&"="!==n&&(r=n);return i}},Nehan.TagAttrs=function(){function t(t){var e=t?Nehan.TagAttrParser.parse(t):{};this.classes=this._parseClasses(e),this.attrs=this._parseAttrs(e),this.dataset=this._parseDataset(e)}var e=function(t){return Nehan.Utils.camelize(t.slice(5))};return t.prototype.hasAttr=function(t){return"undefined"!=typeof this.attrs.name},t.prototype.hasClass=function(t){return Nehan.List.exists(this.classes,Nehan.Closure.eq(t))},t.prototype.addClass=function(t){return this.hasClass(t)||(this.classes.push(t),this.setAttr("class",[this.getAttr("class"),t].join(" "))),this.classes},t.prototype.removeClass=function(t){return this.classes=Nehan.List.filter(this.classes,function(e){return e!=t}),this.setAttr("class",this.classes.join(" ")),this.classes},t.prototype.getAttr=function(t,e){return e="undefined"==typeof e?null:e,"undefined"==typeof this.attrs[t]?e:this.attrs[t]},t.prototype.getData=function(t,e){return e="undefined"==typeof e?null:e,"undefined"==typeof this.dataset[t]?e:this.dataset[t]},t.prototype.getKey=function(){var t=Object.keys(this.attrs).sort();return Nehan.List.map(t,function(t){return t+"="+this.attrs[t]}.bind(this)).join("&")},t.prototype.setAttr=function(t,n){0===t.indexOf("data-")?this.setData(e(t),n):this.attrs[t]=n},t.prototype.setData=function(t,e){this.dataset[t]=e},t.prototype._parseClasses=function(t){var e=t["class"]||"";e=Nehan.Utils.trim(e.replace(/\s+/g," "));var n=""===e?[]:e.split(/\s+/);return Nehan.List.map(n,function(t){return 0===t.indexOf("nehan-")?t.replace("nehan-",""):t})},t.prototype._parseAttrs=function(t){var e={};return Nehan.Obj.iter(t,function(t,n){t.indexOf("data-")<0&&(e[t]=n)}),e},t.prototype._parseDatasetValue=function(t){switch(t){case"true":return!0;case"false":return!1;default:return isNaN(t)?t:Number(t)}},t.prototype._parseDataset=function(t){var n={};for(var r in t)0===r.indexOf("data-")&&(n[e(r)]=this._parseDatasetValue(t[r]));return n},t}(),Nehan.Tag=function(){function t(t,e){this._type="tag",this.src=t,this.content=e||"",this.name=this._parseName(this.src),this.attrs=this._parseTagAttrs(this.name,this.src),this._key=this._createKey(),this._firstChild=!1,this._firstOfType=!1,this._lastChild=!1,this._lastOfType=!1,this._onlyChild=!1,this._onlyOfType=!1}return t.prototype.clone=function(){return new t(this.src,this.content)},t.prototype.setContent=function(t){this._fixed||(this.content=t)},t.prototype.setContentImmutable=function(t){this._fixed=t},t.prototype.setAlias=function(t){this.alias=t},t.prototype.setAttr=function(t,e){this.attrs.setAttr(t,e)},t.prototype.setAttrs=function(t){for(var e in t)this.setAttr(e,t[e])},t.prototype.setData=function(t,e){this.attrs.setData(t,e)},t.prototype.setFirstChild=function(t){this._firstChild=t},t.prototype.setOnlyChild=function(t){this._onlyChild=t},t.prototype.setOnlyOfType=function(t){this._onlyOfType=t},t.prototype.setFirstOfType=function(t){this._firstOfType=t},t.prototype.setLastChild=function(t){this._lastChild=t},t.prototype.setLastOfType=function(t){this._lastOfType=t},t.prototype.addClass=function(t){this.attrs.addClass(t)},t.prototype.removeClass=function(t){this.attrs.removeClass(t)},t.prototype.getId=function(){return this.attrs.getAttr("id")},t.prototype.getClasses=function(){return this.attrs.classes},t.prototype.getName=function(){return this.alias||this.name},t.prototype.getAttr=function(t,e){return this.attrs.getAttr(t,e)},t.prototype.getData=function(t,e){return this.attrs.getData(t,e)},t.prototype.getContent=function(){return this.content},t.prototype.getSrc=function(){return this.src},t.prototype.getWrapSrc=function(){return""===this.content?this.src:this.src+this.content+"</"+this.name+">"},t.prototype.getKey=function(){return this._key},t.prototype.hasClass=function(t){return this.attrs.hasClass(t)},t.prototype.hasAttr=function(t){return this.attrs.hasAttr(t)},t.prototype.isHeaderTag=function(){return Nehan.List.exists(["h1","h2","h3","h4","h5","h6"],Nehan.Closure.eq(this.name))},t.prototype.isAnchorTag=function(){return"a"===this.name&&null!==this.getTagAttr("name")},t.prototype.isAnchorLinkTag=function(){var t=this.getTagAttr("href");return"a"===this.name&&t&&t.indexOf("#")>=0},t.prototype.isPageBreakTag=function(){return"page-break"===this.name||"end-page"===this.name||"pbr"===this.name},t.prototype.isCloseTag=function(){return"/"===this.name.charAt(0)},t.prototype.isSingleTag=function(){return this._single||!1},t.prototype.isEmpty=function(){return""===this.content},t.prototype.isFirstChild=function(){return this._firstChild},t.prototype.isOnlyChild=function(){return this._onlyChild},t.prototype.isOnlyOfType=function(){return this._onlyOfType},t.prototype.isFirstOfType=function(){return this._firstOfType},t.prototype.isLastChild=function(){return this._lastChild},t.prototype.isLastOfType=function(){return this._lastOfType},t.prototype._getTagAttrSrc=function(t){return t.replace(/<[\S]+/,"").replace(/^\s+/,"").replace("/>","").replace(">","").replace(/\s+$/,"").replace(/\n/g," ").replace(/[　|\s]+/g," ").replace(/\s+=/g,"=").replace(/=\s+/g,"=")},t.prototype._createKey=function(){return this.getName()+"["+this.attrs.getKey()+"]"},t.prototype._parseName=function(t){return t.replace(/</g,"").replace(/\/?>/g,"").split(/\s/)[0].toLowerCase()},t.prototype._parseTagAttrs=function(t,e){var n=this._getTagAttrSrc(e);return new Nehan.TagAttrs(t.length===n.length?"":n)},t}(),Nehan.Closure={id:function(){return function(t){return t}},eq:function(t){return function(e){return t==e}},neq:function(t){return function(e){return t!=e}},isTagName:function(t){return function(e){if(e instanceof Nehan.Tag==!1)return!1;var n=e.getName();return Nehan.List.exists(t,function(t){return t===n})}}},Nehan.HashSet=function(){function t(t){this._values=Nehan.Obj.clone(t||{})}return t.prototype.iter=function(t){Nehan.Obj.iter(this._values,t)},t.prototype.merge=function(t,e){return e},t.prototype.union=function(t){return t.iter(function(t,e){this.add(t,e)}.bind(this)),this},t.prototype.get=function(t){return this._values[t]||null},t.prototype.getValues=function(){return this._values},t.prototype.add=function(t,e){var n=this._values[t]||null,r=n?this.merge(n,e):e;this._values[t]=r},t.prototype.addValues=function(t){for(var e in t)this.add(e,t[e])},t.prototype.remove=function(t){delete this._values[t]},t}(),Nehan.CssHashSet=function(){function t(t){Nehan.HashSet.call(this,t)}return Nehan.Class.extend(t,Nehan.HashSet),t.prototype.add=function(t,e){t=Nehan.Utils.camelToChain(t),Nehan.HashSet.prototype.add.call(this,t,e)},t.prototype.merge=function(t,e){return"object"==typeof t?(Nehan.Args.copy(t,e),t):e},t.prototype.copyValuesTo=function(t){return Nehan.Args.copy(t,this._values)},t}(),Nehan.CssParser=function(){var t=function(t){return Nehan.Utils.trim(String(t)).replace(/;/g,"").replace(/\n/g,"")},e=function(t){return t.indexOf(" ")<0?[t]:t.split(/\s+/)},n=function(t){return t.indexOf("/")<0?[t]:t.split("/")},r=function(t,e){var n={};if(t.length!==e.length)throw"invalid args:__zip_obj";return Nehan.List.iter(t,function(t,r){n[t]=e[r]}),n},i=function(t){return Nehan.Const.css2dIndex[Math.min(t,2)]||[]},o=function(t){return Nehan.Const.css4dIndex[Math.min(t,4)]||[]},s=function(t,e){return Nehan.List.map(e,function(e){return t[e]})},a=function(t){var e=i(t.length);return s(t,e)},h=function(t){var e=o(t.length);return s(t,e)},l=function(t){var e=Nehan.Const.cssBoxDirsLogical,n=h(t);return Nehan.List.zipObj(e,n)},u=function(t){var e=Nehan.Const.cssBoxCornersLogical,n=h(t);return r(e,n)},p=function(t){return l(e(t))},c=function(t){var r=a(n(t)),i=Nehan.List.map(r,function(t){return h(e(t))}),o=Nehan.List.zip(i[0],i[1]);return u(o)},f=function(t){return t=Nehan.Utils.camelToChain(t),t.indexOf("margin-")>=0||t.indexOf("padding-")>=0||t.indexOf("border-width-")>=0?t.split("-")[0]:t},g=function(e,n){switch(typeof n){case"function":case"object":case"boolean":return n}switch(n=t(n),e){case"border-width":return p(n);case"border-radius":return c(n);case"border-color":return p(n);case"border-style":return p(n);case"margin":return p(n);case"padding":return p(n);case"margin-before":case"padding-before":case"border-width-before":return{before:n};case"margin-end":case"padding-end":case"border-width-end":return{end:n};case"margin-after":case"padding-after":case"border-width-after":return{after:n};case"margin-start":case"padding-start":case"border-width-start":return{start:n};default:return n}};return{normalizeProp:function(t){return f(t)},formatValue:function(t,e){return g(Nehan.Utils.camelToChain(t),e)}}}(),Nehan.AttrSelector=function(){function t(t){this.expr=this._normalize(t),this.left=this.op=this.right=null,this._parseExpr(this.expr)}var e=/[^=^~|$*\s]+/,n=["|=","~=","^=","$=","*=","="];return t.prototype.test=function(t){return this.op&&this.left&&this.right?this._testOp(t):this.left?this._testHasAttr(t):!1},t.prototype._normalize=function(t){return t.replace(/\[/g,"").replace(/\]/g,"")},t.prototype._parseSymbol=function(t){var n=t.match(e);return n?n[0]:""},t.prototype._parseOp=function(t){return Nehan.List.find(n,function(e){return t.indexOf(e)>=0})},t.prototype._parseExpr=function(t){this.left=this._parseSymbol(t),this.left&&(t=Nehan.Utils.trim(t.slice(this.left.length))),this.op=this._parseOp(t),this.op&&(t=Nehan.Utils.trim(t.slice(this.op.length)),this.right=Nehan.Utils.cutQuote(Nehan.Utils.trim(t)))},t.prototype._testHasAttr=function(t){return null!==t.getMarkupAttr(this.left)},t.prototype._testEqual=function(t){var e=t.getMarkupAttr(this.left);return e===this.right},t.prototype._testCaretEqual=function(t){var e=t.getMarkupAttr(this.left),n=new RegExp("^"+this.right);return n.test(e)},t.prototype._testDollarEqual=function(t){var e=t.getMarkupAttr(this.left),n=new RegExp(this.right+"$");return n.test(e)},t.prototype._testTildeEqual=function(t){var e=t.getMarkupAttr(this.left),n=e?e.split(/\s+/):[];return Nehan.List.exists(n,Nehan.Closure.eq(this.right))},t.prototype._testPipeEqual=function(t){var e=t.getMarkupAttr(this.left);return e?e==this.right||e.indexOf(this.right+"-")>=0:!1},t.prototype._testStarEqual=function(t){var e=t.getMarkupAttr(this.left);return e.indexOf(this.right)>=0},t.prototype._testOp=function(t){switch(this.op){case"=":return this._testEqual(t);case"^=":return this._testCaretEqual(t);case"$=":return this._testDollarEqual(t);case"|=":return this._testPipeEqual(t);case"~=":return this._testTildeEqual(t);case"*=":return this._testStarEqual(t)}throw"undefined operation:"+this.op},t}(),Nehan.PseudoSelector=function(){function t(t){this.name=this._normalize(t)}return t.prototype.hasPseudoElement=function(){return"before"===this.name||"after"===this.name||"first-letter"===this.name||"first-line"===this.name},t.prototype.test=function(t){switch(this.name){case"before":return!0;case"after":return!0;case"first-letter":return!t.isMarkupEmpty();case"first-line":return!t.isMarkupEmpty();case"first-child":return t.isFirstChild();case"last-child":return t.isLastChild();case"first-of-type":return t.isFirstOfType();case"last-of-type":return t.isLastOfType();case"only-child":return t.isOnlyChild();case"only-of-type":return t.isOnlyOfType();case"empty":return t.isMarkupEmpty();case"root":return t.isRoot()}return!1},t.prototype._normalize=function(t){return t.replace(/:+/g,"")},t}(),Nehan.TypeSelector=function(){function t(t){this.name=t.name||null,this.nameRex=t.nameRex||null,this.id=t.id||null,this.classes=t.classes||[],this.attrs=t.attrs||[],this.pseudo=t.pseudo||null,this.classes.sort()}return t.prototype.test=function(t){return null===t?!1:this.name&&!this.testName(t.getMarkupName())?!1:this.nameRex&&!this.testNameRex(t.getMarkupName())?!1:this.classes.length>0&&!this.testClassNames(t.getMarkupClasses())?!1:this.id&&t.getMarkupId()!=this.id?!1:this.attrs.length>0&&!this._testAttrs(t)?!1:this.pseudo&&!this.pseudo.test(t)?!1:!0},t.prototype.testName=function(t){return null===this.name?!1:"*"===this.name?!0:t===this.name},t.prototype.testNameRex=function(t){return null===this.nameRex?!1:this.nameRex.test(t)},t.prototype.testClassNames=function(t){return Nehan.List.forall(this.classes,function(e){return Nehan.List.exists(t,Nehan.Closure.eq(e))})},t.prototype.getNameSpec=function(){return this.nameRex?1:null===this.name||"*"===this.name?0:1},t.prototype.getIdSpec=function(){return this.id?1:0},t.prototype.getClassSpec=function(){return this.classes.length},t.prototype.getAttrSpec=function(){return this.attrs.length},t.prototype.getPseudoClassSpec=function(){return this.pseudo?this.pseudo.hasPseudoElement()?0:1:0},t.prototype._testAttrs=function(t){return Nehan.List.forall(this.attrs,function(e){return e.test(t)})},t}(),Nehan.SelectorLexer=function(){function t(t){this.buff=this._normalize(t)}var e=/^[\w-_\*!\?]+/,n=/^\/[^\/]+\//,r=/^#[\w-_]+/,i=/^\.[\w-_]+/,o=/^\[[^\]]+\]/,s=/^:{1,2}[\w-_]+/;return t.prototype.getTokens=function(){for(var t=[];""!==this.buff;){var e=this._getNextToken();if(null===e)break;t.push(e)}return t},t.prototype._getNextToken=function(){if(this.buff=Nehan.Utils.trim(this.buff),""===this.buff)return null;var t=this.buff.charAt(0);switch(t){case"+":case"~":case">":return this._stepBuff(1),t;default:return this._getTypeSelector()}throw"invalid selector:["+this.buff+"]"},t.prototype._normalize=function(t){return Nehan.Utils.trim(t).replace(/\s+/g," ")},t.prototype._stepBuff=function(t){this.buff=Nehan.Utils.trim(this.buff.slice(t))},t.prototype._getByRex=function(t){var e=null,n=this.buff.match(t);return n&&(e=n[0],this._stepBuff(e.length)),e},t.prototype._getTypeSelector=function(){var t=this.buff.length,e=this._getName(),n=null===e?this._getNameRex():null,r=this._getId(),i=this._getClasses(),o=this._getAttrs(),s=this._getPseudo();if(this.buff.length===t)throw"invalid selector:["+this.buff+"]";return new Nehan.TypeSelector({name:e,nameRex:n,id:r,classes:i,attrs:o,pseudo:s})},t.prototype._getName=function(){return this._getByRex(e)},t.prototype._getNameRex=function(){var t=this._getByRex(n);return null===t?null:new RegExp(t.replace(/[\/]/g,""))},t.prototype._getId=function(){var t=this._getByRex(r);return t?t.substring(1):null},t.prototype._getClasses=function(){for(var t=[];;){var e=this._getClass();if(null===e)break;t.push(e)}return t},t.prototype._getClass=function(){var t=this._getByRex(i);return t?t.substring(1):null},t.prototype._getAttrs=function(){for(var t=[];;){var e=this._getByRex(o);if(null===e)break;t.push(new Nehan.AttrSelector(e))}return t},t.prototype._getPseudo=function(){var t=this._getByRex(s);return t?new Nehan.PseudoSelector(t):null},t}(),Nehan.SelectorStateMachine=function(){var t=function(t,e){for(var n=t.parent;null!==n;){if(e.test(n))return n;n=n.parent}return null},e=function(t,e){var n=t.parent;return null===n?null:e.test(n)?n:null},n=function(t,e){var n=t.getChildIndex(),r=t.getParentNthChild(n-1)||null;return r&&e.test(r)?r:null},r=function(t,e){for(var n=t.getChildIndex(),r=0;n>r;r++){var i=t.getParentNthChild(r);if(i&&e.test(i))return i}return null};return{accept:function(i,o){if(0===o.length)throw"selector syntax error:"+src;for(var s,a,h,l,u=o.length-1,p=function(){return 0>u?null:o[u--]},c=function(){u++};u>=0;){if(s=p(),s instanceof Nehan.TypeSelector==!1)throw"selector syntax error:"+src;if(!s.test(i))return!1;if(a=p(),null===a)return!0;if(a instanceof Nehan.TypeSelector)h=a,l=" ";else if("string"==typeof a&&(l=a,h=p(),null===h||h instanceof Nehan.TypeSelector==!1))throw"selector syntax error:"+src;switch(l){case" ":i=t(i,h);break;case">":i=e(i,h);break;case"+":i=n(i,h);break;case"~":i=r(i,h);break;default:throw"selector syntax error:invalid combinator("+l+")"}if(null===i)return!1;c()}return!0}}}(),Nehan.Selector=function(){function t(t,e){this.key=this._normalizeKey(t),this.value=this._formatValue(e),this.elements=this._getSelectorElements(this.key),this.spec=this._countSpec(this.elements)}return t.prototype.test=function(t){return Nehan.SelectorStateMachine.accept(t,this.elements)},t.prototype.testPseudoElement=function(t,e){return this.hasPseudoElementName(e)&&this.test(t)},t.prototype.updateValue=function(t){for(var e in t){var n=Nehan.CssParser.formatValue(e,t[e]),r="function"!=typeof n?Nehan.CssParser.normalizeProp(e):Nehan.Utils.camelToChain(e),i=this.value[r]||null;null!==i&&"object"==typeof i&&"object"==typeof n?Nehan.Args.copy(i,n):this.value[r]=n}},t.prototype.getKey=function(){return this.key},t.prototype.getValue=function(){return this.value},t.prototype.getSpec=function(){return this.spec},t.prototype.hasPseudoElement=function(){return this.key.indexOf("::")>=0},t.prototype.hasPseudoElementName=function(t){return this.key.indexOf("::"+t)>=0},t.prototype._countSpec=function(t){var e=0,n=0,r=0;return Nehan.List.iter(t,function(t){t instanceof Nehan.TypeSelector&&(e+=t.getIdSpec(),n+=t.getClassSpec()+t.getPseudoClassSpec()+t.getAttrSpec(),r+=t.getNameSpec())}),parseInt([e,n,r].join(""),10)},t.prototype._getSelectorElements=function(t){var e=new Nehan.SelectorLexer(t);return e.getTokens()},t.prototype._normalizeKey=function(t){return t=t instanceof RegExp?"/"+t.source+"/":t,Nehan.Utils.trim(t).toLowerCase().replace(/\s+/g," ")},t.prototype._formatValue=function(t){var e={};for(var n in t){var r=Nehan.CssParser.normalizeProp(n),i=Nehan.CssParser.formatValue(n,t[n]);e[r]=i}return e},t}(),Nehan.Rgb=function(){function t(t){this.value=String(t),this.red=parseInt(this.value.substring(0,2),16),this.green=parseInt(this.value.substring(2,4),16),this.blue=parseInt(this.value.substring(4,6),16)}return t.prototype.getRed=function(){return this.red},t.prototype.getGreen=function(){return this.green},t.prototype.getBlue=function(){return this.blue},t.prototype.getColorValue=function(){return this.value},t}(),Nehan.Colors=function(){var t={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4","indianred ":"cd5c5c","indigo ":"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32",transparent:"transparent"},e=/^(?:[0-9a-f]{3}){1,2}$/;return{get:function(n){return n=n.replace(/#/g,"").toLowerCase(),e.test(n)?3===n.length?n[0]+n[0]+n[1]+n[1]+n[2]+n[2]:n:t[n]||n}}}(),Nehan.Color=function(){
function t(t){this.setValue(t)}return t.prototype.setValue=function(t){this.value=Nehan.Colors.get(t)},t.prototype.getValue=function(){return this.value},t.prototype.getCssValue=function(){return"transparent"===this.value?this.value:"#"+this.value},t.prototype.getRgb=function(){return new Nehan.Rgb(this.value)},t.prototype.getCss=function(){var t={};return t.color=this.getCssValue(),t},t}(),Nehan.Palette=function(){var t=[0,36,73,109,146,182,219,255],e=[0,85,170,255],n=function(t){var e=t.toString(16);return e.length<=1?"0"+e:e},r=function(t,e){return Nehan.List.exists(e,Nehan.Closure.eq(t))?t:Nehan.List.minobj(e,function(e){return Math.abs(e-t)})};return{getColor:function(i){var o=r(i.getRed(),t),s=r(i.getGreen(),t),a=r(i.getBlue(),e);return[n(o),n(s),n(a)].join("")}}}(),Nehan.Cardinal=function(){var t={"lower-alpha":["a","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],"upper-alpha":["A","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],"lower-roman":["i","i","ii","iii","iv","v","vi","vii","viii","ix","x","xi","xii","xiii","xiv","xv","xvi","xvii","xviii","xix","xx"],"upper-roman":["I","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX"],"lower-greek":["α","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω"],"upper-greek":["Α","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω"],"cjk-ideographic":["〇","一","二","三","四","五","六","七","八","九","十"],hiragana:["あ","あ","い","う","え","お","か","き","く","け","こ","さ","し","す","せ","そ","た","ち","つ","て","と","な","に","ぬ","ね","の","は","ひ","ふ","へ","ほ","ま","み","む","め","も","や","ゆ","よ","ら","り","る","れ","ろ","わ","ゐ","ゑ","を","ん"],"hiragana-iroha":["い","い","ろ","は","に","ほ","へ","と","ち","り","ぬ","る","を","わ","か","よ","た","れ","そ","つ","ね","な","ら","む","う","ゐ","の","お","く","や","ま","け","ふ","こ","え","て","あ","さ","き","ゆ","め","み","し","ゑ","ひ","も","せ","す"],katakana:["ア","ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ヰ","ヱ","ヲ","ン"],"katakana-iroha":["イ","イ","ロ","ハ","ニ","ホ","ヘ","ト","チ","リ","ヌ","ル","ヲ","ワ","カ","ヨ","タ","レ","ソ","ツ","ネ","ナ","ラ","ム","ウ","ヰ","ノ","オ","ク","ヤ","マ","ケ","フ","コ","エ","テ","ア","サ","キ","ユ","メ","ミ","シ","ヱ","ヒ","モ","セ","ス"]},e={"upper-latin":"upper-alpha","lower-latin":"lower-alpha"};return{getTableByName:function(n){return t[e[n]||n]},getBaseByName:function(t){var e=this.getTableByName(t);return e.length},getStringByName:function(t,e){for(var n=this.getTableByName(t),r=n.length,i=Nehan.Utils.convBase(e,r),o="",s=0;s<i.length;s++){var a=i[s],h=0===s?i[s]:Math.min(a+1,r-1);o+=n[h]||""}return o}}}(),Nehan.BoxRect={iter:function(t,e){Nehan.List.iter(Nehan.Const.cssBoxDirs,function(n){t[n]&&e(n,t[n])})},setValue:function(t,e,n){return"undefined"!=typeof n.start&&this.setStart(t,e,n.start),"undefined"!=typeof n.end&&this.setEnd(t,e,n.end),"undefined"!=typeof n.before&&this.setBefore(t,e,n.before),"undefined"!=typeof n.after&&this.setAfter(t,e,n.after),t},setBefore:function(t,e,n){t[e.getPropBefore()]=n},setAfter:function(t,e,n){t[e.getPropAfter()]=n},setStart:function(t,e,n){t[e.getPropStart()]=n},setEnd:function(t,e,n){t[e.getPropEnd()]=n}},Nehan.BoxCorner=function(){var t=function(t,e){var n={top:0,bottom:1,left:2,right:3};return[t,e].sort(function(t,e){return n[t]-n[e]})};return{getCornerName:function(e,n){var r=t(e,n);return[r[0],Nehan.Utils.capitalize(r[1])].join("")}}}(),Nehan.Font=function(){function t(t){this.size=t}return t.prototype.isBold=function(){return this.weight&&"normal"!==this.weight&&"lighter"!==this.weight},t.prototype.toString=function(){return[this.weight||"normal",this.style||"normal",this.size+"px",this.family||"monospace"].join(" ")},t.prototype.getCss=function(){var t={};return this.size&&(t["font-size"]=this.size+"px"),this.weight&&(t["font-weight"]=this.weight),this.style&&(t["font-style"]=this.style),this.family&&(t["font-family"]=this.family),t},t}(),Nehan.Edge=function(){function t(t){this._type=t,this.top=0,this.right=0,this.bottom=0,this.left=0}return t.prototype.clear=function(){this.top=0,this.right=0,this.bottom=0,this.left=0},t.prototype.clearBefore=function(t){this[t.getPropBefore()]=0},t.prototype.clearAfter=function(t){this[t.getPropAfter()]=0},t.prototype.copyTo=function(t){var e=this;return Nehan.List.iter(Nehan.Const.cssBoxDirs,function(n){t[n]=e[n]}),t},t.prototype.getDirProp=function(t){return[this._type,t].join("-")},t.prototype.getCss=function(){var t={},e=this;return Nehan.List.iter(["top","right","bottom","left"],function(n){var r=e[n];r>0&&(t[e.getDirProp(n)]=e[n]+"px")}),t},t.prototype.getWidth=function(){return this.left+this.right},t.prototype.getHeight=function(){return this.top+this.bottom},t.prototype.getMeasure=function(t){return t.isTextVertical()?this.getHeight():this.getWidth()},t.prototype.getExtent=function(t){return t.isBlockflowVertical()?this.getHeight():this.getWidth()},t.prototype.setSize=function(t,e){Nehan.BoxRect.setValue(this,t,e)},t.prototype.setStart=function(t,e){this[t.getPropStart()]=e},t.prototype.setEnd=function(t,e){this[t.getPropEnd()]=e},t.prototype.setBefore=function(t,e){this[t.getPropBefore()]=e},t.prototype.setAfter=function(t,e){this[t.getPropAfter()]=e},t.prototype.getStart=function(t){return this[t.getPropStart()]},t.prototype.getEnd=function(t){return this[t.getPropEnd()]},t.prototype.getBefore=function(t){return this[t.getPropBefore()]},t.prototype.getAfter=function(t){return this[t.getPropAfter()]},t.prototype.setByName=function(t,e,n){switch(e){case"before":this.setBefore(t,n);break;case"end":this.setEnd(t,n);break;case"after":this.setAfter(t,n);break;case"start":this.setStart(t,n);break;default:console.error("Edge::setByName, undefined direction:",e)}},t.prototype.getByName=function(t,e){switch(e){case"before":return this.getBefore(t);case"end":return this.getEnd(t);case"after":return this.getAfter(t);case"start":return this.getStart(t);default:return consolo.error("Edge::getByName, undefined direction:",e),0}},t}(),Nehan.Radius2d=function(){function t(){this.hori=0,this.vert=0}return t.prototype.clone=function(){var t=new Nehan.Radius2d;return t.hori=this.hori,t.vert=this.vert,t},t.prototype.setSize=function(t){this.hori=t[0],this.vert=t[1]},t.prototype.getCssValueHori=function(){return this.hori+"px"},t.prototype.getCssValueVert=function(){return this.vert+"px"},t}(),Nehan.BorderRadius=function(){function t(){this.topLeft=new Nehan.Radius2d,this.topRight=new Nehan.Radius2d,this.bottomRight=new Nehan.Radius2d,this.bottomLeft=new Nehan.Radius2d}return t.prototype.clone=function(){var e=new t;return e.topLeft=this.topLeft.clone(),e.topRight=this.topRight.clone(),e.bottomRight=this.bottomRight.clone(),e.bottomLeft=this.bottomLeft.clone(),e},t.prototype.getArray=function(){return[this.topLeft,this.topRight,this.bottomRight,this.bottomLeft]},t.prototype.getCssValueHori=function(){return Nehan.List.map(this.getArray(),function(t){return t.getCssValueHori()}).join(" ")},t.prototype.getCssValueVert=function(){return Nehan.List.map(this.getArray(),function(t){return t.getCssValueVert()}).join(" ")},t.prototype.getCssValue=function(){return[this.getCssValueHori(),this.getCssValueVert()].join("/")},t.prototype.getCss=function(){var t={},e=this.getCssValue();return t["border-radius"]=e,Nehan.List.iter(Nehan.Const.cssVenderPrefixes,function(n){var r=[n,"border-radius"].join("-");t[r]=e}),t},t.prototype.getCorner=function(t,e){var n=Nehan.BoxCorner.getCornerName(t,e);return this[n]},t.prototype.setSize=function(t,e){"undefined"!=typeof e["start-before"]&&this.setStartBefore(t,e["start-before"]),"undefined"!=typeof e["start-after"]&&this.setStartAfter(t,e["start-after"]),"undefined"!=typeof e["end-before"]&&this.setEndBefore(t,e["end-before"]),"undefined"!=typeof e["end-after"]&&this.setEndAfter(t,e["end-after"])},t.prototype.setStartBefore=function(t,e){var n=this.getCorner(t.getPropStart(),t.getPropBefore());n.setSize(e)},t.prototype.setStartAfter=function(t,e){var n=this.getCorner(t.getPropStart(),t.getPropAfter());n.setSize(e)},t.prototype.setEndBefore=function(t,e){var n=this.getCorner(t.getPropEnd(),t.getPropBefore());n.setSize(e)},t.prototype.setEndAfter=function(t,e){var n=this.getCorner(t.getPropEnd(),t.getPropAfter());n.setSize(e)},t.prototype.clearBefore=function(t){this.setStartBefore(t,[0,0]),this.setEndBefore(t,[0,0])},t.prototype.clearAfter=function(t){this.setStartAfter(t,[0,0]),this.setEndAfter(t,[0,0])},t}(),Nehan.BorderColor=function(){function t(){}return t.prototype.clone=function(){var e=new t;return Nehan.List.iter(Nehan.Const.cssBoxDirs,function(t){this[t]&&(e[t]=this[t])}.bind(this)),e},t.prototype.setColor=function(t,e){var n=this;Nehan.BoxRect.setValue(this,t,e),Nehan.BoxRect.iter(this,function(t,e){n[t]=new Nehan.Color(e)})},t.prototype.getCss=function(){var t={};return Nehan.BoxRect.iter(this,function(e,n){var r=["border",e,"color"].join("-");t[r]=n.getCssValue()}),t},t}(),Nehan.BorderStyle=function(){function t(){}return t.prototype.clone=function(){var e=new t;return Nehan.List.iter(Nehan.Const.cssBoxDirs,function(t){this[t]&&(e[t]=this[t])}.bind(this)),e},t.prototype.setStyle=function(t,e){Nehan.BoxRect.setValue(this,t,e)},t.prototype.getCss=function(){var t={};return Nehan.BoxRect.iter(this,function(e,n){var r=["border",e,"style"].join("-");t[r]=n}),t},t}(),Nehan.Padding=function(){function t(){Nehan.Edge.call(this,"padding")}return Nehan.Class.extend(t,Nehan.Edge),t.prototype.clone=function(){return this.copyTo(new t)},t}(),Nehan.Margin=function(){function t(){Nehan.Edge.call(this,"margin")}return Nehan.Class.extend(t,Nehan.Edge),t.prototype.clone=function(){return this.copyTo(new t)},t}(),Nehan.Border=function(){function t(){Nehan.Edge.call(this,"border")}return Nehan.Class.extend(t,Nehan.Edge),t.prototype.clone=function(){var e=this.copyTo(new t);return this.radius&&(e.radius=this.radius.clone()),this.style&&(e.style=this.style.clone()),this.color&&(e.color=this.color.clone()),e},t.prototype.clearBefore=function(t){this.setBefore(t,0),this.radius&&this.radius.clearBefore(t)},t.prototype.clearAfter=function(t){this.setAfter(t,0),this.radius&&this.radius.clearAfter(t)},t.prototype.getDirProp=function(t){return["border",t,"width"].join("-")},t.prototype.setRadius=function(t,e){this.radius=new Nehan.BorderRadius,this.radius.setSize(t,e)},t.prototype.setColor=function(t,e){this.color=new Nehan.BorderColor,this.color.setColor(t,e)},t.prototype.setStyle=function(t,e){this.style=new Nehan.BorderStyle,this.style.setStyle(t,e)},t.prototype.getCss=function(){var t=Nehan.Edge.prototype.getCss.call(this);return this.radius&&Nehan.Args.copy(t,this.radius.getCss()),this.color&&Nehan.Args.copy(t,this.color.getCss()),this.style&&Nehan.Args.copy(t,this.style.getCss()),t},t}(),Nehan.BoxEdge=function(){function t(t){t=t||{},this.padding=t.padding||new Nehan.Padding,this.border=t.border||new Nehan.Border,this.margin=t.margin||new Nehan.Margin}return t.prototype.clone=function(){var e=new t;return e.padding=this.padding.clone(),e.border=this.border.clone(),e.margin=this.margin.clone(),e},t.prototype.clear=function(){this.padding.clear(),this.border.clear(),this.margin.clear()},t.prototype.getCss=function(){var t={};return Nehan.Args.copy(t,this.padding.getCss()),Nehan.Args.copy(t,this.border.getCss()),Nehan.Args.copy(t,this.margin.getCss()),t},t.prototype.getWidth=function(){var t=0;return t+=this.padding.getWidth(),t+=this.border.getWidth(),t+=this.margin.getWidth()},t.prototype.getHeight=function(){var t=0;return t+=this.padding.getHeight(),t+=this.border.getHeight(),t+=this.margin.getHeight()},t.prototype.getMeasure=function(t){var e=0;return e+=this.padding.getMeasure(t),e+=this.border.getMeasure(t),e+=this.margin.getMeasure(t)},t.prototype.getExtent=function(t){var e=0;return e+=this.padding.getExtent(t),e+=this.margin.getExtent(t),e+=this.border.getExtent(t)},t.prototype.getInnerMeasureSize=function(t){var e=0;return e+=this.padding.getMeasure(t),e+=this.border.getMeasure(t)},t.prototype.getInnerExtentSize=function(t){var e=0;return e+=this.padding.getExtent(t),e+=this.border.getExtent(t)},t.prototype.getBefore=function(t){var e=0;return e+=this.padding.getBefore(t),e+=this.border.getBefore(t),e+=this.margin.getBefore(t)},t.prototype.getAfter=function(t){var e=0;return e+=this.padding.getAfter(t),e+=this.border.getAfter(t),e+=this.margin.getAfter(t)},t.prototype.setBorderRadius=function(t,e){this.border.setRadius(t,e)},t.prototype.setBorderColor=function(t,e){this.border.setColor(t,e)},t.prototype.setBorderStyle=function(t,e){this.border.setStyle(t,e)},t.prototype.clearBefore=function(t){this.padding.clearBefore(t),this.border.clearBefore(t),this.margin.clearBefore(t)},t.prototype.clearAfter=function(t){this.padding.clearAfter(t),this.border.clearAfter(t),this.margin.clearAfter(t)},t.prototype.clearBorderStart=function(t){this.border.clearStart(t)},t.prototype.clearBorderBefore=function(t){this.border.clearBefore(t)},t.prototype.clearBorderAfter=function(t){this.border.clearAfter(t)},t}(),Nehan.BoxSize=function(){function t(t,e){this.width=t,this.height=e}return t.prototype.clone=function(){return new t(this.width,this.height)},t.prototype.setExtent=function(t,e){this[t.getPropExtent()]=e},t.prototype.setMeasure=function(t,e){this[t.getPropMeasure()]=e},t.prototype.getCss=function(t){var e={};return e.width=this.width+"px",e.height=this.height+"px",e},t.prototype.getMeasure=function(t){return this[t.getPropMeasure()]},t.prototype.getExtent=function(t){return this[t.getPropExtent()]},t}(),Nehan.BoxPosition=function(){function t(t){this.position=t}return t.prototype.isAbsolute=function(){return"absolute"===this.position},t.prototype.getCss=function(t){var e={};return e.position=this.position,this.start&&(e[t.getPropStart()]=this.start+"px"),this.end&&(e[t.getPropEnd()]=this.end+"px"),this.before&&(e[t.getPropBefore()]=this.before+"px"),this.after&&(e[t.getPropAfter()]=this.after+"px"),e},t}(),Nehan.SectionHeader=function(){function t(t,e,n){this.rank=t,this.title=e,this._id=n||0}return t.prototype.getId=function(){return this._id},t}(),Nehan.Section=function(){function t(t,e,n){this._type=t,this._header=null,this._auto=!1,this._next=null,this._child=null,this._parent=e||null,this._pageNo=n||0}return t.prototype.isRoot=function(){return null===this._parent},t.prototype.isAuto=function(){return this._auto},t.prototype.hasHeader=function(){return null!==this._header},t.prototype.hasHeaderId=function(){return this.getHeaderId()>0},t.prototype.hasChild=function(){return null!==this._child},t.prototype.hasNext=function(){return null!==this._next},t.prototype.getNext=function(){return this._next},t.prototype.getChild=function(){return this._child},t.prototype.getParent=function(){return this._parent},t.prototype.getHeader=function(){return this._header},t.prototype.getHeaderId=function(){return this._header?this._header.getId():null},t.prototype.setHeader=function(t){this._header=t},t.prototype.setAuto=function(){this._auto=!0},t.prototype.getRank=function(){return this._header?this._header.rank:0},t.prototype.getTitle=function(){return this._header?this._header.title:["untitled",this._type].join(" ")},t.prototype.getType=function(){return this._type},t.prototype.getPageNo=function(){return this._pageNo},t.prototype.updatePageNo=function(t){this._pageNo=t},t.prototype.addChild=function(t){null===this._child?this._child=t:this._child.addNext(t)},t.prototype.addNext=function(t){null===this._next?this._next=t:this._next.addNext(t)},t}(),Nehan.TocContext=function(){function t(){this.stack=[1]}return t.prototype.toString=function(){return this.stack.join(".")},t.prototype.stepNext=function(){return this.stack.length>0&&this.stack[this.stack.length-1]++,this},t.prototype.startRoot=function(){return this.stack.push(1),this},t.prototype.endRoot=function(){return this.stack.pop(),this},t}(),Nehan.OutlineContext=function(){function t(t){this.logs=[],this.markupName=t}return t.prototype.isEmpty=function(){return 0===this.logs.length},t.prototype.get=function(t){return this.logs[t]||null},t.prototype.getMarkupName=function(){return this.markupName},t.prototype.startSection=function(t){return this.logs.push({name:"start-section",type:t.type,pageNo:t.pageNo}),this},t.prototype.endSection=function(t){return this.logs.push({name:"end-section",type:t}),this},t.prototype.addHeader=function(t){return this.logs.push({name:"set-header",headerId:t.headerId,pageNo:t.pageNo,type:t.type,rank:t.rank,title:t.title}),t.headerId},t}(),Nehan.OutlineContextParser=function(){var t=function(e,n,r){var i=e.get(r++);if(null!==i){switch(i.name){case"start-section":var o=new Nehan.Section(i.type,n,i.pageNo);n&&n.addChild(o),t(e,o,r);break;case"end-section":t(e,n.getParent(),r);break;case"set-header":var s=new Nehan.SectionHeader(i.rank,i.title,i.headerId);if(null===n){var a=new Nehan.Section("section",null,i.pageNo);a.setHeader(s),t(e,a,r)}else if(n.hasHeader()){var h=i.rank,l=n.getRank();if(l>h)r=Math.max(0,r-1),t(e,n.getParent(),r);else if(i.rank==l){var u=new Nehan.Section("section",n,i.pageNo);u.setHeader(s),n.addNext(u),t(e,u,r)}else{var p=new Nehan.Section("section",n,i.pageNo);p.setHeader(s),n.addChild(p),t(e,p,r)}}else n.setHeader(s),t(e,n,r)}return n}};return{parse:function(e){var n=0,r=new Nehan.Section("section",null,0);return t(e,r,n)}}}(),Nehan.SectionTreeConverter=function(){var t={onClickLink:function(t){return!1},createToc:function(t,e){return{tocPos:t.toString(),title:e.getTitle(),pageNo:e.getPageNo(),headerId:e.getHeaderId()}},createRoot:function(t){var e=document.createElement("ul");return e.className="nehan-toc-root",e},createChild:function(t){var e=document.createElement("li");return e.className="nehan-toc-item",e},createLink:function(t){var e=document.createElement("a"),n=t.title.replace(/<a[^>]+>/gi,"").replace(/<\/a>/gi,"");return e.href="#"+t.pageNo,e.innerHTML=n,e.className="nehan-toc-link",e.id=Nehan.Css.addNehanTocLinkPrefix(t.tocId),e},createPageNoItem:function(t){return null}},e=function(t,n,r,i){if(null===r)return n;var o=i.createToc(t,r),s=i.createChild(o),a=i.createLink(o);a&&(a.onclick=function(){return i.onClickLink(o)},s.appendChild(a));var h=i.createPageNoItem(o);h&&s.appendChild(h),n.appendChild(s);var l=r.getChild();if(l){t=t.startRoot();var u=i.createToc(t,l),p=i.createRoot(u);e(t,p,l,i),s.appendChild(p),t=t.endRoot()}var c=r.getNext();return c&&e(t.stepNext(),n,c,i),n};return{convert:function(n,r){r=Nehan.Args.merge({},t,r||{});var i=new Nehan.TocContext,o=r.createRoot();return e(i,o,n,r)}}}(),Nehan.DocumentHeader=function(){function t(){this.title="",this.metas=[],this.links=[],this.scripts=[],this.styles=[]}return t.prototype.setTitle=function(t){this.title=t},t.prototype.getTitle=function(){return this.title},t.prototype.addLink=function(t){this.links.push(t)},t.prototype.getLinks=function(){return this.links},t.prototype.addMeta=function(t){this.metas.push(t)},t.prototype.getMetas=function(){return this.metas},t.prototype.getMetaByName=function(t){return Nehan.List.find(this.metas,function(e){return e.getTagAttr("name")===t})},t.prototype.getMetaContentByName=function(t){var e=this.getMetaByName(t);return e?e.getTagAttr("content"):null},t.prototype.addScript=function(t){this.scripts.push(t)},t.prototype.getScripts=function(){return this.scripts},t.prototype.addStyle=function(t){this.styles.push(t)},t.prototype.getStyles=function(){return this.styles},t}(),Nehan.Clear=function(){function t(t){this.value=t,this.status=this._createStatus(t||"both")}return t.prototype.hasDirection=function(t){return"undefined"!=typeof this.status[t]},t.prototype.setDone=function(t){this.status[t]=!0},t.prototype.isDone=function(t){return this.status[t]},t.prototype.isDoneAll=function(){return Nehan.Obj.forall(this.status,function(t,e){return e===!0})},t.prototype._createStatus=function(t){var e={};switch(t){case"start":case"end":e[t]=!1;break;case"both":e.start=e.end=!1}return e},t}(),Nehan.FloatDirection=function(){function t(t){this.value=t||"none"}return t.prototype.getCss=function(t){var e={};return t||(this.isStart()?e["css-float"]="left":this.isEnd()&&(e["css-float"]="right")),e},t.prototype.getName=function(){return this.value},t.prototype.isStart=function(){return"start"===this.value},t.prototype.isEnd=function(){return"end"===this.value},t.prototype.isNone=function(){return"none"===this.value},t}(),Nehan.FloatDirections={start:new Nehan.FloatDirection("start"),end:new Nehan.FloatDirection("end"),none:new Nehan.FloatDirection("none"),get:function(t){return this[t]||null}},Nehan.FloatGroup=function(){function t(t,e){this.elements=t||[],this.floatDirection=e||Nehan.FloatDirections.get("start"),this._last=!1}return t.prototype.hasNext=function(){return Nehan.List.exists(this.elements,function(t){return t.hasNext===!0})},t.prototype.isLast=function(){return this._last},t.prototype.setLast=function(t){this._last=t},t.prototype.add=function(t){this.elements.unshift(t)},t.prototype.isFloatStart=function(){return this.floatDirection.isStart()},t.prototype.isFloatEnd=function(){return this.floatDirection.isEnd()},t.prototype.getElements=function(){return this.isFloatStart()?this.elements:Nehan.List.reverse(this.elements)},t.prototype.getMeasure=function(t){return Nehan.List.fold(this.elements,0,function(e,n){return e+n.getLayoutMeasure(t)})},t.prototype.getExtent=function(t){return Nehan.List.fold(this.elements,0,function(e,n){return Math.max(e,n.getLayoutExtent(t))})},t.prototype.getFloatDirection=function(){return this.floatDirection},t}(),Nehan.FloatGroupStack=function(){function t(t,e,r){var i=n(t,Nehan.FloatDirections.get("start"),e),o=n(t,Nehan.FloatDirections.get("end"),r);this.stack=i.concat(o).sort(function(e,n){return e.getExtent(t)-n.getExtent(t)});var s=Nehan.List.maxobj(this.stack,function(e){return e.getExtent(t)});this.flow=t,this.lastGroup=null,this.extent=s?s.getExtent(t):0}var e=function(t,e,n){var r=n.pop()||null;if(null===r)return null;for(var i=r.getLayoutExtent(t),o=new Nehan.FloatGroup([r],e);;){var s=n.pop();if(!(s&&s.getLayoutExtent(t)<=i)){n.push(s);break}o.add(s)}return o},n=function(t,n,r){var i,o=[];do i=e(t,n,r),i&&o.unshift(i);while(null!==i);return o.length>0&&o[0].setLast(!0),o};return t.prototype.isEmpty=function(){return 0===this.stack.length},t.prototype.getExtent=function(){return this.extent},t.prototype.getLastGroup=function(){return this.lastGroup},t.prototype.pop=function(){return this.lastGroup=this.stack.pop()||null,this.lastGroup},t}(),Nehan.TextAlign=function(){function t(t){this.value=t||"start"}return t.prototype.isStart=function(){return"start"===this.value},t.prototype.isEnd=function(){return"end"===this.value},t.prototype.isCenter=function(){return"center"===this.value},t.prototype.isJustify=function(){return"justify"===this.value},t}(),Nehan.TextAligns={start:new Nehan.TextAlign("start"),end:new Nehan.TextAlign("end"),center:new Nehan.TextAlign("center"),justify:new Nehan.TextAlign("justify"),get:function(t){return this[t]||null}},Nehan.Break=function(){function t(t){this.value=t}return t.prototype.isAlways=function(){return"always"===this.value},t.prototype.isAvoid=function(){return"avoid"===this.value},t.prototype.isFirst=function(t){return t.isLeftToRight()?"left"===this.value:"right"===this.value},t.prototype.isSecond=function(t){return t.isLeftToRight()?"right"===this.value:"left"===this.value},t.prototype.isNth=function(t){},t}(),Nehan.Breaks={before:{always:new Nehan.Break("always"),avoid:new Nehan.Break("avoid"),left:new Nehan.Break("left"),right:new Nehan.Break("right"),first:new Nehan.Break("first"),second:new Nehan.Break("second")},after:{always:new Nehan.Break("always"),avoid:new Nehan.Break("avoid"),left:new Nehan.Break("left"),right:new Nehan.Break("right"),first:new Nehan.Break("first"),second:new Nehan.Break("second")},getBefore:function(t){return this.before[t]||null},getAfter:function(t){return this.after[t]||null}},Nehan.Page=function(){function t(t){Nehan.Args.merge(this,{tree:null,element:null,text:"",seekPos:0,pageNo:0,charPos:0,charCount:0,percent:0},t)}return t}(),Nehan.Flow=function(){function t(t){this.dir=t}return t.prototype.init=function(t){this.dir=t},t.prototype.isHorizontal=function(){return"lr"===this.dir||"rl"===this.dir},t.prototype.isVertical=function(){return"tb"===this.dir},t.prototype.isLeftToRight=function(){return"lr"===this.dir},t.prototype.isRightToLeft=function(){return"rl"===this.dir},t}(),Nehan.BlockFlow=function(){function t(t){Nehan.Flow.call(this,t)}return Nehan.Class.extend(t,Nehan.Flow),t.prototype.flip=function(){switch(this.dir){case"lr":case"rl":return"tb";case"tb":return Nehan.Display.getVertBlockdir();default:return""}},t.prototype.getPropBefore=function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},t.prototype.getPropAfter=function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}},t}(),Nehan.InlineFlow=function(){function t(t){Nehan.Flow.call(this,t)}return Nehan.Class.extend(t,Nehan.Flow),t.prototype.getPropStart=function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},t.prototype.getPropEnd=function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}},t}(),Nehan.BoxFlow=function(){function t(t,e){this.inflow=new Nehan.InlineFlow(t),this.blockflow=new Nehan.BlockFlow(e)}return t.prototype.isTextLineFirst=function(){return this.isTextVertical()&&this.blockflow.isLeftToRight()?!0:!1},t.prototype.isBlockflowVertical=function(){return this.blockflow.isVertical()},t.prototype.isTextVertical=function(){return this.inflow.isVertical()},t.prototype.isTextHorizontal=function(){return this.inflow.isHorizontal()},t.prototype.isTextLeftToRight=function(){return this.inflow.isLeftToRight()},t.prototype.isTextRightToLeft=function(){return this.inflow.isRightToLeft()},t.prototype.isBlockLeftToRight=function(){return this.blockflow.isLeftToRight()},t.prototype.isBlockRightToLeft=function(){return this.blockflow.isRightToLeft()},t.prototype.getCss=function(){var t={};return t["css-float"]=this.isTextVertical()?this.isBlockLeftToRight()?"left":"right":this.isTextLeftToRight()?"left":"right",t},t.prototype.getName=function(){return[this.inflow.dir,this.blockflow.dir].join("-")},t.prototype.getTextHorizontalDir=function(){return this.isTextHorizontal()?this.inflow.dir:""},t.prototype.getProp=function(t){switch(t){case"start":return this.getPropStart();case"end":return this.getPropEnd();case"before":return this.getPropBefore();case"after":return this.getPropAfter()}throw console.error("BoxFlow::getProp, undefined property(%o)",t),"BoxFlow::getProp, undefined property"},t.prototype.getPropStart=function(){return this.inflow.getPropStart()},t.prototype.getPropEnd=function(){return this.inflow.getPropEnd()},t.prototype.getPropBefore=function(){return this.blockflow.getPropBefore()},t.prototype.getPropAfter=function(){return this.blockflow.getPropAfter()},t.prototype.getPropExtent=function(){return this.isTextVertical()?"width":"height"},t.prototype.getPropMeasure=function(){return this.isTextVertical()?"height":"width"},t.prototype.getPropWidth=function(){return this.isTextVertical()?"extent":"measure"},t.prototype.getPropHeight=function(){return this.isTextVertical()?"measure":"extent"},t.prototype.getFlipFlow=function(){return this.isTextVertical()?Nehan.Display.getStdHoriFlow():Nehan.Display.getStdVertFlow()},t.prototype.getBoxSize=function(t,e){var n=new Nehan.BoxSize(0,0);return n[this.getPropMeasure()]=t,n[this.getPropExtent()]=e,n},t}(),Nehan.BoxFlows={"tb-rl":new Nehan.BoxFlow("tb","rl"),"tb-lr":new Nehan.BoxFlow("tb","lr"),"lr-tb":new Nehan.BoxFlow("lr","tb"),"rl-tb":new Nehan.BoxFlow("rl","tb"),get:function(t,e){return this.getByName([t,e].join("-"))},getByName:function(t){return this[t]||null}},Nehan.TextMetrics=function(){var t=function(){var t=document.createElement("span");return Nehan.Args.copy(t.style,{display:"inline-block",margin:0,padding:0,border:0,lineHeight:1,height:"auto",visibility:"hidden"}),t}();return{getMetrics:function(e,n){var r=document.body,i=t.style;r.style.display="block",i.font=e.toString(),t.innerHTML=n,r.appendChild(t);var o={width:t.offsetWidth,height:t.offsetHeight};return r.removeChild(t),o},getMeasure:function(t,e){var n=this.getMetrics(t,e);return n.width}}}(),Nehan.Text=function(){function t(t){this.content=t}return t.prototype.isWhiteSpaceOnly=function(){var t=this.content.replace(/ /g,"").replace(/\n/g,"").replace(/\t/g,"");return""===t},t.prototype.getContent=function(){return this.content},t}(),Nehan.Char=function(){function t(t,e){e=e||{},this.data=t,this._type="char",this.isRef=e.isRef||!1,this.isRef?this._setupRef(t):this._setupNormal(t.charCodeAt(0))}var e=["。","."],n=["、",","],r=["｢","「","『","【","［","（","《","〈","≪","＜","｛","{","[","(","❲","〔"],i=["」","｣","』","】","］","）","》","〉","≫","＞","｝","}","]",")","❳","〕"],o=["ぁ","ぃ","ぅ","ぇ","ぉ","っ","ゃ","ゅ","ょ","ゎ","ァ","ィ","ゥ","ェ","ォ","ヵ","ヶ","ッ","ャ","ュ","ョ","ヮ"],s=["）","\\",")","」","】","〕","］","\\","]","。","』","＞","〉","》","、","．","\\",".",",","”","〟"],a=["（","\\","(","「","【","［","〔","\\","[","『","＜","〈","《","“","〝"],h=["゙","゚","゛","゜","ﾞ","ﾟ"],l=/[\w!\.\?\/:#;"',]/,u=/[\uff65-\uff9f]/,p=/[\uff67-\uff6f]/,c=Nehan.Env.client.isIE();return t.prototype.getData=function(t){var e=t.isTextVertical()?this.cnv||this.data:this.data;return e+(this.ligature||"")},t.prototype.getCssPadding=function(t){var e=new Nehan.Padding;return this.paddingStart&&e.setStart(t.style.flow,this.paddingStart),this.paddingEnd&&e.setEnd(t.style.flow,this.paddingEnd),e.getCss()},t.prototype.getCssVertGlyph=function(t){var e={},n=this.isZenkaku(),r=this.isKakkoStart(),i=this.isKakkoEnd(),o=this.isTenten(),s=this.isPaddingEnable();return c&&(e.height="1em"),n&&r&&!s?(e.height="1em",e["margin-top"]="-0.5em"):n&&i&&!s?(e.height="1em",e["margin-bottom"]="-0.5em"):!r&&!i&&!o&&this.vscale<1&&(e.height="0.5em",Nehan.Args.copy(e,this.getCssPadding(t))),e},t.prototype.getCssVertImgChar=function(t){var e={},n=t.style.getFontSize();return e.display="block",e.width=n+"px",e.height=this.getVertHeight(n)+"px",this.isPaddingEnable()&&Nehan.Args.copy(e,this.getCssPadding(t)),e},t.prototype.getCssVertSingleHalfChar=function(t){var e={};return t.edge?e["padding-left"]="0.25em":e["text-align"]="center",e},t.prototype.getCssVertHalfKana=function(t){var e={};return e["text-align"]="center",this.hasLigature()?e["padding-left"]="0.25em":this.isHalfKanaSmall()&&(e["padding-left"]="0.25em",e["margin-top"]="-0.25em"),e},t.prototype.getCssVertRotateCharIE=function(t){var e={},n=t.style.getFontSize();return e["css-float"]="left",e["writing-mode"]="tb-rl",e["padding-left"]=Math.round(n/2)+"px",e["line-height"]=n+"px",e},t.prototype.getCssVertDashIE=function(t){var e={};return e.height="0.84em",e},t.prototype.getCssVertEmphaText=function(t){var e={},n=t.style.getFontSize();return e["font-size"]="0.5em",e.display="inline-block",e.width=n+"px",e.height=n+"px",e.position="absolute",e},t.prototype.getCssHoriEmphaSrc=function(t){var e={};return e["line-height"]="1em",e},t.prototype.getCssHoriEmphaText=function(t){var e={};return e.display="inline-block",e.width="1em",e.height="1em",e["padding-left"]="0.5em",e["line-height"]="1em",e["font-size"]="0.5em",e},t.prototype.getCssVertLetterSpacing=function(t){var e={};return e["margin-bottom"]=t.letterSpacing+"px",e},t.prototype.getCssHoriSpaceChar=function(t){var e={};return e.display="inline-block",e.width=this.bodySize+"px",e},t.prototype.getCssHoriTabChar=function(t){var e={};return e.display="inline-block",e.width=this.bodySize+"px",e},t.prototype.getCssVertSpaceChar=function(t){var e={};return e.height=this.bodySize+"px",e["line-height"]=this.bodySize+"px",
e},t.prototype.getCssVertTabChar=function(t){var e={};return e.height=this.bodySize+"px",e["line-height"]=this.bodySize+"px",e},t.prototype.getCssVertSmallKana=function(){var t={};return t.position="relative",t.top="-0.1em",t.right="-0.12em",t.height=this.bodySize+"px",t["line-height"]=this.bodySize+"px",t.clear="both",t},t.prototype.getHoriScale=function(){return this.hscale||1},t.prototype.getVertScale=function(){return this.vscale||1},t.prototype.getVertHeight=function(t){var e=this.getVertScale();return 1===e?t:Math.round(t*e)},t.prototype.hasMetrics=function(){return"undefined"!=typeof this.bodySize},t.prototype.getAdvance=function(t,e){return this.bodySize+this.getPaddingSize()+(e||0)},t.prototype.getPaddingSize=function(){return(this.paddingStart||0)+(this.paddingEnd||0)},t.prototype.getCharCount=function(){return" "===this.data||"	"===this.data||"　"===this.data?0:1},t.prototype.setMetrics=function(t,e){var n=t.isTextVertical(),r=n?this.getVertScale():this.getHoriScale();this.bodySize=1!=r?Math.round(e.size*r):e.size,this.spaceRateStart&&(this.paddingStart=Math.round(this.spaceRateStart*e.size)),this.spaceRateEnd&&(this.paddingEnd=Math.round(this.spaceRateEnd*e.size)),n||this.isRef||!this.isHankaku()||(this.bodySize=Math.round(e.size/2)),this.isSmallKana()&&(this.bodySize-=Math.floor(.1*e.size))},t.prototype._setImg=function(t,e,n){this.img=t,this.vscale=e,this.hscale=n},t.prototype._setCnv=function(t,e,n){this.cnv=t,this.isRef=!0,this.vscale=e,this.hscale=n},t.prototype._setRotate=function(t){this.rotate=t},t.prototype._setRotateOrImg=function(t,e,n,r){return Nehan.Env.isTransformEnable?(this._setRotate(t),this.vscale=n,void(this.hscale=r)):void this._setImg(e,n,r)},t.prototype._setupRef=function(t){switch(this.cnv=t,t){case"&nbsp;":this._setupNbsp();break;case"&thinsp;":this.vscale=this.hscale=Nehan.Display.spaceSizeRate.thinsp;break;case"&ensp;":this.vscale=this.hscale=Nehan.Display.spaceSizeRate.ensp;break;case"&emsp;":this.vscale=this.hscale=Nehan.Display.spaceSizeRate.emsp;break;case"&#09;":this._setupTabSpace();break;case"&lt;":this._setRotateOrImg(90,"kakko7",.5,.5);break;case"&gt;":this._setRotateOrImg(90,"kakko8",.5,.5)}},t.prototype._setupNbsp=function(){this.vscale=this.hscale=Nehan.Display.spaceSizeRate.nbsp},t.prototype._setupTabSpace=function(){this.vscale=this.hscale=Math.floor(Nehan.Display.tabCount/2)},t.prototype._setupNormal=function(t){switch(this.isHankaku()&&(this.hscale=.5,this._setRotate(90)),t){case 9:this._setupTabSpace();break;case 32:this._setupNbsp();break;case 12300:this._setImg("kakko1",.5,.5);break;case 65378:this._setImg("kakko1",.5,.5);break;case 12301:this._setImg("kakko2",.5,.5);break;case 65379:this._setImg("kakko2",.5,.5);break;case 12302:this._setImg("kakko3",.5,.5);break;case 12303:this._setImg("kakko4",.5,.5);break;case 65288:this._setImg("kakko5",.5,.5);break;case 40:this._setImg("kakko5",.5,.5);break;case 65371:this._setImg("kakko5",.5,.5);break;case 123:this._setImg("kakko5",.5,.5);break;case 65289:this._setImg("kakko6",.5,.5);break;case 41:this._setImg("kakko6",.5,.5);break;case 65373:this._setImg("kakko6",.5,.5);break;case 125:this._setImg("kakko6",.5,.5);break;case 65308:this._setImg("kakko7",.5,.5);break;case 12296:this._setImg("kakko7",.5,.5);break;case 65310:this._setImg("kakko8",.5,.5);break;case 12297:this._setImg("kakko8",.5,.5);break;case 12298:this._setImg("kakko9",.5,.5);break;case 8810:this._setImg("kakko9",.5,.5);break;case 12299:this._setImg("kakko10",.5,.5);break;case 8811:this._setImg("kakko10",.5,.5);break;case 65339:this._setImg("kakko11",.5,.5);break;case 12308:this._setImg("kakko11",.5,.5);break;case 91:this._setImg("kakko11",.5,.5);break;case 65341:this._setImg("kakko12",.5,.5);break;case 12309:this._setImg("kakko12",.5,.5);break;case 93:this._setImg("kakko12",.5,.5);break;case 12304:this._setImg("kakko17",.5,.5);break;case 12305:this._setImg("kakko18",.5,.5);break;case 65306:this._setImg("tenten",.5,.5);break;case 58:this._setImg("tenten",.5,.5);break;case 12290:this._setImg("kuten",.5,.5);break;case 65377:this._setImg("kuten",.5,.5);break;case 65294:this._setImg("period",1,1);break;case 46:this._setImg("period",1,1);break;case 12289:this._setImg("touten",.5,.5);break;case 65380:this._setImg("touten",.5,.5);break;case 44:this._setImg("touten",.5,.5);break;case 65292:this._setImg("touten",.5,.5);break;case 65374:this._setImg("kara",1,1);break;case 12316:this._setImg("kara",1,1);break;case 8230:this._setImg("mmm",1,1);break;case 8229:this._setImg("mm",1,1);break;case 12317:this._setImg("dmn1",1,1);break;case 12318:this._setRotate(90);break;case 12319:this._setImg("dmn2",1,1);break;case 65309:this._setImg("equal",1,1);break;case 61:this._setImg("equal",1,1);break;case 8212:c?this._setCnv("&#65372",1,1):this._setRotate(90);break;case 8213:this._setRotate(90),c||this._setCnv("&#8212;",1,1);break;case 8220:this._setRotate(90),this.hscale=this.vscale=.5;break;case 8221:this._setRotate(90),this.hscale=this.vscale=.5;break;case 12540:this._setImg("onbiki",1,1);break;case 65293:case 9472:this._setCnv("&#8212;",1,1),this._setRotate(90);break;case 8593:this._setCnv("&#8594;",1,1);break;case 8594:this._setCnv("&#8595;",1,1);break;case 8658:this._setCnv("&#8595;",1,1);break;case 8595:this._setCnv("&#8592;",1,1);break;case 8592:this._setCnv("&#8593;",1,1)}},t.prototype.setLigature=function(t){this.ligature=t},t.prototype.isNewLine=function(){return"\n"===this.data},t.prototype.isNbsp=function(){return" "===this.data||"&nbsp;"===this.cnv},t.prototype.isThinsp=function(){return"&thinsp;"===this.cnv},t.prototype.isEnsp=function(){return"&ensp;"===this.cnv},t.prototype.isEmsp=function(){return"&emsp;"===this.cnv},t.prototype.isTabSpace=function(){return"	"===this.data||"&#09;"===this.cnv},t.prototype.isSpace=function(){return this.isNbsp()||this.isTabSpace()||this.isThinsp()||this.isEnsp()||this.isEmsp()},t.prototype.isIdeographicSpace=function(){return"　"===this.data},t.prototype.isWhiteSpace=function(){return this.isNewLine()||this.isSpace()},t.prototype.isImgChar=function(){return"undefined"!=typeof this.img},t.prototype.isCnvChar=function(){return"undefined"!=typeof this.cnv},t.prototype.isRotateChar=function(){return"undefined"!=typeof this.rotate},t.prototype.isCharRef=function(){return this.isRef},t.prototype.isKerningChar=function(){return this.isZenkaku()&&(this.isKutenTouten()||this.isKakko())},t.prototype.isDash=function(){var t=this.data.charCodeAt(0);return 8212===t||8213===t},t.prototype.getImgSrc=function(t){return[Nehan.Display.fontImgRoot,this.img,t+".png"].join("/")},t.prototype.isPaddingEnable=function(){return"undefined"!=typeof this.paddingStart||"undefined"!=typeof this.paddingEnd},t.prototype.isTenten=function(){return this.img&&"tenten"===this.img},t.prototype.isHeadNg=function(){return Nehan.List.mem(s,this.data)},t.prototype.isTailNg=function(){return Nehan.List.mem(a,this.data)},t.prototype.isSmallKana=function(){return Nehan.List.mem(o,this.data)},t.prototype.isSingleHalfChar=function(){return 1===this.data.length&&l.test(this.data)},t.prototype.isKakkoStart=function(){return Nehan.List.mem(r,this.data)},t.prototype.isKakkoEnd=function(){return Nehan.List.mem(i,this.data)},t.prototype.isKakko=function(){return this.isKakkoStart()||this.isKakkoEnd()},t.prototype.isKuten=function(){return Nehan.List.mem(e,this.data)},t.prototype.isTouten=function(){return Nehan.List.mem(n,this.data)},t.prototype.isKutenTouten=function(){return this.isKuten()||this.isTouten()},t.prototype.isZenkaku=function(){return"u"===escape(this.data).charAt(1)},t.prototype.isHankaku=function(){return!this.isZenkaku(this.data)},t.prototype.isHalfKana=function(){return u.test(this.data)},t.prototype.isHalfKanaSmall=function(){return p.test(this.data)},t.prototype.isLigature=function(){return Nehan.List.mem(h,this.data)},t.prototype.hasLigature=function(){return"undefined"!=typeof this.ligature},t}(),Nehan.Word=function(){function t(t,e){this.data=t,this._type="word",this._divided=e||!1}var e=function(t,e,n){for(var r=t.data.length-1;r>=1;r--){var i=t.data.substring(0,r),o=Math.ceil(Nehan.TextMetrics.getMeasure(e,i));if(n>=o){var s=new Nehan.Word(i,!0);return s.bodySize=n,s}}return t};return t.prototype.isHeadNg=function(){return!1},t.prototype.isTailNg=function(){return!1},t.prototype.getData=function(){return this.data},t.prototype.getCssHori=function(t){var e={};return e["padding-left"]=this.paddingStart+"px",e["padding-right"]=this.paddingEnd+"px",e},t.prototype.getCssVertTrans=function(t){var e={},n=t.style.getFontSize();return t.style.letterSpacing&&(e["letter-spacing"]=t.style.letterSpacing+"px"),e.width=n+"px",e.height=this.bodySize+"px",e["padding-top"]=this.paddingStart+"px",e["padding-bottom"]=this.paddingEnd+"px",e},t.prototype.getCssVertTransBody=function(t){var e={};return e},t.prototype.getCssVertTransBodyTrident=function(t){var e={};e.width=t.style.getFontSize()+"px",e.height=this.bodySize+"px",e["transform-origin"]="50% 50%",e["line-height"]=this.bodySize+"px";var n=Math.floor((this.bodySize-t.style.getFontSize())/2);return n>0&&(e.transform="rotate(90deg) translate(-"+n+"px, 0)"),e},t.prototype.getCssVertTransIE=function(t){var e={},n=t.style.getFontSize();return e["css-float"]="left",e["writing-mode"]="tb-rl",e["letter-spacing"]=(t.style.letterSpacing||0)+"px",e["padding-left"]=Math.round(n/2)+"px",e["line-height"]=n+"px",e},t.prototype.getCharCount=function(){return 1},t.prototype.getAdvance=function(t,e){var n=(e||0)*this.getLetterCount(),r=(this.paddingStart||0)+(this.paddingEnd||0);return this.bodySize+n+r},t.prototype.hasMetrics=function(){return"undefined"!=typeof this.bodySize},t.prototype.countUpper=function(){for(var t=0,e=0;e<this.data.length;e++)/[A-Z]/.test(this.data.charAt(e))&&t++;return t},t.prototype.setMetrics=function(t,e){this.paddingStart=Math.floor(e.size*(this.spaceRateStart||0)),this.paddingEnd=Math.floor(e.size*(this.spaceRateEnd||0)),this.bodySize=Nehan.TextMetrics.getMeasure(e,this.data)},t.prototype.getLetterCount=function(){return this.data.length},t.prototype.setDivided=function(t){this._divided=t},t.prototype.isDivided=function(){return this._divided},t.prototype.cutMeasure=function(t,n,r){var i=e(this,n,r),o=this.data.slice(i.data.length);return""===o?this:(this.data=o,this.setDivided(!0),this.setMetrics(t,n),i)},t}(),Nehan.Tcy=function(){function t(t){this.data=t,this._type="tcy"}return t.prototype.isHeadNg=function(){return!1},t.prototype.isTailNg=function(){return!1},t.prototype.getData=function(){return this.data},t.prototype.getCharCount=function(){return 1},t.prototype.getAdvance=function(t,e){return this.bodySize+e},t.prototype.getCssVert=function(t){var e={};return e["text-align"]="center",e["font-family"]="monospace",e["font-weight"]="normal",e},t.prototype.getCssHori=function(t){var e={};return 1===this.data.length&&(e.display="inline-block",e.width="1em",e["text-align"]="center"),e},t.prototype.hasMetrics=function(){return"undefined"!=typeof this.bodySize},t.prototype.setMetrics=function(t,e){this.bodySize=t.isTextVertical()?e.size:this.data.length<=1?e.size:Math.floor(1.2*e.size)},t}(),Nehan.Ruby=function(){function t(t,e){this._type="ruby",this.rbs=t,this.rt=e}return t.prototype.hasMetrics=function(){return"undefined"!=typeof this.advanceSize},t.prototype.getCharCount=function(){return this.rbs?this.rbs.length:0},t.prototype.getAdvance=function(t){return this.advanceSize},t.prototype.getRbs=function(){return this.rbs},t.prototype.getRbString=function(){return Nehan.List.map(this.rbs,function(t){return t.data||""}).join("")},t.prototype.getRtString=function(){return this.rt?this.rt.getContent():""},t.prototype.getRtFontSize=function(){return this.rtFontSize},t.prototype.getCssVertRt=function(t){var e={};return e["css-float"]="left",e},t.prototype.getCssHoriRt=function(t){{var e={};Math.floor((t.style.getFontSize()-this.getRtFontSize())/3)}return e["font-size"]=this.getRtFontSize()+"px",e["line-height"]="1em",e},t.prototype.getCssVertRb=function(t){var e={};return e["css-float"]="left",this.padding&&Nehan.Args.copy(e,this.padding.getCss()),e},t.prototype.getCssHoriRb=function(t){var e={};return this.padding&&Nehan.Args.copy(e,this.padding.getCss()),e["text-align"]="center",e["line-height"]="1em",e},t.prototype.setMetrics=function(t,e,n){this.rtFontSize=Nehan.Display.getRtFontSize(e.size);var r=Nehan.List.fold(this.rbs,0,function(r,i){return i.setMetrics(t,e),r+i.getAdvance(t,n)}),i=this.rtFontSize*this.getRtString().length;if(this.advanceSize=r,i>r){var o=Math.ceil((i-r)/2);this.rbs.length>0&&(this.padding=new Nehan.Padding,this.padding.setStart(t,o),this.padding.setEnd(t,o)),this.advanceSize+=o+o}},t}(),Nehan.Token={isTag:function(t){return t instanceof Nehan.Tag},isText:function(t){return t instanceof Nehan.Text||t instanceof Nehan.Char||t instanceof Nehan.Word||t instanceof Nehan.Tcy||t instanceof Nehan.Ruby},isChar:function(t){return t instanceof Nehan.Char},isWord:function(t){return t instanceof Nehan.Word},isTcy:function(t){return t instanceof Nehan.Tcy},isEmphaTargetable:function(t){return t instanceof Nehan.Char||t instanceof Nehan.Tcy},isNewLine:function(t){return t instanceof Nehan.Char&&t.isNewLine()},isWhiteSpace:function(t){return t instanceof Nehan.Char&&t.isWhiteSpace()}},Nehan.ListStyleType=function(){function t(t){this.type=t}var e={disc:"&#x2022;",circle:"&#x25CB;",square:"&#x25A0;"};return t.prototype.isDecimalList=function(){return"decimal"===this.type||"decimal-leading-zero"===this.type},t.prototype.isNoneList=function(){return"none"===this.type},t.prototype.isMarkList=function(){return"disc"===this.type||"circle"===this.type||"square"===this.type},t.prototype.isCountableList=function(){return!this.isNoneList()&&!this.isMarkList()},t.prototype.isHankaku=function(){return"lower-alpha"===this.type||"upper-alpha"===this.type||"lower-roman"===this.type||"upper-roman"===this.type||this.isDecimalList()},t.prototype.isZenkaku=function(){return!this.isHankaku()},t.prototype._getMarkerDigitString=function(t){return"decimal"===this.type?t.toString(10):"decimal-leading-zero"===this.type?10>t?"0"+t.toString(10):t.toString(10):Nehan.Cardinal.getStringByName(this.type,t)},t.prototype.getMarkerHtml=function(t){var e=this.getMarkerText(t);return this.isZenkaku()?Nehan.Html.tagWrap("span",e,{"class":"nehan-tcy"}):e},t.prototype.getMarkerText=function(t){if(this.isNoneList())return Nehan.Const.space;if(this.isMarkList())return e[this.type]||"";var n=this._getMarkerDigitString(t);return n+"."},t}(),Nehan.ListStylePos=function(){function t(t){this.pos=t}return t.prototype.isOutside=function(){return"outside"===this.pos},t.prototype.isInside=function(){return"inside"===this.pos},t}(),Nehan.ListStyleImage=function(){function t(t){this.image=t}return t.prototype.getMarkerHtml=function(t){var e=this.image.url,n=this.image.width||Nehan.Display.fontSize,r=this.image.height||Nehan.Display.fontSize;return Nehan.Html.tagSingle("img",{src:e,"class":"nehan-list-image",width:n,height:r})},t}(),Nehan.ListStyle=function(){function t(t){this.type=new Nehan.ListStyleType(t.type||"none"),this.position=new Nehan.ListStylePos(t.position||"outside"),this.image="none"!==t.image?new Nehan.ListStyleImage(t.image):null}return t.prototype.isMultiCol=function(){return this.position.isOutside()},t.prototype.isInside=function(){return this.position.isInside()},t.prototype.isImageList=function(){return null!==this.image},t.prototype.getMarkerHtml=function(t){return null!==this.image?this.image.getMarkerHtml(t):this.type.getMarkerHtml(t)},t}(),Nehan.TextEmphaStyle=function(){function t(t){this.value=t||"none"}var e="filled dot",n={"filled dot":"&#x2022;","open dot":"&#x25e6;","filled circle":"&#x25cf;","open circle":"&#x25cb;","filled double-circle":"&#x25c9;","open double-circle":"&#x25ce;","filled triangle":"&#x25b2;","open triangle":"&#x25b3;","filled sesame":"&#xfe45;","open sesame":"&#xfe46;"};return t.prototype.isEnable=function(){return"none"!=this.value},t.prototype.setValue=function(t){this.value=t},t.prototype.getText=function(){return this.isEnable()?n[this.value]||this.value||n[e]:""},t.prototype.getCss=function(){var t={};return t},t}(),Nehan.TextEmphaPos=function(){function t(t){Nehan.Args.merge(this,{hori:"over",vert:"right"},t||{})}return t.prototype.getCss=function(t){var e={};return e},t}(),Nehan.TextEmpha=function(){function t(t){t=t||{},this.style=t.style||new Nehan.TextEmphaStyle,this.pos=t.pos||new Nehan.TextEmphaPos,this.color=t.color||new Nehan.Color(Nehan.Display.fontColor)}return t.prototype.isEnable=function(){return this.style&&this.style.isEnable()},t.prototype.getText=function(){return this.style?this.style.getText():""},t.prototype.getExtent=function(t){return 3*t},t.prototype.getCssVertEmphaWrap=function(t,e){var n={},r=t.style.getFontSize();return n["text-align"]="left",n.width=this.getExtent(r)+"px",n.height=e.getAdvance(t.style.flow,t.style.letterSpacing||0)+"px",n.position="relative",n},t.prototype.getCssHoriEmphaWrap=function(t,e){var n={},r=t.style.getFontSize();return n.display="inline-block",n.width=e.getAdvance(t.style.flow,t.style.letterSpacing)+"px",n.height=this.getExtent(r)+"px",n},t}(),Nehan.Spacing={add:function(t,e,n){t instanceof Nehan.Char?this._addCharSpacing(t,e,n):t instanceof Nehan.Word&&this._addWordSpacing(t,e,n)},_addCharSpacing:function(t,e,n){t.isKakkoStart()?this._setSpacingStart(t,e):(t.isKakkoEnd()||t.isKutenTouten())&&this._setSpacingEnd(t,n)},_addWordSpacing:function(t,e,n){e&&e instanceof Nehan.Char&&!e.isSpace()&&"undefined"==typeof e.spaceRateEnd&&(t.spaceRateStart=.25),!(n&&n instanceof Nehan.Char)||n.isSpace()||n.isKakkoStart()||n.isKutenTouten()&&n.isZenkaku()||(t.spaceRateEnd=.25)},_setSpacingStart:function(t,e){var n=this._getTextSpaceStart(t,e);n>0&&(t.spaceRateStart=n)},_setSpacingEnd:function(t,e){if(!(e instanceof Nehan.Char&&e.isTenten())){var n=this._getTextSpaceEnd(t,e);n>0&&(t.spaceRateEnd=n)}},_getTextSpaceStart:function(t,e){return null===e?.5:e instanceof Nehan.Char&&e.isKakkoStart()?0:.5},_getTextSpaceEnd:function(t,e){return null===e?.5:e instanceof Nehan.Char&&t.isKutenTouten()&&e.isKakkoStart()?0:e instanceof Nehan.Char&&(e.isKakkoEnd()||e.isKutenTouten())?0:.5}},Nehan.PartitionUnit=function(){function t(t){this.weight=t.weight||0,this.isStatic=t.isStatic||!1}return t.prototype.getSize=function(t,e){return Math.floor(t*this.weight/e)},t.prototype.mergeTo=function(t){return this.isStatic&&!t.isStatic?this:!this.isStatic&&t.isStatic?t:this.weight>t.weight?this:t},t}(),Nehan.Partition=function(){function t(t){this._punits=t||[]}var e=function(t,e){var n=Nehan.List.filter(t,function(t){return e>t});if(0===n.length)return t;var r=Nehan.List.fold(n,0,function(t,n){return t+(e-n)}),i=Nehan.List.filter(t,function(t){return t-e>=e});if(0===i.length)return t;var o=Math.floor(r/i.length);return Nehan.List.map(t,function(t){return e>t?e:t-e>=e?t-o:t})};return t.prototype.get=function(t){return this._punits[t]||null},t.prototype.getLength=function(){return this._punits.length},t.prototype.getTotalWeight=function(){return Nehan.List.fold(this._punits,0,function(t,e){return t+e.weight})},t.prototype.mergeTo=function(t){if(this.getLength()!==t.getLength())throw"Partition::mergeTo, invalid merge target(length not same)";var e=Nehan.List.map(this._punits,function(e,n){return e.mergeTo(t.get(n))});return new Nehan.Partition(e)},t.prototype.mapMeasure=function(t){var n=this.getTotalWeight(),r=Nehan.List.map(this._punits,function(e){return e.getSize(t,n)});return e(r,Nehan.Display.minTableCellSize)},t}(),Nehan.PartitionHashSet=function(){function t(){Nehan.HashSet.call(this)}return Nehan.Class.extend(t,Nehan.HashSet),t.prototype.merge=function(t,e){return t.mergeTo(e)},t.prototype.getSizes=function(t){var e=this.get(t.partitionCount);return e.mapMeasure(t.measure)},t}(),Nehan.LayoutContext=function(){function t(t,e){this.block=t,this.inline=e}return t.prototype.hasBlockSpaceFor=function(t,e){return this.block.hasSpaceFor(t,e)},t.prototype.hasBreakAfter=function(){return this.block.hasBreakAfter()||this.inline.hasBreakAfter()||!1},t.prototype.addBlockElement=function(t,e){this.block.addElement(t,e)},t.prototype.getBlockElements=function(){return this.block.getElements()},t.prototype.getBlockCurExtent=function(){return this.block.getCurExtent()},t.prototype.getBlockMaxExtent=function(){return this.block.getMaxExtent()},t.prototype.getBlockRestExtent=function(){return this.block.getRestExtent()},t.prototype.getBlockLineNo=function(){return this.block.getLineNo()},t.prototype.incBlockLineNo=function(){return this.block.incLineNo()},t.prototype.isInlineEmpty=function(){return this.inline.isEmpty()},t.prototype.isHyphenated=function(){return this.inline.isHyphenated()},t.prototype.isLineOver=function(){return this.inline.isLineOver()},t.prototype.hasInlineSpaceFor=function(t){return this.inline.hasSpaceFor(t)},t.prototype.hasLineBreak=function(){return this.inline.hasLineBreak()},t.prototype.setLineBreak=function(t){this.inline.setLineBreak(t)},t.prototype.setLineOver=function(t){this.inline.setLineOver(t)},t.prototype.setBreakAfter=function(t){this.inline.setBreakAfter(t)},t.prototype.setHyphenated=function(t){this.inline.setHyphenated(t)},t.prototype.addInlineMeasure=function(t){this.inline.addMeasure(t)},t.prototype.addInlineBoxElement=function(t,e){this.inline.addBoxElement(t,e)},t.prototype.addInlineTextElement=function(t,e){this.inline.addTextElement(t,e)},t.prototype.getInlineLastElement=function(){return this.inline.getLastElement()},t.prototype.getInlineElements=function(){return this.inline.getElements()},t.prototype.getInlineCurMeasure=function(){return this.inline.getCurMeasure()},t.prototype.getInlineRestMeasure=function(){return this.inline.getRestMeasure()},t.prototype.getInlineMaxMeasure=function(){return this.inline.getMaxMeasure()},t.prototype.getInlineMaxExtent=function(){return this.inline.getMaxExtent()},t.prototype.getInlineMaxFontSize=function(){return this.inline.getMaxFontSize()},t.prototype.getInlineCharCount=function(){return this.inline.getCharCount()},t.prototype.hyphenateSweep=function(t){return this.inline.hyphenateSweep(t)},t.prototype.hyphenateDangling=function(t,e){return this.inline.hyphenateDangling(t,e)},t}(),Nehan.BlockContext=function(){function t(t,e){e=e||{},this.curExtent=0,this.maxExtent=t,this.pushedElements=[],this.elements=[],this.pulledElements=[],this.breakAfter=!1,this.lineNo=e.lineNo||0}return t.prototype.hasSpaceFor=function(t){return this.getRestExtent()>=t},t.prototype.hasBreakAfter=function(){return this.breakAfter},t.prototype.addElement=function(t,e){this.curExtent+=e,t.breakAfter&&(this.breakAfter=!0),t.pushed?this.pushedElements.push(t):t.pulled?this.pulledElements.unshift(t):this.elements.push(t)},t.prototype.getCurExtent=function(){return this.curExtent},t.prototype.getRestExtent=function(){return this.maxExtent-this.curExtent},t.prototype.getMaxExtent=function(){return this.maxExtent},t.prototype.getLineNo=function(){return this.lineNo},t.prototype.incLineNo=function(){return this.lineNo++},t.prototype.getElements=function(){return this.pulledElements.concat(this.elements).concat(this.pushedElements)},t}(),Nehan.InlineContext=function(){function t(t){this.charCount=0,this.curMeasure=0,this.maxMeasure=t,this.maxExtent=0,this.maxFontSize=0,this.elements=[],this.lineBreak=!1,this.lineOver=!1,this.breakAfter=!1,this.hyphenated=!1}return t.prototype.isEmpty=function(){return!this.lineBreak&&!this.breakAfter&&0===this.elements.length},t.prototype.isHyphenated=function(){return this.hyphenated},t.prototype.isLineOver=function(){return this.lineOver},t.prototype.hasSpaceFor=function(t){return this.getRestMeasure()>=t},t.prototype.hasLineBreak=function(){return this.lineBreak},t.prototype.setLineBreak=function(t){this.lineBreak=t},t.prototype.setLineOver=function(t){this.lineOver=t},t.prototype.setHyphenated=function(t){this.hyphenated=t},t.prototype.hasBreakAfter=function(){return this.breakAfter},t.prototype.setBreakAfter=function(t){this.breakAfter=t},t.prototype.addMeasure=function(t){this.curMeasure+=t},t.prototype.addTextElement=function(t,e){this.elements.push(t),this.curMeasure+=e,t.getCharCount&&(this.charCount+=t.getCharCount())},t.prototype.addBoxElement=function(t,e){this.elements.push(t),this.curMeasure+=e,this.charCount+=t.charCount||0,this.maxExtent=t.maxExtent?Math.max(this.maxExtent,t.maxExtent):Math.max(this.maxExtent,t.getLayoutExtent()),t.maxFontSize&&(this.maxFontSize=Math.max(this.maxFontSize,t.maxFontSize)),t.breakAfter&&(this.breakAfter=!0),t.hyphenated&&(this.hyphenated=!0)},t.prototype.getLastElement=function(){return Nehan.List.last(this.elements)},t.prototype.getElements=function(){return this.elements},t.prototype.getCurMeasure=function(){return this.curMeasure},t.prototype.getRestMeasure=function(){return this.maxMeasure-this.curMeasure},t.prototype.getMaxMeasure=function(){return this.maxMeasure},t.prototype.getMaxExtent=function(){return this.isEmpty()?0:this.maxExtent},t.prototype.getMaxFontSize=function(){return this.maxFontSize},t.prototype.getCharCount=function(){return this.charCount},t.prototype.hyphenateSweep=function(t){var e=this.elements.length-1,n=e,r=this.elements[n]||null,i=function(t){return t&&t.isTailNg&&t.isTailNg()?!0:!1},o=function(t){return t&&t.isHeadNg&&t.isHeadNg()?!0:!1};if(!i(r)&&!o(t))return null;if(r&&r instanceof Nehan.Word&&r.isDivided())return null;for(;n>=0&&(r=this.elements[n],o(t)||i(r));)t=r,n--;return 0>n?r:n>=0&&e>n?(this.elements=Nehan.List.filter(this.elements,function(e){return e.pos?e.pos<t.pos:!0}),t):null},t.prototype.hyphenateDangling=function(t,e){return t instanceof Nehan.Char&&t.isHeadNg()?e instanceof Nehan.Char&&e.isHeadNg()?!1:!0:!1},t}(),Nehan.HtmlLexer=function(){function t(t,e){e=e||{},this.pos=0,this.flow=e.flow||null,this.buff=this._normalize(t,this.flow),this.src=this.buff}var e=/<[a-zA-Z][^>]*>/,n=function(t,e,r,i){var o=t.indexOf(i);if(0>o)return-1;var s=t.match(r),a=s?s.index:-1;if(0>a||a>o)return o;var h=a+e.length+2,l=n(t.substring(h),e,r,i);if(0>l)return-1;var u=h+l+e.length+3;return u+n(t.substring(u),e,r,i)},r=function(t){return Nehan.List.fold(Nehan.LexingRule.getSingleTagNames(),t,function(t,e){return t.replace(new RegExp("</"+e+">","g"),"")})};return t.prototype._normalize=function(t,e){return t=t.replace(/(<\/[^>]+>)/gm,function(t,e){return e.toLowerCase()}),t=r(t),t=t.replace(/\r/g,""),e&&e.isTextVertical()&&(t=t.replace(/｢/g,"「").replace(/｣/g,"」").replace(/､/g,"、").replace(/｡/g,"。")),t},t.prototype.isEmpty=function(){return""===this.src},t.prototype.get=function(){var t=this._getToken();return t&&(t.spos=this.pos),t},t.prototype.getSrc=function(){return this.src},t.prototype.getSeekPercent=function(t){return Math.round(100*t/this.src.length)},t.prototype.addText=function(t){this.buff=this.buff+this._normalize(t,this.flow)},t.prototype._stepBuff=function(t){var e=this.buff.substring(0,t);return this.pos+=t,this.buff=this.buff.slice(t),e},t.prototype._getToken=function(){if(""===this.buff)return null;var t,n;return t=this.buff.match(e),null===t?(n=this._stepBuff(this.buff.length),new Nehan.Text(n)):0===t.index?this._parseTag(t[0]):(n=this._stepBuff(t.index),n=Nehan.Utils.trimHeadCRLF(n),new Nehan.Text(n))},t.prototype._getTagContent=function(t){var e=new RegExp("<"+t+"[\\s|>]"),r="</"+t+">",i=n(this.buff,t,e,r);if(i>=0)return{closed:!0,content:this.buff.substring(0,i)};if(Nehan.Config.enableAutoCloseTag){var o=this.buff.match(e);if(o)return{closed:!1,content:this.buff.substring(0,nexd_open_match.index)}}return{closed:!1,content:this.buff}},t.prototype._parseTag=function(t){var e=new Nehan.Tag(t);this._stepBuff(t.length);var n=e.getName();return Nehan.LexingRule.isSingleTag(n)?(e._single=!0,e):this._parseChildContentTag(e)},t.prototype._parseChildContentTag=function(t){var e=this._getTagContent(t.name);return t.setContent(e.content),this._stepBuff(e.closed?e.content.length+t.name.length+3:e.content.length),t},t}(),Nehan.TextLexer=function(){function t(t){Nehan.HtmlLexer.call(this,t)}var e=/\d\d|!\?|!!|\?!|\?\?/,n=/^[a-zA-Z0-9.!?\/:$#;"',_%]+/,r=/^&[^;\s]+;/,i=/[a-zA-Z0-9!?]/;return Nehan.Class.extend(t,Nehan.HtmlLexer),t.prototype._getToken=function(){if(""===this.buff)return null;var t=this._getByRex(n);return t?1===t.length?i.test(t)?new Nehan.Tcy(this._stepBuff(1)):new Nehan.Char(this._stepBuff(1)):2===t.length&&t.match(e)?new Nehan.Tcy(this._stepBuff(t.length)):new Nehan.Word(this._stepBuff(t.length)):(t=this._getByRex(r))?new Nehan.Char(this._stepBuff(t.length),{isRef:!0}):(t=this.buff.substring(0,1),new Nehan.Char(this._stepBuff(1)))},t.prototype._getByRex=function(t){var e=this.buff.match(t);return e?e[0]:null},t}(),Nehan.TokenStream=function(){function t(t,e){e=e||{},this.flow=e.flow||null,this.lexer=e.lexer||this._createLexer(t,this.flow),this.tokens=e.tokens||[],this.pos=0,this._filter=e.filter||null,0===this.tokens.length&&this._loadTokens(this._filter)}var e=function(t){t[0].setFirstChild(!0),t[0].setOnlyChild(1===t.length),t[t.length-1].setLastChild(!0)},n=function(t){t[0].setFirstOfType(!0),t[0].setOnlyOfType(1===t.length),t[t.length-1].setLastOfType(!0)};return t.prototype.hasNext=function(){return this.pos<this.tokens.length},t.prototype.isEmptyLexer=function(){return this.lexer.isEmpty()},t.prototype.isEmptyTokens=function(){return 0===this.tokens.length},t.prototype.isHead=function(){return 0===this.pos},t.prototype.addText=function(t){""!==t&&(this.lexer.addText(t),this._loadTokens(this._filter))},t.prototype.prev=function(){this.pos=Math.max(0,this.pos-1)},t.prototype.setPos=function(t){this.pos=t},t.prototype.rewind=function(){this.pos=0},t.prototype.peek=function(t){var e=t||0,n=Math.max(0,this.pos+e),r=this.tokens[n];return r?(r.pos=n,r):null},t.prototype.get=function(){var t=this.peek();return t&&this.pos++,t},t.prototype.getSrc=function(){return this.lexer.getSrc()},t.prototype.getPos=function(){return this.pos},t.prototype.getTokenCount=function(){return this.tokens.length},t.prototype.getTokens=function(){return this.tokens},t.prototype.getSeekPos=function(){var t=this.tokens[Math.max(0,this.pos)];return t?t.spos:this.tokens[this.tokens.length-1].spos},t.prototype.getSeekPercent=function(){var t=this.getSeekPos();return this.lexer.getSeekPercent(t)},t.prototype.iterWhile=function(t){for(var e;this.hasNext();)if(e=this.get(),null===e||!t(e)){this.prev();break}},t.prototype.skipUntil=function(t){for(;this.hasNext();){var e=this.get();if(null===e)break;if(!t(e)){this.prev();break}}},t.prototype.skipIf=function(t){var e=this.peek();return e&&t(e)?this.get():null},t.prototype._loadTokens=function(t){for(var e=0;;){var n=this.lexer.get();if(null===n)break;if(n instanceof Nehan.Char&&n.isLigature()){var r=Nehan.List.last(this.tokens);if(r instanceof Nehan.Char){r.setLigature(n.data);continue}}null===t?this.tokens.push(n):t&&t(n)&&(n.order=e++,this.tokens.push(n))}this._setPseudoAttribute(this.tokens)},t.prototype._setPseudoAttribute=function(t){var r=Nehan.List.filter(t,function(t){return t instanceof Nehan.Tag});if(0!==r.length){var i={};Nehan.List.iter(r,function(t){var e=t.getName();i[e]?i[e].push(t):i[e]=[t]}),e(r);for(var o in i)n(i[o])}},t.prototype._createLexer=function(t,e){return new Nehan.HtmlLexer(t,{flow:e})},t}(),Nehan.RubyTokenStream=function(){function t(t){this.tokens=this._parse(new Nehan.TokenStream(t)),this.pos=0}return Nehan.Class.extend(t,Nehan.TokenStream),t.prototype._parse=function(t){for(var e=[];t.hasNext();)e.push(this._parseRuby(t));return e},t.prototype._parseRuby=function(t){for(var e=[],n=null;;){var r=t.get();if(null===r)break;if(Nehan.Token.isTag(r)&&"rt"===r.getName()){n=r;break}Nehan.Token.isTag(r)&&"rb"===r.getName()&&(e=this._parseRb(r.getContent())),r instanceof Nehan.Text&&(e=this._parseRb(r.getContent()))}return new Nehan.Ruby(e,n)},t.prototype._parseRb=function(t){return new Nehan.TokenStream(t,{lexer:new Nehan.TextLexer(t)}).getTokens()},t}(),Nehan.engineId=Nehan.engineId||0,Nehan.globalStyle=Nehan.globalStyle||{},Nehan.setStyle=function(t,e){
var n=Nehan.globalStyle[t]||{};for(var r in e)n[r]=e[r];Nehan.globalStyle[t]=n},Nehan.setStyles=function(t){for(var e in t)Nehan.setStyle(e,t[e])},Nehan.createEngine=Nehan.setup=function(t){"use strict";function e(){this.documentContext=s,this.selectors=i}var n=t||{};Nehan.engineId++;var r={a:{display:"inline"},abbr:{display:"inline"},address:{display:"inline","font-style":"italic",section:!0},area:{},article:{display:"block",section:!0},aside:{display:"block",section:!0},audio:{},b:{display:"inline","font-weight":"bold"},base:{},bdi:{display:"inline"},bdo:{display:"inline"},blockquote:{color:"#666666",display:"block","section-root":!0,padding:{start:"1em",end:"1em",before:"0.5em",after:"0.5em"},margin:{after:"1.5em"}},body:{display:"block","section-root":!0},br:{display:"inline"},button:{display:"inline",interactive:!0},canvas:{display:"inline",embeddable:!0},caption:{display:"table-caption","text-align":"center",margin:{after:"0.5em"}},cite:{display:"inline"},code:{"font-family":"'andale mono', 'lucida console', monospace",display:"inline"},col:{display:"table-column"},colgroup:{display:"table-column-group"},command:{},datalist:{},dd:{display:"block",margin:{start:"1em",end:"1em",after:"1.6em"}},del:{color:"#666666",display:"inline"},details:{display:"block","section-root":!0},dfn:{display:"inline","font-style":"italic"},div:{display:"block"},dl:{display:"block"},dt:{display:"block","font-weight":"bold",margin:{after:"1em"}},em:{display:"inline","font-style":"italic"},embed:{},fieldset:{display:"block","section-root":!0,padding:{start:"1em",end:"0.2em",before:"0.2em",after:"1em"},margin:{after:"1.5em"},"border-width":"1px"},figure:{display:"block","section-root":!0},figcaption:{display:"block","text-align":"center","font-size":"0.8em"},footer:{display:"block",section:!0},font:{display:"inline"},form:{display:"block"},h1:{display:"block","font-size":"2.4em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"0.5em"}},h2:{display:"block","font-size":"2.0em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"0.75em"}},h3:{display:"block","font-size":"1.6em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"1em"}},h4:{display:"block","font-size":"1.4em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"1.25em"}},h5:{display:"block","font-size":"1.0em","font-weight":"bold","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"1.5em"}},h6:{display:"block","font-weight":"bold","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace","font-size":"1.0em"},head:{display:"none"},header:{display:"block",section:!0},hr:{display:"block","box-sizing":"content-box","border-color":"#b8b8b8","border-style":"solid",margin:{after:"1em"},extent:"1px","border-width":{after:"1px"}},"hr.space":{"border-width":"0px"},html:{display:"block"},i:{display:"inline"},iframe:{display:"block",embeddable:!0},ins:{},img:{display:"inline","box-sizing":"content-box"},input:{display:"inline",interactive:!0},kbd:{display:"inline"},keygen:{},label:{display:"inline"},legend:{display:"block","font-weight":"bold","line-height":"1.5em"},li:{display:"list-item",margin:{after:"0.6em"}},link:{meta:!0},main:{display:"block"},map:{},mark:{display:"inline"},menu:{display:"block"},meta:{meta:!0},meter:{display:"inline"},nav:{display:"block",section:!0},noscript:{meta:!0},object:{display:"inline",embeddable:!0},ol:{display:"block","list-style-image":"none","list-style-position":"outside","list-style-type":"decimal",margin:{before:"1em"}},optgroup:{},option:{},output:{},p:{display:"block",margin:{after:"1em"}},param:{},pre:{display:"block","white-space":"pre"},progress:{display:"inline"},q:{display:"block"},rb:{display:"inline"},rp:{display:"inline"},ruby:{display:"inline"},rt:{"font-size":"0.5em","line-height":"1.0em",display:"inline"},s:{display:"inline"},samp:{display:"inline"},script:{display:"inline",meta:!0},section:{display:"block",section:!0},select:{},small:{display:"inline","font-size":"0.8em"},source:{},span:{display:"inline"},strong:{display:"inline","font-weight":"bold"},style:{display:"inline",meta:!0},sub:{display:"inine"},summary:{display:"inline"},sup:{display:"inine"},table:{display:"table",embeddable:!0,"table-layout":"fixed","background-color":"white","border-collapse":"collapse","border-color":"#a8a8a8","border-style":"solid","border-width":"1px",margin:{start:"0.5em",end:"0.5em",after:"1.6em"}},tbody:{display:"table-row-group","border-collapse":"inherit"},td:{display:"table-cell","section-root":!0,"border-width":"1px","border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid",padding:{start:"0.5em",end:"0.5em",before:"0.4em",after:"0.4em"}},textarea:{display:"inline",embeddable:!0,interactive:!0},tfoot:{display:"table-footer-group","border-width":"1px","border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid","font-style":"italic"},th:{display:"table-cell","line-height":"1.4em","border-width":"1px","border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid",padding:{start:"0.5em",end:"0.5em",before:"0.4em",after:"0.4em"}},thead:{display:"table-header-group","font-weight":"bold","background-color":"#c3d9ff","border-width":"1px","border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid"},time:{display:"inline"},title:{meta:!0},tr:{display:"table-row","border-collapse":"inherit","border-color":"#a8a8a8","border-width":"1px","border-style":"solid"},track:{},u:{display:"inline"},ul:{display:"block","list-style-image":"none","list-style-type":"disc","list-style-position":"outside",margin:{before:"1em"}},"var":{display:"inline"},video:{display:"inline",embeddable:!0},wbr:{display:"inline"},"?xml":{},"!doctype":{},"page-break":{display:"inline"},pbr:{display:"inline"},"end-page":{display:"inline"},".rounded":{padding:{before:"1.6em",end:"1.0em",after:"1.6em",start:"1.0em"},"border-radius":"10px"},".xx-large":{"font-size":Nehan.Display.fontSizeNames["xx-large"]},".x-large":{"font-size":Nehan.Display.fontSizeNames["x-large"]},".large":{"font-size":Nehan.Display.fontSizeNames.large},".medium":{"font-size":Nehan.Display.fontSizeNames.medium},".small":{"font-size":Nehan.Display.fontSizeNames.small},".x-small":{"font-size":Nehan.Display.fontSizeNames["x-small"]},".xx-small":{"font-size":Nehan.Display.fontSizeNames["xx-small"]},".larger":{"font-size":Nehan.Display.fontSizeNames.larger},".smaller":{"font-size":Nehan.Display.fontSizeNames.smaller},".content-box":{"box-sizing":"content-box"},".border-box":{"box-sizing":"border-box"},".margin-box":{"box-sizing":"margin-box"},".disp-none":{display:"none"},".disp-block":{display:"block"},".disp-inline":{display:"inline"},".disp-iblock":{display:"inline-block"},".ta-start":{"text-align":"start"},".ta-center":{"text-align":"center"},".ta-end":{"text-align":"end"},".ta-justify":{"text-align":"justify"},".float-start":{"float":"start"},".float-end":{"float":"end"},".clear-start":{clear:"start"},".clear-end":{clear:"end"},".clear-both":{clear:"both"},".flow-lr-tb":{flow:"lr-tb"},".flow-tb-rl":{flow:"tb-rl"},".flow-tb-lr":{flow:"tb-lr"},".flow-rl-tb":{flow:"rl-tb"},".flow-flip":{flow:"flip"},".lsp-inside":{"list-style-position":"inside"},".lsp-outside":{"list-style-position":"outside"},".lst-none":{"list-style-type":"none"},".lst-decimal":{"list-style-type":"decimal"},".lst-disc":{"list-style-type":"disc"},".lst-circle":{"list-style-type":"circle"},".lst-square":{"list-style-type":"square"},".lst-decimal-leading-zero":{"list-style-type":"decimal-leading-zero"},".lst-lower-alpha":{"list-style-type":"lower-alpha"},".lst-upper-alpha":{"list-style-type":"upper-alpha"},".lst-lower-latin":{"list-style-type":"lower-latin"},".lst-upper-latin":{"list-style-type":"upper-latin"},".lst-lower-roman":{"list-style-type":"lower-roman"},".lst-upper-roman":{"list-style-type":"upper-roman"},".lst-lower-greek":{"list-style-type":"lower-greek"},".lst-upper-greek":{"list-style-type":"upper-greek"},".lst-cjk-ideographic":{"list-style-type":"cjk-ideographic"},".lst-hiragana":{"list-style-type":"hiragana"},".lst-hiragana-iroha":{"list-style-type":"hiragana-iroha"},".lst-katakana":{"list-style-type":"katakana"},".lst-katakana-iroha":{"list-style-type":"katakana-iroha"},".tcy":{"text-combine":"horizontal"},".text-combine":{"text-combine":"horizontal"},".empha-dot-filled":{"text-emphasis-style":"filled dot"},".empha-dot-open":{"text-emphasis-style":"open dot"},".empha-circle-filled":{"text-emphasis-style":"filled circle"},".empha-circle-open":{"text-emphasis-style":"open circle"},".empha-double-circle-filled":{"text-emphasis-style":"filled double-circle"},".empha-double-circle-open":{"text-emphasis-style":"open double-circle"},".empha-triangle-filled":{"text-emphasis-style":"filled triangle"},".empha-triangle-open":{"text-emphasis-style":"open triangle"},".empha-sesame-filled":{"text-emphasis-style":"filled sesame"},".empha-sesame-open":{"text-emphasis-style":"open sesame"},".break-before":{"break-before":"always"},".break-after":{"break-after":"always"},".wb-all":{"word-break":"break-all"},".wb-normal":{"word-break":"normal"},".wb-keep":{"word-break":"keep-all"},".drop-caps::first-letter":{display:"inline-block","box-sizing":"content-box",measure:"1em",extent:"1em","float":"start","line-height":"1.0em","font-size":"4em"},".gap-start":{margin:{start:"1em"}},".gap-end":{margin:{end:"1em"}},".gap-after":{margin:{after:"1em"}},".gap-before":{margin:{before:"1em"}}},i=function(){var t=[],e=[],n=[],i={},o=function(t){return t.sort(function(t,e){return t.spec-e.spec}),t},s=function(t){return t.indexOf("::")<0&&t.indexOf(":")>=0},a=function(t){return t.indexOf("::")>=0},h=function(t,e){return Nehan.List.find(t,function(t){return t.getKey()===e})},l=function(r){return a(r)?e:s(r)?n:t},u=function(t,e){var n=new Nehan.CssHashSet(r[t]);n=n.union(new Nehan.CssHashSet(e));var i=l(t),o=h(i,t);o.updateValue(n.getValues())},p=function(t,e){var n=new Nehan.Selector(t,e),r=l(t);return r.push(n),n},c=function(t,n){var r=t.getSelectorCacheKeyPe(n),s=i[r]||null,a=s||Nehan.List.filter(e,function(e){return e.testPseudoElement(t,n)});return null===s&&(i[r]=a),0===a.length?{}:Nehan.List.fold(o(a),new Nehan.CssHashSet,function(t,e){return t.union(new Nehan.CssHashSet(e.getValue()))}).getValues()},f=function(e){var r=e.getSelectorCacheKey(),s=i[r]||null,a=s||Nehan.List.filter(t,function(t){return t.test(e)});null===s&&(i[r]=a);var h=Nehan.List.filter(n,function(t){return t.test(e)}),l=a.concat(h);return 0===l.length?{}:Nehan.List.fold(o(l),new Nehan.CssHashSet,function(t,e){return t.union(new Nehan.CssHashSet(e.getValue()))}).getValues()},g=function(t,e){if(r[t])return void u(t,e);var n=p(t,e);r[t]=n.getValue()},d=function(){Nehan.Obj.iter(r,function(t,e){p(t,e)})};return d(),{get:function(e){return h(t,e)},setValue:function(t,e){g(t,e)},setValues:function(t){for(var e in t)g(e,t[e])},getValue:function(t){return f(t)},getValuePe:function(t,e){return c(t,e)}}}(),o=function(){function t(t,e,n){this.size=t,this.style=e,this._type=n||"block",this.elements=[],this.css={}}var e=function(n){return Nehan.List.fold(n,[],function(n,r){return r instanceof t?n.concat(e(r.elements||[])):r?n.concat(r):n})};return t.prototype.addElement=function(t){t.parent=this,this.elements.push(t)},t.prototype.addElements=function(t){Nehan.List.iter(t,function(t){this.addElement(t)}.bind(this))},t.prototype.isVoid=function(){return"void"===this._type},t.prototype.isLine=function(){return"line-block"===this._type},t.prototype.isTextBlock=function(){return"text-block"===this._type},t.prototype.isRootLine=function(){return this.isRootLine||!1},t.prototype.getTextElements=function(){return e(this.elements||[])},t.prototype.toString=function(){var t=e(this.elements||[]);return Nehan.List.fold(t,"",function(t,e){var n=e instanceof Nehan.Ruby?e.getRbString():e.data||"";return t+n})},t.prototype.getId=function(){return this.id||null},t.prototype.getClassName=function(){return this.classes?Nehan.List.map(this.classes,Nehan.Css.addNehanPrefix).join(" "):""},t.prototype.getContent=function(){return this.content||null},t.prototype.getOnCreate=function(){var t=this.style.getCssAttr("oncreate")||null;return this.isTextBlock()?this.style.getCssAttr("ontext")||null:this.isLine()?this.style.getCssAttr("online")||t:this.style.getCssAttr("onblock")||t},t.prototype.getAttrs=function(){return this.isTextBlock()?null:this.style.markup.attrs},t.prototype.getBoxCss=function(){switch(this.display){case"block":return this.getCssBlock();case"inline":return this.getCssInline();case"inline-block":return this.getCssInlineBlock()}throw console.error("undefined display:",this.display),"Box::getBoxCss, undefined display"},t.prototype.getFlow=function(){return this.style.flow},t.prototype.getCssBlock=function(){return this.style.getCssBlock(this)},t.prototype.getCssInline=function(){return this.isTextBlock()?this.style.getCssTextBlock(this):this.style.getCssLineBlock(this)},t.prototype.getCssInlineBlock=function(){return this.style.getCssInlineBlock(this)},t.prototype.getCssHoriInlineImage=function(t){return this.style.getCssHoriInlineImage(t,this)},t.prototype.getContentMeasure=function(t){return t=t||this.style.flow,this.size.getMeasure(t)},t.prototype.getContentExtent=function(t){return t=t||this.style.flow,this.size.getExtent(t)},t.prototype.getContentWidth=function(){return this.size.width},t.prototype.getContentHeight=function(){return this.size.height},t.prototype.getEdgeMeasure=function(t){return t=t||this.style.flow,this.edge?this.edge.getMeasure(t):0},t.prototype.getEdgeExtent=function(t){return t=t||this.style.flow,this.edge?this.edge.getExtent(t):0},t.prototype.getLayoutMeasure=function(t){return t=t||this.style.flow,this.style.isPositionAbsolute()?0:this.getContentMeasure(t)+this.getEdgeMeasure(t)},t.prototype.getLayoutExtent=function(t){return t=t||this.style.flow,this.style.isPositionAbsolute()?0:this.getContentExtent(t)+this.getEdgeExtent(t)},t.prototype.clearBorderBefore=function(){this.edge&&this.edge.clearBorderBefore(this.style.flow)},t.prototype.clearBorderAfter=function(){this.edge&&this.edge.clearBorderAfter(this.style.flow)},t.prototype.resizeExtent=function(t,e){return this.size.setExtent(t,e),this},t}(),s=function(){var t="html",e=null,n=0,r=0,i={},o=[],s=0,a=0,h=0,l=function(t){return Nehan.List.filter(o,function(e){return e.getMarkupName()===t})},u=function(t,e){var n=Nehan.OutlineContextParser.parse(t);return n?Nehan.SectionTreeConverter.convert(n,e):null},p=function(t,e){var n=l(t);return Nehan.List.fold(n,[],function(t,n){var r=u(n,e);return r?t.concat(r):t})};return{setDocumentType:function(e){t=e},getDocumentType:function(){return t},setDocumentHeader:function(t){e=t},getDocumentHeader:function(){return e},stepCharPos:function(t){r+=t},getCharPos:function(){return r},stepPageNo:function(){n++},getPageNo:function(){return n},addOutlineContext:function(t){o.push(t)},addAnchor:function(t){i[t]=n},getAnchorPageNo:function(t){return"undefined"==typeof i[t]?null:i[t]},genHeaderId:function(){return[Nehan.engineId,s++].join("-")},genRootBlockId:function(){return h++},genBlockId:function(){return a++},createBodyOutlineElement:function(t){var e=p("body",t);return 0===e.length?null:e[0]},createOutlineElementsByName:function(t,e){return p(t,e)}}}(),a=function(){function t(){this.evaluator=this._getEvaluator()}return t.prototype._getEvaluator=function(){var t=i.get("body")||new Selector("body",{flow:Nehan.Display.flow}),e=t.getValue().flow||Nehan.Display.flow;return"tb-rl"===e||"tb-lr"===e?new R:new H},t.prototype.evaluate=function(t){return t?new Nehan.Page({tree:t,element:this.evaluator.evaluate(t),text:t.text,percent:t.percent,seekPos:t.seekPos,pageNo:t.pageNo,charPos:t.charPos,charCount:t.charCount}):null},t}(),h=function(){var t=1e3/60;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e,n){var r="undefined"==typeof n?t:n;window.setTimeout(e,r)}}(),l=function(){function t(t){this.text=this._createSource(t),this._trees=[],this._pages=[],this.generator=this._createGenerator(this.text),this.evaluator=this._createEvaluator()}return t.prototype.hasPage=function(t){return"undefined"!=typeof this._trees[t]},t.prototype.hasNext=function(){return this.generator.hasNext()},t.prototype.addText=function(t){this.generator.addText(t)},t.prototype.setTerminate=function(t){this.generator.setTerminate(t)},t.prototype.syncGet=function(t){var e=0;for(t=t||-1,this._setTimeStart();this.hasNext()&&!(t>=0&&e>=t);)if(!this.hasPage(e)){var n=this._yield();n&&(this._addTree(n),e++)}return this._getTimeElapsed()},t.prototype.asyncGet=function(t){{var e=t.wait||0,n={capturePageText:t.capturePageText||!1,maxPageCount:t.maxPageCount||-1};t.maxPageCount||-1}Nehan.Args.merge(this,{onComplete:function(t,e){},onProgress:function(t,e){},onError:function(t,e){}},t||{}),this._setTimeStart(),this._asyncGet(e,n)},t.prototype.getPageCount=function(){return this._trees.length},t.prototype.get=function(t){return this.getPage(t)},t.prototype.getPage=function(t){if(this._pages[t])return this._pages[t];var e=this._trees[t]||null;if(null===e)return null;var n=this.evaluator.evaluate(e);return this._pages[t]=n,n},t.prototype.getTree=function(t){return this._trees[t]||null},t.prototype.find=function(t){return Nehan.List.find(this._trees,t)},t.prototype.filter=function(t){return Nehan.List.filter(this._trees,t)},t.prototype._yield=function(){return this.generator["yield"]()},t.prototype._setTimeStart=function(){return this._timeStart=(new Date).getTime(),this._timeStart},t.prototype._getTimeElapsed=function(){return(new Date).getTime()-this._timeStart},t.prototype._asyncGet=function(t,e){if(!this.generator.hasNext()||e.maxPageCount>=0&&this._trees.length>=e.maxPageCount)return void this.onComplete(this._getTimeElapsed(),this);var n=this._yield();n&&(e.capturePageText&&(n.text=n.toString()),this._addTree(n),this.onProgress(n,this)),h(function(){this._asyncGet(t,e)}.bind(this))},t.prototype._addTree=function(t){this._trees.push(t)},t.prototype._createSource=function(t){return t.replace(/<!--[\s\S]*?-->/g,"").replace(/<rp>[^<]*<\/rp>/gi,"").replace(/<rb>/gi,"").replace(/<\/rb>/gi,"").replace(/<rt><\/rt>/gi,"")},t.prototype._createGenerator=function(t){switch(Nehan.Display.root){case"document":return new I(t);case"html":return new z(t);default:return new P(t)}},t.prototype._createEvaluator=function(){return new a},t}(),u=function(){function t(t,e){this._style=t,this._cursorContext=e||null}return t.prototype.getParentStyleContext=function(){return this._style.parent},t.prototype.getParentFlow=function(){var t=this.getParentStyleContext();return t?t.flow:Nehan.Display.getStdBoxFlow()},t.prototype.getMarkup=function(){return this._style.markup},t.prototype.getMarkupContent=function(){return this.getMarkup().getContent()},t.prototype.setMarkupContent=function(t){this.getMarkup().setContent(t)},t.prototype.getRestMeasure=function(){return this._cursorContext?this._cursorContext.getInlineRestMeasure():null},t.prototype.getRestExtent=function(){return this._cursorContext?this._cursorContext.getBlockRestExtent():null},t.prototype.getChildIndex=function(){return this._style.getChildIndex()},t.prototype.getChildIndexOfType=function(){return this._style.getChildIndexOfType},t.prototype.isFirstChild=function(){return this._style.isFirstChild()},t.prototype.isFirstOfType=function(){return this._style.isFirstOfType()},t.prototype.isLastChild=function(){return this._style.isLastChild()},t.prototype.isLastOfType=function(){return this._style.isLastOfType()},t.prototype.isOnlyChild=function(){return this._style.isOnlyChild()},t.prototype.isOnlyOfType=function(){return this._style.isOnlyOfType()},t.prototype.isMarkupEmpty=function(){return this._style.isMarkupEmpty()},t}(),p=function(){function t(t,e){u.call(this,t,e)}return Nehan.Class.extend(t,u),t.prototype.isTextVertical=function(){var t=this.getParentFlow(),e=this.getCssAttr("flow",t.getName()),n=Nehan.BoxFlows.getByName(e);return n&&n.isTextVertical()?!0:!1},t.prototype.isTextHorizontal=function(){return this.isTextVertical()===!1},t.prototype.getCssAttr=function(t,e){return this._style.getCssAttr(t,e)},t.prototype.setCssAttr=function(t,e){this._style.setCssAttr(t,e)},t}(),c=function(){function t(t,e,n){this._initialize(t,e,n)}var e=/(^(<[^>]+>|[\s\n])*)(\S)/im,n=["script","noscript","style","iframe","form","input","select","button","textarea"],r=["border-color","border-radius","border-style","border-width","box-sizing","break-after","break-before","clear","color","display","extent","embeddable","float","flow","font-family","font-size","font-style","font-weight","height","interactive","letter-spacing","list-style-type","list-style-position","list-style-image","margin","measure","meta","padding","position","section","section-root","text-align","text-emphasis-style","text-emphasis-position","text-emphasis-color","text-combine","width","word-break"],a=["onload","oncreate","onblock","online","ontext"],h=function(t){return Nehan.List.exists(r,Nehan.Closure.eq(t))},l=function(t){return Nehan.List.exists(a,Nehan.Closure.eq(t))};return t.prototype._initialize=function(t,e,n){n=n||{},this.markup=t,this.markupName=t.getName(),this.parent=e||null,this.childs=[],this.next=null,this.prev=null,e&&e.appendChild(this),this.selectorCacheKey=this._computeSelectorCacheKey(),this.selectorPropContext=new u(this,n.cursorContext||null),this.selectorContext=new p(this,n.cursorContext||null),this.managedCss=new Nehan.CssHashSet,this.unmanagedCss=new Nehan.CssHashSet,this.callbackCss=new Nehan.CssHashSet,this._registerCssValues(this._loadSelectorCss(t,e)),this._registerCssValues(this._loadInlineCss(t));var r=this.callbackCss.get("onload");r&&this._registerCssValues(r(this.selectorContext)||{}),this._registerCssValues(n.forceCss||{}),this.display=this._loadDisplay(),this.flow=this._loadFlow(),this.boxSizing=this._loadBoxSizing();var i=this._loadColor();i&&(this.color=i);var o=this._loadFont();o&&(this.font=o);var s=this._loadPosition();s&&(this.position=s);var a=this._loadBorderCollapse();a&&(this.borderCollapse=a);var h=this._loadEdge(this.flow,this.getFontSize());h&&(this.edge=h);var l=this._loadLineHeight();l&&(this.lineHeight=l);var c=this._loadTextAlign();c&&(this.textAlign=c);var f=this._loadTextEmpha();f&&(this.textEmpha=f);var g=this._loadTextCombine();g&&(this.textCombine=g);var d=this._loadListStyle();d&&(this.listStyle=d);var y=this._loadFloatDirection();y&&(this.floatDirection=y);var m=this._loadClear();m&&(this.clear=m);var x=this._loadBreakBefore();x&&(this.breakBefore=x);var C=this._loadBreakAfter();C&&(this.breakAfter=C);var N=this._loadWordBreak();N&&(this.wordBreak=N);var b=this._loadWhiteSpace();b&&(this.whiteSpace=b),this.staticMeasure=this._loadStaticMeasure(),this.staticExtent=this._loadStaticExtent(),this.initContextSize(this.staticMeasure,this.staticExtent),this.edge&&(this.edge.margin&&this._collapseMargin(),this.edge.border&&"collapse"===this.getBorderCollapse()&&"table"!==this.display&&this._collapseBorder(this.edge.border)),this._disableUnmanagedCssProps(this.unmanagedCss)},t.prototype.getOutlineContext=function(){return this.outlineContext||this.parent.getOutlineContext()},t.prototype.startOutlineContext=function(){this.outlineContext=new Nehan.OutlineContext(this.getMarkupName())},t.prototype.endOutlineContext=function(){s.addOutlineContext(this.getOutlineContext())},t.prototype.startSectionContext=function(){this.getOutlineContext().startSection({type:this.getMarkupName(),pageNo:s.getPageNo()})},t.prototype.endSectionContext=function(){this.getOutlineContext().endSection(this.getMarkupName())},t.prototype.startHeaderContext=function(t){return this.getOutlineContext().addHeader({headerId:s.genHeaderId(),pageNo:s.getPageNo(),type:t.type,rank:t.rank,title:t.title})},t.prototype.initContextSize=function(t,e){this.initContextMeasure(t),this.initContextExtent(e)},t.prototype.initContextMeasure=function(t){this.outerMeasure=t||(this.parent?this.parent.contentMeasure:Nehan.Display.getMeasure(this.flow)),this.contentMeasure=this._computeContentMeasure(this.outerMeasure)},t.prototype.initContextExtent=function(t){this.outerExtent=t||(this.parent?this.parent.contentExtent:Nehan.Display.getExtent(this.flow)),this.contentExtent=this._computeContentExtent(this.outerExtent)},t.prototype.updateContextSize=function(t,e){this.forceUpdateContextSize(this.staticMeasure||t,this.staticExtent||e)},t.prototype.forceUpdateContextSize=function(t,e){"li-marker"!==this.markupName&&"table"!==this.display&&(this.initContextSize(t,e),Nehan.List.iter(this.childs,function(t){t.forceUpdateContextSize(null,null)}))},t.prototype.clone=function(e){var n=this.parent?new t(this.markup,this.parent,{forceCss:e||{}}):this.createChild("div",e);return n.parent&&n.parent.removeChild(n),n.setClone(!0),n},t.prototype.appendChild=function(t){if(this.childs.length>0){var e=Nehan.List.last(this.childs);e.next=t,t.prev=e}this.childs.push(t)},t.prototype.removeChild=function(t){var e=Nehan.List.indexOf(this.childs,function(e){return e===t});if(e>=0){var n=this.childs.splice(e,1);return n}return null},t.prototype.createChild=function(e,n,r){var i=new Nehan.Tag("<"+e+">");return i.setAttrs(r||{}),new t(i,this,{forceCss:n||{}})},t.prototype.setListItemCount=function(t){var e=this.getListMarkerHtml(t),n=new y(this.clone(),new Nehan.TokenStream(e)),r=n["yield"](),i=r?r.inlineMeasure+Math.floor(this.getFontSize()/2):this.getFontSize(),o=r?r.size.getExtent(this.flow):this.getFontSize();this.listMarkerSize=this.flow.getBoxSize(i,o)},t.prototype.isClone=function(){return this._isClone||!1},t.prototype.setClone=function(t){this._isClone=t},t.prototype.createBlock=function(t){t=t||{};var e=t.elements||[],n=this.contentMeasure,r=this.contentExtent;this.parent&&t.extent&&(r=this.staticExtent||t.extent);var i=this.edge||null;!i||t.useBeforeEdge&&t.useAfterEdge||"hr"===this.markupName||(i=i.clone(),t.useBeforeEdge||i.clearBefore(this.flow),t.useAfterEdge||i.clearAfter(this.flow));var s=["nehan-block","nehan-"+this.getMarkupName()].concat(this.markup.getClasses()),a=this.flow.getBoxSize(n,r),h=new o(a,this);return this.markup.isHeaderTag()&&s.push("nehan-header"),this.isClone()&&s.push("nehan-clone"),"undefined"!=typeof t.rootBlockId&&(h.rootBlockId=t.rootBlockId),h.blockId=t.blockId,h.display="inline-block"===this.display?this.display:"block",h.edge=i,h.addElements(e),h.classes=s,h.charCount=Nehan.List.fold(e,0,function(t,e){return t+(e.charCount||0)}),h.breakAfter=this.isBreakAfter()||t.breakAfter||!1,h.content=t.content||null,h.isFirst=t.isFirst||!1,h.isLast=t.isLast||!1,h.restExtent=t.restExtent||0,h.restMeasure=t.restMeasure||0,this.isPushed()?h.pushed=!0:this.isPulled()&&(h.pulled=!0),h},t.prototype.createImage=function(t){t=t||{};var e=this.getMarkupAttr("width")?parseInt(this.getMarkupAttr("width"),10):this.staticMeasure||this.getFontSize(),n=this.getMarkupAttr("height")?parseInt(this.getMarkupAttr("height"),10):this.staticExtent||this.getFontSize(),r=["nehan-block","nehan-image"].concat(this.markup.getClasses()),i=new Nehan.BoxSize(e,n),s=new o(i,this);return s.display=this.display,s.edge=this.edge||null,s.classes=r,s.charCount=0,this.isPushed()?s.pushed=!0:this.isPulled()&&(s.pulled=!0),s.breakAfter=this.isBreakAfter()||t.breakAfter||!1,s},t.prototype.createLine=function(t){t=t||{};var e=this.isRootLine(),n=t.elements||[],r=t.maxFontSize||this.getFontSize(),i=t.maxExtent||this.staticExtent||0,s=t.charCount||0,a=t.content||null,h=this.contentMeasure;(this.parent&&t.measure&&!e||"inline-block"===this.display)&&(h=this.staticMeasure||t.measure);var l=this.flow.getBoxSize(h,i),u=["nehan-inline","nehan-inline-"+this.flow.getName()].concat(this.markup.getClasses()),p=new o(l,this,"line-block");if(p.display="inline",p.addElements(n),p.classes=e?u:u.concat("nehan-"+this.getMarkupName()),p.charCount=s,p.maxFontSize=r,p.maxExtent=i,p.content=a,p.isRootLine=e,p.hasLineBreak=t.hasLineBreak||!1,p.edge=this.edge&&!e?this.edge:null,e){p.lineNo=t.lineNo,p.breakAfter=t.breakAfter||!1,p.hyphenated=t.hyphenated||!1,p.inlineMeasure=t.measure||this.contentMeasure,this.isTextVertical()?this._setVertBaseline(p):this._setHoriBaseline(p),this.textAlign&&(this.textAlign.isCenter()||this.textAlign.isEnd())?this._setTextAlign(p,this.textAlign):this.textAlign&&this.textAlign.isJustify()&&this._setTextJustify(p);var c=Math.floor(p.maxFontSize*this.getLineHeight())-p.maxExtent;p.elements.length>0&&c>0&&(p.edge=new Nehan.BoxEdge,p.edge.padding.setBefore(this.flow,p.lineNo>0?c:Math.floor(c/2)))}return p},t.prototype.createTextBlock=function(t){t=t||{};var e=t.elements||[],n=this.getFontSize(),r=t.maxExtent||n,i=t.measure,s=t.charCount||0,a=t.content||null;t.isEmpty?r=0:this.isTextEmphaEnable()?r=this.getEmphaTextBlockExtent():"ruby"===this.markup.name&&(r=this.getRubyTextBlockExtent());var h=this.flow.getBoxSize(i,r),l=["nehan-text-block"].concat(this.markup.getClasses()),u=new o(h,this,"text-block");return u.display="inline",u.addElements(e),u.classes=l,u.charCount=s,u.maxFontSize=n,u.maxExtent=r,u.content=a,u.hasLineBreak=t.hasLineBreak||!1,u.hyphenated=t.hyphenated||!1,u.lineOver=t.lineOver||!1,u},t.prototype.isDisabled=function(){return"none"===this.display?!0:Nehan.List.exists(n,Nehan.Closure.eq(this.getMarkupName()))?!0:this.contentMeasure<=0||this.contentExtent<=0?!0:this.markup.isCloseTag()?!0:!this.markup.isSingleTag()&&this.isMarkupEmpty()&&""===this.getContent()?!0:!1},t.prototype.isBlock=function(){switch(this.display){case"block":case"table":case"table-caption":case"table-header-group":case"table-row-group":case"table-footer-group":case"table-row":case"table-cell":case"list-item":return!0}return!1},t.prototype.isRoot=function(){return null===this.parent},t.prototype.isChildBlock=function(){return this.isBlock()&&!this.isRoot()},t.prototype.isInlineBlock=function(){return"inline-block"===this.display},t.prototype.isInline=function(){return"inline"===this.display},t.prototype.isRootLine=function(){return this.isBlock()||this.isInlineBlock()},t.prototype.isFloatStart=function(){return this.floatDirection&&this.floatDirection.isStart()},t.prototype.isFloatEnd=function(){return this.floatDirection&&this.floatDirection.isEnd()},t.prototype.isFloated=function(){return this.isFloatStart()||this.isFloatEnd()},t.prototype.isPushed=function(){return null!==this.getMarkupAttr("pushed")},t.prototype.isPulled=function(){return null!==this.getMarkupAttr("pulled")},t.prototype.isPasted=function(){return null!==this.getMarkupAttr("pasted")},t.prototype.isLineBreak=function(){return"br"===this.markupName},t.prototype.isTextEmphaEnable=function(){return this.textEmpha&&this.textEmpha.isEnable()?!0:!1},t.prototype.isTextVertical=function(){return this.flow.isTextVertical()},t.prototype.isTextHorizontal=function(){return this.flow.isTextHorizontal()},t.prototype.isPositionAbsolute=function(){return this.position.isAbsolute()},t.prototype.isPre=function(){return"pre"===this.whiteSpace},t.prototype.isPageBreak=function(){switch(this.getMarkupName()){case"page-break":case"end-page":case"pbr":return!0;default:return!1}},t.prototype.isBreakBefore=function(){return this.breakBefore?!this.breakBefore.isAvoid():!1},t.prototype.isBreakAfter=function(){return this.breakAfter?!this.breakAfter.isAvoid():!1},t.prototype.isFirstLine=function(){return"first-line"===this.markupName},t.prototype.isFirstChild=function(){return this.markup.isFirstChild()},t.prototype.isFirstOfType=function(){return this.markup.isFirstOfType()},t.prototype.isLastChild=function(){return this.markup.isLastChild()},t.prototype.isLastOfType=function(){return this.markup.isLastOfType();

},t.prototype.isOnlyChild=function(){return this.markup.isOnlyChild()},t.prototype.isOnlyOfType=function(){return this.markup.isOnlyOfType()},t.prototype.isMarkupEmpty=function(){return this.markup.isEmpty()},t.prototype.isWordBreakAll=function(){return this.wordBreak&&"break-all"===this.wordBreak},t.prototype.hasFlipFlow=function(){return this.parent?this.flow!==this.parent.flow:!1},t.prototype.clearBreakBefore=function(){this.breakBefore=null},t.prototype.clearBreakAfter=function(){this.breakAfter=null},t.prototype.getAttr=function(t,e){var n=this.getMarkupAttr(t);return"undefined"!=typeof n&&null!==n?n:(n=this.getCssAttr(t),"undefined"!=typeof n&&null!==n?n:"undefined"!=typeof e?e:null)},t.prototype.getMarkupAttr=function(t,e){return"id"===t?this.markup.id:this.markup.getAttr(t,e)},t.prototype._evalCssAttr=function(t,e){return"function"==typeof e?Nehan.CssParser.formatValue(t,e(this.selectorPropContext)):Nehan.CssParser.formatValue(t,e)},t.prototype.setCssAttr=function(t,e){h(t)?this.managedCss.add(t,e):this.unmanagedCss.add(t,e)},t.prototype.getCssAttr=function(t,e){var n;return n=this.managedCss.get(t),null!==n?this._evalCssAttr(t,n):(n=this.unmanagedCss.get(t),null!==n?this._evalCssAttr(t,n):(n=this.callbackCss.get(t),null!==n?n:"undefined"!=typeof e?e:null))},t.prototype.getParentMarkupName=function(){return this.parent?this.parent.getMarkupName():null},t.prototype.getMarkup=function(){return this.markup},t.prototype.getMarkupName=function(){return this.markup.getName()},t.prototype.getMarkupId=function(){return this.markup.getId()},t.prototype.getMarkupClasses=function(){return this.markup.getClasses()},t.prototype.getMarkupContent=function(){return this.markup.getContent()},t.prototype.getMarkupPos=function(){return this.markup.pos},t.prototype.getMarkupData=function(t){return this.markup.getData(t)},t.prototype.getContent=function(){var t=this.getCssAttr("content")||this.markup.getContent(),n=i.getValuePe(this,"before");Nehan.Obj.isEmpty(n)||(t=Nehan.Html.tagWrap("before",n.content||"")+t);var r=i.getValuePe(this,"after");Nehan.Obj.isEmpty(r)||(t+=Nehan.Html.tagWrap("after",r.content||""));var o=i.getValuePe(this,"first-letter");Nehan.Obj.isEmpty(o)||(t=t.replace(e,function(t,e,n,r){return e+Nehan.Html.tagWrap("first-letter",r)}));var s=i.getValuePe(this,"first-line");return Nehan.Obj.isEmpty(s)||(t=Nehan.Html.tagWrap("first-line",t)),t},t.prototype.getHeaderRank=function(){return this.markup.getHeaderRank()},t.prototype.getSelectorCacheKey=function(){return this.selectorCacheKey},t.prototype.getSelectorCacheKeyPe=function(t){return this.selectorCacheKey+"::"+t},t.prototype.getFont=function(){return this.font||(this.parent?this.parent.getFont():Nehan.Display.getStdFont())},t.prototype.getFontSize=function(){return this.getFont().size},t.prototype.getFontFamily=function(){return this.getFont().family},t.prototype.getTextAlign=function(){return this.textAlign||Nehan.TextAligns.get("start")},t.prototype.getTextCombine=function(){return this.textCombine||null},t.prototype.getLetterSpacing=function(){return this.letterSpacing||0},t.prototype.getListMarkerHtml=function(t){return this.listStyle?this.listStyle.getMarkerHtml(t):this.parent?this.parent.getListMarkerHtml(t):""},t.prototype.getListMarkerSize=function(){if(this.listMarkerSize)return this.listMarkerSize;if(this.parent)return this.parent.getListMarkerSize();var t=this.getFontSize();return new Nehan.BoxSize(t,t)},t.prototype.getColor=function(){return this.color||(this.parent?this.parent.getColor():new Nehan.Color(Nehan.Display.fontColor))},t.prototype.getTablePartition=function(){return this.tablePartition||(this.parent?this.parent.getTablePartition():null)},t.prototype.getBorderCollapse=function(){return this.borderCollapse?"inherit"===this.borderCollapse?this.parent.getBorderCollapse():this.borderCollapse:null},t.prototype.getChildCount=function(){return this.childs.length},t.prototype.getChildIndex=function(){var t=this;return Math.max(0,Nehan.List.indexOf(this.getParentChilds(),function(e){return e===t}))},t.prototype.getChildIndexOfType=function(){var t=this;return Math.max(0,Nehan.List.indexOf(this.getParentChildsOfType(this.getMarkupName()),function(e){return e===t}))},t.prototype.getNthChild=function(t){return this.childs[t]||null},t.prototype.getParentChilds=function(){return this.parent?this.parent.childs:[]},t.prototype.getParentNthChild=function(t){return this.parent?this.parent.getNthChild(t):null},t.prototype.getParentChildsOfType=function(t){return Nehan.List.filter(this.getParentChilds(),function(e){return e.getMarkupName()===t})},t.prototype.getParentFlow=function(){return this.parent?this.parent.flow:this.flow},t.prototype.getParentFontSize=function(){return this.parent?this.parent.getFontSize():Nehan.Display.fontSize},t.prototype.getParentContentMeasure=function(){return this.parent?this.parent.contentMeasure:Nehan.Display.getMeasure(this.flow)},t.prototype.getParentContentExtent=function(){return this.parent?this.parent.contentExtent:Nehan.Display.getExtent(this.flow)},t.prototype.getNextSibling=function(){return this.next},t.prototype.getLineHeight=function(){return this.lineHeight||Nehan.Display.lineHeight||2},t.prototype.getEmphaTextBlockExtent=function(){return 2*this.getFontSize()},t.prototype.getRubyTextBlockExtent=function(){var t=this.getFontSize(),e=Math.floor(t*(1+Nehan.Display.rubyRate));return t%2===0?e:e+1},t.prototype.getAutoLineExtent=function(){return Math.floor(this.getFontSize()*this.getLineHeight())},t.prototype.getEdgeMeasure=function(t){var e=this.edge||null;return e?e.getMeasure(t||this.flow):0},t.prototype.getEdgeExtent=function(t){var e=this.edge||null;return e?e.getExtent(t||this.flow):0},t.prototype.getEdgeBefore=function(t){var e=this.edge||null;return e?e.getBefore(t||this.flow):0},t.prototype.getEdgeAfter=function(t){var e=this.edge||null;return e?e.getAfter(t||this.flow):0},t.prototype.getInnerEdgeMeasure=function(t){var e=this.edge||null;return e?e.getInnerMeasureSize(t||this.flow):0},t.prototype.getInnerEdgeExtent=function(t){var e=this.edge||null;return e?e.getInnerExtentSize(t||this.flow):0},t.prototype.getCssBlock=function(t){var e={},n=this.isTextVertical();return e.display="block",this.font&&Nehan.Args.copy(e,this.font.getCss()),this.parent&&Nehan.Args.copy(e,this.parent.flow.getCss()),this.color&&Nehan.Args.copy(e,this.color.getCss()),this.letterSpacing&&!n&&(e["letter-spacing"]=this.letterSpacing+"px"),this.floatDirection&&Nehan.Args.copy(e,this.floatDirection.getCss(n)),this.position&&Nehan.Args.copy(e,this.position.getCss()),this.zIndex&&(e["z-index"]=this.zIndex),this.unmanagedCss.copyValuesTo(e),Nehan.Args.copy(e,t.size.getCss(this.flow)),t.edge&&Nehan.Args.copy(e,t.edge.getCss()),Nehan.Args.copy(e,t.css),e},t.prototype.getCssLineBlock=function(t){var e={};return Nehan.Args.copy(e,t.size.getCss(this.flow)),t.edge&&Nehan.Args.copy(e,t.edge.getCss()),this.isRootLine()&&Nehan.Args.copy(e,this.flow.getCss()),!this.font||this.isRootLine()&&!this.isFirstLine()||Nehan.Args.copy(e,this.font.getCss()),this.color&&Nehan.Args.copy(e,this.color.getCss()),this.isRootLine()&&(e["line-height"]=this.getFontSize()+"px"),this.isTextVertical()&&(e.display="block"),this.unmanagedCss.copyValuesTo(e),Nehan.Args.copy(e,t.css),e["background-color"]=this.getCssAttr("background-color","transparent"),e},t.prototype.getCssTextBlock=function(t){var e={};if(Nehan.Args.copy(e,t.size.getCss(this.flow)),t.edge&&Nehan.Args.copy(e,t.edge.getCss()),this.isTextVertical())e.display="block",e["line-height"]="1em",Nehan.Env.client.isAppleMobileFamily()&&(e["letter-spacing"]="-0.001em");else{Nehan.Args.copy(e,this.flow.getCss()),e["line-height"]=t.maxFontSize+"px";var n=this.getCssAttr("line-height");n&&(e["line-height"]=this._computeUnitSize(n,this.getFontSize())+"px"),("ruby"===this.getMarkupName()||this.isTextEmphaEnable())&&(e.display="inline-block")}return this.unmanagedCss.copyValuesTo(e),Nehan.Args.copy(e,t.css),e["background-color"]=this.getCssAttr("background-color","transparent"),e},t.prototype.getCssInlineBlock=function(t){var e=this.getCssBlock(t);return this.isTextVertical()?this.isFloated()||delete e["css-float"]:Nehan.Args.copy(e,this.flow.getCss()),e.display="inline-block",e},t.prototype.getCssHoriInlineImage=function(t,e){return this.flow.getCss()},t.prototype._computeSelectorCacheKey=function(){var t=this.parent?[this.parent.getSelectorCacheKey()]:[];return t.push(this.markup.getKey()),t.join(">")},t.prototype._computeContentMeasure=function(t){switch(this.boxSizing){case"margin-box":return t-this.getEdgeMeasure();case"border-box":return t-this.getInnerEdgeMeasure();case"content-box":return t;default:return t}},t.prototype._computeContentExtent=function(t){switch(this.boxSizing){case"margin-box":return t-this.getEdgeExtent();case"border-box":return t-this.getInnerEdgeExtent();case"content-box":return t;default:return t}},t.prototype._computeFontSize=function(t,e){var n=String(t).replace(/\/.+$/,""),r=Nehan.Display.fontSizeNames[n]||n,i=this.getParentFontSize(),o=this._computeUnitSize(r,e,i);return Math.min(o,Nehan.Display.maxFontSize)},t.prototype._computeUnitSize=function(t,e,n){var r=String(t);if(r.indexOf("rem")>0){var i=parseFloat(r.replace("rem",""));return Math.round(Nehan.Display.fontSize*i)}if(r.indexOf("em")>0){var o=parseFloat(r.replace("em",""));return Math.round(e*o)}if(r.indexOf("pt")>0)return Math.round(4*parseInt(r,10)/3);if(r.indexOf("%")>0)return Math.round(n*parseInt(r,10)/100);var s=parseInt(r,10);return isNaN(s)?0:s},t.prototype._computeCornerSize=function(t,e){var n={};for(var r in t)n[r]=[0,0],n[r][0]=this._computeUnitSize(t[r][0],e),n[r][1]=this._computeUnitSize(t[r][1],e);return n},t.prototype._computeEdgeSize=function(t,e){var n={};for(var r in t)n[r]=this._computeUnitSize(t[r],e);return n},t.prototype._setTextJustify=function(t){var e=this.getFontSize(),n=Math.floor(e/2),r=Math.floor(n/2),i=t.getContentMeasure(this.flow),o=t.inlineMeasure,s=e*Math.floor(i/e),a=s-o,h=2*this.getFontSize(),l=this.flow,u=function(t,e){if(t){var n=t.size.getMeasure(l),r=n+e;t.size.setMeasure(l,r)}};if(!(t.hasLineBreak||a>=h||0===a)){var p=t.getTextElements();if(0!==p.length){var c=Nehan.List.filter(p,function(t){return t instanceof Nehan.Word||t instanceof Nehan.Char&&!t.isKerningChar()});if(0!==c.length){if(0>a)return void Nehan.List.iter(c,function(t){if(t instanceof Nehan.Word){var e;if(e=t.paddingEnd||0,e>0&&(a+=e,u(t.parent,-1*e),t.paddingEnd=0,a>=0))return!1;if(e=t.paddingStart||0,e>0&&(a+=e,u(t.parent,-1*e),t.paddingStart=0,a>=0))return!1}return!0});var f=Math.max(1,Math.min(r,Math.floor(a/c.length/2)));Nehan.List.iter(c,function(t){return t.paddingEnd=(t.paddingEnd||0)+f,a-=f,u(t.parent,f),0>=a?!1:t instanceof Nehan.Word&&(t.paddingStart=(t.paddingStart||0)+f,a-=f,u(t.parent,f),0>=a)?!1:!0})}}}},t.prototype._setTextAlign=function(t,e){var n=t.getContentMeasure(this.flow),r=n-t.inlineMeasure;if(!(0>=r)){var i=new Nehan.Padding;if(e.isCenter()){var o=Math.floor(r/2);t.size.setMeasure(this.flow,n-o),i.setStart(this.flow,o),Nehan.Args.copy(t.css,i.getCss())}else e.isEnd()&&(t.size.setMeasure(this.flow,t.inlineMeasure),i.setStart(this.flow,r),Nehan.Args.copy(t.css,i.getCss()))}},t.prototype._setVertBaseline=function(t,e){Nehan.List.iter(t.elements,function(e){var n=e.maxFontSize,r=Math.floor((t.maxFontSize-n)/2);if(r>0){var i=e.edge||null;i=i?i.clone():new Nehan.BoxEdge,i.padding.setAfter(this.flow,r),e.size.width=t.maxExtent-r,Nehan.Args.copy(e.css,i.getCss(this.flow))}}.bind(this))},t.prototype._setHoriBaseline=function(t,e){Nehan.List.iter(t.elements,function(e){var n=(e.maxFontSize,t.maxExtent-e.maxExtent);if(n>0){var r=e.edge||null;r=r?r.clone():new Nehan.BoxEdge,r.padding.setBefore(this.flow,n),Nehan.Args.copy(e.css,r.getCss(this.flow))}}.bind(this))},t.prototype._loadSelectorCss=function(t,e){switch(t.getName()){case"before":case"after":case"first-letter":case"first-line":var n=i.getValuePe(e,t.getName());return n;default:var r=i.getValue(this);return r}},t.prototype._loadInlineCss=function(t){var e=t.getAttr("style");if(null===e)return{};var n=e.indexOf(";")>=0?e.split(";"):[e],r=Nehan.Config.allowedInlineStyleProps||[],i=Nehan.List.fold(n,{},function(t,e){var n=e.split(":");if(n.length>=2){var i=Nehan.Utils.trim(n[0]).toLowerCase(),o=Nehan.Utils.trim(n[1]),s=Nehan.CssParser.normalizeProp(i),a=Nehan.CssParser.formatValue(i,o);(0===r.length||Nehan.List.exists(r,Nehan.Closure.eq(s)))&&(t[s]=a)}return t});return i},t.prototype._disableUnmanagedCssProps=function(t){this.isTextVertical()&&t.remove("line-height")},t.prototype._registerCssValues=function(t){Nehan.Obj.iter(t,function(t,e){var n=Nehan.CssParser.normalizeProp(t);l(n)?this.callbackCss.add(n,e):h(n)?this.managedCss.add(n,this._evalCssAttr(t,e)):this.unmanagedCss.add(n,this._evalCssAttr(t,e))}.bind(this))},t.prototype._loadDisplay=function(){switch(this.getMarkupName()){case"first-line":case"li-marker":case"li-body":return"block";default:return this.getCssAttr("display","inline")}},t.prototype._loadFlow=function(){var t=this.getCssAttr("flow","inherit"),e=this.parent?this.parent.flow:Nehan.Display.getStdBoxFlow();return"inherit"===t?e:"flip"===t?e.getFlipFlow():Nehan.BoxFlows.getByName(t)},t.prototype._loadPosition=function(){var t=this.getCssAttr("position","static");if("start"===t)return null;var e=new Nehan.BoxPosition(t),n=this;return Nehan.List.iter(Nehan.Const.cssBoxDirsLogical,function(t){var r=n.getCssAttr(t,"auto");"auto"!==r&&(e[r]=n._computeUnitSize(start,n.font.size))}),e},t.prototype._loadBorderCollapse=function(){return this.getCssAttr("border-collapse")},t.prototype._loadColor=function(){var t=this.getCssAttr("color","inherit");return"inherit"!==t?new Nehan.Color(t):null},t.prototype._loadFont=function(){var t=this.getFont(),e=this.getCssAttr("font-size","inherit"),n=this.getCssAttr("font-family","inherit"),r=this.getCssAttr("font-weight","inherit"),i=this.getCssAttr("font-style","inherit");if(this.parent&&this.parent.isBlock()&&"inherit"===e&&"inherit"===n&&"inherit"===r&&"inherit"===i)return null;var o=new Nehan.Font(t.size);return o.family=t.family,o.style=t.style,o.weight=t.weight,"inherit"!==e&&(o.size=this._computeFontSize(e,t.size)),"inherit"!==n&&(o.family=n),"inherit"!==r&&(o.weight=r),"inherit"!==i&&(o.style=i),o},t.prototype._loadBoxSizing=function(){return this.getCssAttr("box-sizing","margin-box")},t.prototype._loadEdge=function(t,e){var n=this._loadPadding(t,e),r=this._loadMargin(t,e),i=this._loadBorder(t,e);return null===n&&null===r&&null===i?null:new Nehan.BoxEdge({padding:n,margin:r,border:i})},t.prototype._loadEdgeSize=function(t,e){var n=this.getCssAttr(e);return null===n?null:this._computeEdgeSize(n,t)},t.prototype._loadPadding=function(t,e){var n=this._loadEdgeSize(e,"padding");if(null===n)return null;var r=new Nehan.Padding;return r.setSize(t,n),r},t.prototype._loadMargin=function(t,e){var n=this._loadEdgeSize(e,"margin");if(null===n)return null;var r=new Nehan.Margin;return r.setSize(t,n),this.isInline()&&(r.clearBefore(t),r.clearAfter(t)),r},t.prototype._findParentEnableBorder=function(t,e){return t.edge&&t.edge.border&&t.edge.border.getByName(this.flow,e)>0?t.edge.border:t.parent?this._findParentEnableBorder(t.parent,e):null},t.prototype._collapseBorder=function(t){switch(this.display){case"table-header-group":case"table-row-group":case"table-footer-group":case"table-row":this._collapseBorderTableRow(t);break;case"table-cell":this._collapseBorderTableCell(t)}},t.prototype._collapseBorderTableRow=function(t){var e=this._findParentEnableBorder(this.parent,"start");e&&this._collapseBorderBetween({border:e,target:"start"},{border:t,target:"start"});var n=this._findParentEnableBorder(this.parent,"end");if(n&&this._collapseBorderBetween({border:n,target:"end"},{border:t,target:"end"}),this.prev&&this.prev.edge&&this.prev.edge.border&&this._collapseBorderBetween({border:this.prev.edge.border,target:"after"},{border:t,target:"before"}),this.isFirstChild()){var r=this._findParentEnableBorder(this.parent,"before");r&&this._collapseBorderBetween({border:r,target:"before"},{border:t,target:"before"})}if(this.isLastChild()){var i=this._findParentEnableBorder(this.parent,"after");i&&this._collapseBorderBetween({border:i,target:"after"},{border:t,target:"after"})}},t.prototype._collapseBorderTableCell=function(t){this.prev&&this.prev.edge&&this.prev.edge.border&&this._collapseBorderBetween({border:this.prev.edge.border,target:"end"},{border:t,target:"start"});var e=this._findParentEnableBorder(this.parent,"before");e&&this._collapseBorderBetween({border:e,target:"before"},{border:t,target:"before"});var n=this._findParentEnableBorder(this.parent,"after");if(n&&this._collapseBorderBetween({border:n,target:"after"},{border:t,target:"after"}),this.isFirstChild()){var r=this._findParentEnableBorder(this.parent,"start");r&&this._collapseBorderBetween({border:r,target:"start"},{border:t,target:"start"})}if(this.isLastChild()){var i=this._findParentEnableBorder(this.parent,"end");i&&this._collapseBorderBetween({border:i,target:"end"},{border:t,target:"end"})}},t.prototype._collapseBorderBetween=function(t,e){var n=t.border.getByName(this.flow,t.target),r=e.border.getByName(this.flow,e.target),i=Math.max(0,r-n),o=r-i;switch(e.target){case"before":case"after":this.contentExtent+=o;break;case"start":case"end":this.contentMeasure+=o}e.border.setByName(this.flow,e.target,i)},t.prototype._collapseMargin=function(){this.parent&&this.parent.edge&&this.parent.edge.margin&&this._collapseMarginParent(),this.prev&&this.prev.isBlock()&&this.prev.edge&&this.prev.edge.margin&&this.edge.margin&&this._collapseMarginSibling()},t.prototype._collapseMarginParent=function(){this.isFirstChild()&&this._collapseMarginFirstChild(),this.isLastChild()&&this._collapseMarginLastChild()},t.prototype._collapseMarginFirstChild=function(){this.flow===this.parent.flow&&this._collapseMarginBetween({edge:this.parent.edge,target:"before"},{edge:this.edge,target:"before"})},t.prototype._collapseMarginLastChild=function(){this.flow===this.parent.flow&&this._collapseMarginBetween({edge:this.parent.edge,target:"after"},{edge:this.edge,target:"after"})},t.prototype._collapseMarginSibling=function(){this.flow===this.prev.flow?this.isFloated()&&this.prev.isFloated()?this.isFloatStart()&&this.prev.isFloatStart()?this._collapseMarginBetween({edge:this.prev.edge,target:"end"},{edge:this.edge,target:"start"}):this.isFloatEnd()&&this.prev.isFloatEnd()&&this._collapseMarginBetween({edge:this.prev.edge,target:"start"},{edge:this.edge,target:"end"}):this.isFloated()||this.prev.isFloated()||this._collapseMarginBetween({edge:this.prev.edge,target:"after"},{edge:this.edge,target:"before"}):this.prev.isTextHorizontal()&&this.isTextVertical()?this._collapseMarginBetween({edge:this.prev.edge,target:"after"},{edge:this.edge,target:"before"}):this.prev.isTextVertical()&&this.isTextHorizontal()&&(this.prev.flow.isBlockRightToLeft()?this._collapseMarginBetween({edge:this.prev.edge,target:"after"},{edge:this.edge,target:"end"}):this._collapseMarginBetween({edge:this.prev.edge,target:"after"},{edge:this.edge,target:"start"}))},t.prototype._collapseMarginBetween=function(t,e){if(!(t.edge.border&&t.edge.border.getByName(this.flow,t.target)||e.edge.border&&e.edge.border.getByName(this.flow,e.target))){var n=t.edge.margin.getByName(this.flow,t.target),r=e.edge.margin.getByName(this.flow,e.target),i=n>r?0:r-n;e.edge.margin.setByName(this.flow,e.target,i);var o=r-i;this.contentExtent+=o}},t.prototype._loadBorder=function(t,e){var n=this._loadEdgeSize(e,"border-width"),r=this.getCssAttr("border-radius");if(null===n&&null===r)return null;var i=new Nehan.Border;n&&i.setSize(t,n),r&&i.setRadius(t,this._computeCornerSize(r,e));var o=this.getCssAttr("border-color");o&&i.setColor(t,o);var s=this.getCssAttr("border-style");return s&&i.setStyle(t,s),i},t.prototype._loadLineHeight=function(){var t=this.getCssAttr("line-height","inherit");return"inherit"===t?this.parent&&this.parent.lineHeight?this.parent.lineHeight:Nehan.Display.lineHeight:parseFloat(t||Nehan.Display.lineHeight)},t.prototype._loadTextAlign=function(){var t=this.getCssAttr("text-align","inherit");return"inherit"===t&&this.parent&&this.parent.textAlign?this.parent.textAlign:Nehan.TextAligns.get(t||"start")},t.prototype._loadTextEmpha=function(){var t=this.getCssAttr("text-emphasis-style","none");if("none"===t||"inherit"===t)return null;var e=this.getCssAttr("text-emphasis-position",{hori:"over",vert:"right"}),n=this.getCssAttr("text-emphasis-color");return new Nehan.TextEmpha({style:new Nehan.TextEmphaStyle(t),pos:new Nehan.TextEmphaPos(e),color:n?new Nehan.Color(n):this.getColor()})},t.prototype._loadTextEmphaStyle=function(){var t=this.getCssAttr("text-emphasis-style","inherit");return"inherit"!==t?new TextEmphaStyle(t):null},t.prototype._loadTextEmphaPos=function(){return this.getCssAttr("text-emphasis-position",{hori:"over",vert:"right"})},t.prototype._loadTextEmphaColor=function(t){return this.getCssAttr("text-emphasis-color",t.getValue())},t.prototype._loadTextCombine=function(){return this.getCssAttr("text-combine")},t.prototype._loadFloatDirection=function(){var t=this.getCssAttr("float","none");return"none"===t?null:Nehan.FloatDirections.get(t)},t.prototype._loadClear=function(){var t=this.getCssAttr("clear");return t?new Nehan.Clear(t):null},t.prototype._loadBreakBefore=function(){var t=this.getCssAttr("break-before");return t?Nehan.Breaks.getBefore(t):null},t.prototype._loadBreakAfter=function(){var t=this.getCssAttr("break-after");return t?Nehan.Breaks.getAfter(t):null},t.prototype._loadWordBreak=function(){return this.getCssAttr("word-break")},t.prototype._loadWhiteSpace=function(){var t=this.parent?this.parent.whiteSpace:"normal";return this.getCssAttr("white-space",t)},t.prototype._loadListStyle=function(){var t=this.getCssAttr("list-style-type","none");return"none"===t?null:new Nehan.ListStyle({type:t,position:this.getCssAttr("list-style-position","outside"),image:this.getCssAttr("list-style-image","none")})},t.prototype._loadLetterSpacing=function(t){var e=this.getCssAttr("letter-spacing");return e?this._computeUnitSize(e,t):null},t.prototype._loadStaticMeasure=function(){var t=this.flow.getPropMeasure(),e=this.getParentContentMeasure(),n=this.getAttr(t)||this.getAttr("measure")||this.getCssAttr(t)||this.getCssAttr("measure");return n?this._computeUnitSize(n,this.getFontSize(),e):null},t.prototype._loadStaticExtent=function(){var t=this.flow.getPropExtent(),e=this.getParentContentExtent(),n=this.getAttr(t)||this.getAttr("extent")||this.getCssAttr(t)||this.getCssAttr("extent");return n?this._computeUnitSize(n,this.getFontSize(),e):null},t}(),f=function(){function t(t,e){this.dom=t,this.box=e}return t.prototype.getElement=function(){return this.dom},t.prototype.getRestMeasure=function(){return this.box.restMeasure||0},t.prototype.getRestExtent=function(){return this.box.resteExtent||0},t.prototype.getBox=function(){return this.box},t.prototype.getParentBox=function(){return this.box.parent},t.prototype.getBoxSize=function(){return this.box.size},t.prototype.getParentBoxSize=function(){return this.box.parent.size},t.prototype.getStyleContext=function(){return this.box.style},t.prototype.getParentStyleContext=function(){return this.box.style.parent},t.prototype.getMarkup=function(){return this.getStyleContext().getMarkup()},t.prototype.getParentMarkup=function(){return this.getParentStyleContext().getMarkup()},t.prototype.getChildCount=function(){return this.getStyleContext().getChildCount()},t.prototype.getParentChildCount=function(){return this.getParentStyleContext().getChildCount()},t.prototype.getChildIndex=function(){return this.getStyleContext().getChildIndex()},t.prototype.getChildIndexOfType=function(){return this.getStyleContext().getChildIndexOfType()},t.prototype.isTextVertical=function(){return this.getStyleContext().isTextVertical()},t.prototype.isTextHorizontal=function(){return this.getStyleContext().isTextHorizontal()},t.prototype.isMarkupEmpty=function(){return this.getStyleContext().isMarkupEmpty()},t.prototype.isFirstChild=function(){return this.getStyleContext().isFirstChild()},t.prototype.isFirstOfType=function(){return this.getStyleContext().isFirstChild()},t.prototype.isOnlyChild=function(){return this.getStyleContext().isFirstOfType()},t.prototype.isOnlyOfType=function(){return this.getStyleContext().isOnlyOfType()},t.prototype.isLastChild=function(){return this.getStyleContext().isLastChild()},t.prototype.isLastOfType=function(){return this.getStyleContext().isLastOfType()},t}(),g=function(){function t(t,e){this.style=t,this.stream=e,this._parent=null,this._child=null,this._cachedElements=[],this._terminate=!1,this._yieldCount=0}return t.prototype["yield"]=function(t){var e=t?this._createChildContext(t):this._createStartContext(),n=this._yield(e);if(null!==n&&this._yieldCount++,this._yieldCount>Nehan.Config.maxYieldCount)throw console.error("[%s]too many yield! gen:%o, context:%o, stream:%o",this.style.markupName,this,e,this.stream),"too many yield";return n},t.prototype._yield=function(t){throw"LayoutGenerator::_yield must be implemented in child class"},t.prototype.setTerminate=function(t){this._terminate=t},t.prototype.setChildLayout=function(t){this._child=t,t._parent=this},t.prototype.hasNext=function(){return this._terminate?!1:this.hasCache()?!0:this.hasChildLayout()?!0:this.stream?this.stream.hasNext():!1},t.prototype.hasChildLayout=function(){return this._child&&this._child.hasNext()?!0:!1},t.prototype.hasCache=function(){return this._cachedElements.length>0},t.prototype.isFirstOutput=function(){return 0===this._yieldCount},t.prototype.yieldChildLayout=function(t){var e=this._child["yield"](t);return e},t.prototype.peekLastCache=function(){return Nehan.List.last(this._cachedElements)},t.prototype.pushCache=function(t){var e=t.cacheCount||0;if(e>0&&e>=Nehan.Config.maxRollbackCount){var n=t instanceof o?t.toString():t.data||"??";return console.warn("[%s] too many retry:%o, element:%o(%s)",this.style.getMarkupName(),this.style,t,n),void(this._child&&this._child.hasNext()?this._child.setTerminate(!0):this.setTerminate(!0))}t.cacheCount=e+1,this._cachedElements.push(t)},t.prototype.popCache=function(){var t=this._cachedElements.pop();return t},t.prototype.clearCache=function(){this._cachedElements=[]},t.prototype.addText=function(t){this.stream&&this.stream.addText(t)},t.prototype._onAddElement=function(t,e){},t.prototype._onCreate=function(t,e){},t.prototype._onComplete=function(t,e){},t.prototype._createStartContext=function(){var t=this._getContextEdgeSize(),e=new Nehan.LayoutContext(new Nehan.BlockContext(this.style.outerExtent-t),new Nehan.InlineContext(this.style.contentMeasure));return e},t.prototype._createChildContext=function(t){var e=this._getContextEdgeSize(),n=t.getBlockRestExtent()-e,r=new Nehan.LayoutContext(new Nehan.BlockContext(n,{lineNo:t.lineNo}),new Nehan.InlineContext(this.style.contentMeasure));return r},t.prototype._getContextEdgeSize=function(t){return this.isFirstOutput()?this.style.getEdgeBefore():0},t.prototype._createStream=function(t){var e=t.getMarkupName(),n=t.getMarkupContent();if("horizontal"===t.getTextCombine()||"tcy"===e)return new Nehan.TokenStream(n,{flow:t.flow,tokens:[new Nehan.Tcy(n)]});switch(e){case"word":return new Nehan.TokenStream(n,{flow:t.flow,tokens:[new Nehan.Word(n)]});case"ruby":return new Nehan.RubyTokenStream(n);case"tbody":case"thead":case"tfoot":return new Nehan.TokenStream(t.getContent(),{flow:t.flow,filter:Nehan.Closure.isTagName(["tr"])});case"tr":return new Nehan.TokenStream(t.getContent(),{flow:t.flow,filter:Nehan.Closure.isTagName(["td","th"])});default:return new Nehan.TokenStream(t.getContent(),{flow:t.flow})}},t.prototype._createFloatGenerator=function(t,e){{var n=this,r=this.style,i=[e];this.stream.iterWhile(function(e){if(e instanceof Nehan.Text&&e.isWhiteSpaceOnly())return!0;if(!Nehan.Token.isTag(e))return!1;var o=new c(e,r,{cursorContext:t});if(!o.isFloated())return r.removeChild(o),!1;var s=n._createStream(o),a=n._createChildBlockGenerator(o,s,t);return i.push(a),!0})}return new v(this.style,this.stream,i)},t.prototype._createChildBlockGenerator=function(t,e,n){if(t.isPasted())return new b(t,t.createBlock({content:t.getContent()}));if(t.hasFlipFlow())return new k(t,e,n);switch(t.display){case"list-item":return new T(t,e);case"table":return new B(t,e);case"table-row":return new L(t,e);case"table-cell":return new M(t,e)}switch(t.getMarkupName()){case"img":return new b(t,t.createImage());case"hr":return new b(t,t.createBlock());case"first-line":return new N(t,e);case"details":case"blockquote":case"figure":case"fieldset":return new w(t,e);case"section":case"article":case"nav":case"aside":return new S(t,e);case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":return new A(t,e);case"ul":case"ol":return new E(t,e);default:return new d(t,e)}},t.prototype._createTextGenerator=function(t,e){if(e instanceof Nehan.Tcy||e instanceof Nehan.Word)return new x(this.style,new Nehan.TokenStream(e.getData(),{flow:t.flow,tokens:[e]}));var n=e.getContent();return new x(this.style,new Nehan.TokenStream(n,{flow:t.flow,lexer:new Nehan.TextLexer(n)}))},t.prototype._createChildInlineGenerator=function(t,e,n){if(t.isPasted())return new b(t,t.createLine({content:t.getContent()}));if(t.isInlineBlock())return new m(t,e);switch(t.getMarkupName()){case"ruby":return new x(t,e);case"img":return new b(t,t.createImage());case"a":return new C(t,e);default:return new y(t,e)}},t}(),d=function(){function t(t,e){g.call(this,t,e),"body"===this.style.getParentMarkupName()&&(this.rootBlockId=s.genRootBlockId()),this.blockId=s.genBlockId()}return Nehan.Class.extend(t,g),t.prototype._yield=function(t){if(!t.hasBlockSpaceFor(1,!this.hasNext()))return null;var e=this.style.clear;if(e&&!e.isDoneAll()&&this._parent&&this._parent.floatGroup){var n=this._parent.floatGroup,r=n.getFloatDirection();if(n.isLast()&&!n.hasNext()&&e.hasDirection(r.getName()))return e.setDone(r.getName()),this._createWhiteSpace(t);if(!e.isDoneAll())return this._createWhiteSpace(t)}if(this.style.isBreakBefore())return this.style.clearBreakBefore(),null;for(;;){if(!this.hasNext())return this._createOutput(t);var i=this._getNext(t);if(null===i)return this._createOutput(t);if(!i.isVoid()){var o=i.getLayoutExtent(this.style.flow);if(!t.hasBlockSpaceFor(o))return this.pushCache(i),this._createOutput(t);if(this._addElement(t,i,o),!t.hasBlockSpaceFor(1)||t.hasBreakAfter())return this._createOutput(t)}}},t.prototype.popCache=function(t){var e=g.prototype.popCache.call(this);if(e&&e.isLine()&&(0===t.getBlockLineNo()&&(e.lineNo=0,t.incBlockLineNo()),(!e.hasLineBreak||e.hasLineBreak&&e.hyphenated)&&e.getLayoutMeasure(this.style.flow)<this.style.contentMeasure&&this._child)){var n=this._createChildContext(t);n.inline.elements=e.elements,n.inline.curMeasure=e.getLayoutMeasure(this.style.flow),n.inline.maxFontSize=e.maxFontSize||this.style.getFontSize(),n.inline.maxExtent=e.maxExtent||0,n.inline.charCount=e.charCount||0;var r=this._child._yield(n);return r}return e},t.prototype._getNext=function(t){if(this.hasCache()){var e=this.popCache(t);return e}if(this.hasChildLayout()){var n=this.yieldChildLayout(t);return n}var r=this.stream?this.stream.get():null;if(null===r)return null;if(r instanceof Nehan.Text){if(r.isWhiteSpaceOnly())return this._getNext(t);var i=this._createTextGenerator(this.style,r);return this.setChildLayout(new y(this.style,this.stream,i)),this.yieldChildLayout(t)}var o=new c(r,this.style,{cursorContext:t});if(o.isDisabled())return this._getNext(t);if(o.isPageBreak())return t.setBreakAfter(!0),null;if(o.isLineBreak())return this.style.createLine({maxExtent:this.style.getFontSize()});var s=this._createStream(o);if(o.isFloated()){var a=this._createChildBlockGenerator(o,s,t);return this.setChildLayout(this._createFloatGenerator(t,a)),this.yieldChildLayout(t)}if(o.isInline()||o.isInlineBlock()){var h=this._createChildInlineGenerator(o,s,t);return this.setChildLayout(new y(this.style,this.stream,h)),
this.yieldChildLayout(t)}return this.setChildLayout(this._createChildBlockGenerator(o,s,t)),this.yieldChildLayout(t)},t.prototype._addElement=function(t,e,n){t.addBlockElement(e,n),this._onAddElement(t,e)},t.prototype._createWhiteSpace=function(t){return this.style.createBlock({extent:t.getBlockMaxExtent(),elements:[],useBeforeEdge:!1,useAfterEdge:!1,restMeasure:0,resetExtent:0})},t.prototype._createOutput=function(t){var e=t.getBlockCurExtent(),n=t.getBlockElements();if(0===e||0===n.length)return!this.hasCache()&&this.isFirstOutput()?new o(new Nehan.BoxSize(1,1),this.style,"void"):null;var r=this.style.getEdgeAfter(),i={blockId:this.blockId,extent:e,elements:n,breakAfter:t.hasBreakAfter(),useBeforeEdge:this.isFirstOutput(),useAfterEdge:!this.hasNext()&&r<=t.getBlockRestExtent(),restMeasure:t.getInlineRestMeasure(),restExtent:t.getBlockRestExtent()};"undefined"!=typeof this.rootBlockId&&(i.rootBlockId=this.rootBlockId);var s=this.style.createBlock(i);return this._onCreate(t,s),this.hasNext()||this._onComplete(t,s),s},t}(),y=function(){function t(t,e,n){g.call(this,t,e),n&&this.setChildLayout(n)}return Nehan.Class.extend(t,g),t.prototype._yield=function(t){if(!t.hasInlineSpaceFor(1))return null;for(;this.hasNext();){var e=this._getNext(t);if(null===e)break;var n=this._getMeasure(e);if(0===n)break;if(!t.hasInlineSpaceFor(n)){this.pushCache(e);break}if(this._addElement(t,e,n),e.hasLineBreak){t.setLineBreak(!0);break}}return e&&e.lineOver&&this._child&&!this._child.hasNext()&&this.stream.skipIf(function(t){return t instanceof Nehan.Tag&&"br"===t.getName()}),this._createOutput(t)},t.prototype._createChildContext=function(t){var e=new Nehan.LayoutContext(t.block,new Nehan.InlineContext(t.getInlineRestMeasure()));return e},t.prototype._createOutput=function(t){if(t.isInlineEmpty())return null;var e=this.style.createLine({lineNo:t.getBlockLineNo(),hasLineBreak:t.hasLineBreak(),breakAfter:t.hasBreakAfter(),hyphenated:t.isHyphenated(),measure:t.getInlineCurMeasure(),elements:t.getInlineElements(),charCount:t.getInlineCharCount(),maxExtent:t.getInlineMaxExtent()||this.style.getFontSize(),maxFontSize:t.getInlineMaxFontSize()});return this._parent&&this._parent.stream&&(e.pos=Math.max(0,this._parent.stream.getPos()-1)),this.style.isRootLine()&&t.incBlockLineNo(),this._onCreate(t,e),this.hasNext()||this._onComplete(t,e),e},t.prototype._getNext=function(t){if(this.hasCache()){var e=this.popCache(t);return e}if(this.hasChildLayout())return this.yieldChildLayout(t);var n=this.stream.get();if(null===n)return null;if(n instanceof Nehan.Text||n instanceof Nehan.Tcy||n instanceof Nehan.Word)return this.setChildLayout(this._createTextGenerator(this.style,n)),this.yieldChildLayout(t);var r=new c(n,this.style,{cursorContext:t});if(r.isDisabled())return this._getNext(t);var i=this._createStream(r);if(r.isBlock()||r.isFloated()){var o=this._createChildBlockGenerator(r,i,t);return r.isFloated()&&(o=this._createFloatGenerator(t,o)),this._breakInline(o),t.setLineBreak(!0),null}switch(r.getMarkupName()){case"img":return r.createImage();case"br":return t.setLineBreak(!0),this.style.isPre()||this.stream.skipUntil(function(t){return t instanceof Nehan.Text&&t.isWhiteSpaceOnly()}),null;case"page-break":case"pbr":case"end-page":return t.setBreakAfter(!0),null;default:var s=this._createChildInlineGenerator(r,i,t);return this.setChildLayout(s),this.yieldChildLayout(t)}},t.prototype._breakInline=function(e){this.setTerminate(!0),null!==this._parent&&(this._parent instanceof t?this._parent._breakInline(e):this._parent.setChildLayout(e))},t.prototype._getMeasure=function(t){return t.getLayoutMeasure(this.style.flow)},t.prototype._addElement=function(t,e,n){t.addInlineBoxElement(e,n),this._onAddElement(t,e)},t}(),m=function(){function t(t,e){d.call(this,t,e)}return Nehan.Class.extend(t,d),t.prototype._onCreate=function(t,e){var n=Nehan.List.maxobj(e.elements,function(t){return t.getContentMeasure()});return n&&e.size.setMeasure(this.style.flow,n.getContentMeasure()),e},t.prototype._createChildContext=function(t){return new Nehan.LayoutContext(new Nehan.BlockContext(t.getBlockRestExtent()-this.style.getEdgeExtent()),new Nehan.InlineContext(t.getInlineRestMeasure()-this.style.getEdgeMeasure()))},t}(),x=function(){function t(t,e){g.call(this,t,e)}Nehan.Class.extend(t,g);return t.prototype._yield=function(t){if(!t.hasInlineSpaceFor(1))return null;for(var e=Nehan.Config.hyphenate?this._peekParentNextToken():null,n=e?this._peekParentNextHeadChar(e):null,r=e?this._estimateParentNextHeadMeasure(e):this.style.getFontSize(),i=n?n.isHeadNg():!1,o=this.style.contentMeasure===t.getInlineMaxMeasure();this.hasNext();){var s=this._getNext(t);if(null===s)break;var a=this._getMeasure(s);if(0===a)break;if(o&&0===t.getInlineCurMeasure()&&s instanceof Nehan.Char&&s.isWhiteSpace()&&!this.style.isPre()){var h=this.stream.peek();if(h&&h instanceof Nehan.Word)continue}if(Nehan.Config.hyphenate&&!this.stream.hasNext()&&!t.hasInlineSpaceFor(a+r)&&(s instanceof Nehan.Char&&s.isTailNg()||i)){t.setLineBreak(!0),t.setHyphenated(!0),this.pushCache(s);break}if(!t.hasInlineSpaceFor(a)){this.pushCache(s),t.setLineOver(!0);break}if(this._addElement(t,s,a),!t.hasInlineSpaceFor(1)){t.setLineOver(!0);break}}return this._createOutput(t)},t.prototype._createChildContext=function(t){return new Nehan.LayoutContext(t.block,new Nehan.InlineContext(t.getInlineRestMeasure()))},t.prototype._createOutput=function(t){if(t.isInlineEmpty())return null;!Nehan.Config.hyphenate||t.isInlineEmpty()||t.hasLineBreak()||this._hyphenateLine(t);var e=this.style.createTextBlock({hasLineBreak:t.hasLineBreak(),lineOver:t.isLineOver(),breakAfter:t.hasBreakAfter(),hyphenated:t.isHyphenated(),measure:t.getInlineCurMeasure(),elements:t.getInlineElements(),charCount:t.getInlineCharCount(),maxExtent:t.getInlineMaxExtent(),maxFontSize:t.getInlineMaxFontSize(),isEmpty:t.isInlineEmpty()});return this._parent&&this._parent.stream&&(e.pos=Math.max(0,this._parent.stream.getPos()-1)),this._onCreate(t,e),this.hasNext()||this._onComplete(t,e),e},t.prototype._peekParentNextToken=function(){if("rt"===this.style.markupName)return null;for(var t=this._parent;t&&t.style===this.style;)t=t._parent||null;return t=t||this._parent,t&&t.stream?t.stream.peek():null},t.prototype._peekParentNextHeadChar=function(t){if(t instanceof Nehan.Text){var e=t.getContent().substring(0,1);return new Nehan.Char(e)}if(t instanceof Nehan.Tag){if("ruby"===t.name)return null;var e=t.getContent().replace(/^[\s]*<[^>]+>/,"").substring(0,1);return new Nehan.Char(e)}return null},t.prototype._estimateParentNextHeadMeasure=function(t){var e=this.style.getFontSize();if(t instanceof Nehan.Tag&&"ruby"===t.name){var n=new Nehan.RubyTokenStream(t.getContent()).get(),r=n.getCharCount(),i=n.getRtString().length;return Math.max(Math.floor(i*e/2),r*e)}return e},t.prototype._hyphenateLine=function(t){var e=this.peekLastCache()||this.stream.peek();if(null!==e){var n=this.stream.peek();if(n=n&&e.pos===n.pos?this.stream.peek(1):n,Nehan.Config.danglingHyphenate&&t.hyphenateDangling(e,n)===!0)return this._addElement(t,e,0),n?this.stream.setPos(n.pos):this.stream.get(),t.setLineBreak(!0),t.setHyphenated(!0),void this.clearCache();var r=t.hyphenateSweep(e,n);if(r){var i=(r.pos-e.pos)*this.style.getFontSize();t.addInlineMeasure(i),this.stream.setPos(r.pos),t.setLineBreak(!0),t.setHyphenated(!0),this.clearCache()}}},t.prototype._getNext=function(t){if(this.hasCache()){var e=this.popCache(t);return e}var n=this.stream.get();return null===n?null:Nehan.Token.isWhiteSpace(n)?this._getWhiteSpace(t,n):this._getText(t,n)},t.prototype._breakInline=function(e){this.setTerminate(!0),null!==this._parent&&(this._parent instanceof t?this._parent._breakInline(e):this._parent.setChildLayout(e))},t.prototype._getWhiteSpace=function(t,e){return this.style.isPre()?this._getWhiteSpacePre(t,e):(this.stream.skipUntil(Nehan.Token.isWhiteSpace),(e.isNewLine()||e.isTabSpace())&&Nehan.Char.call(e," "),this._getText(t,e))},t.prototype._getWhiteSpacePre=function(t,e){return Nehan.Token.isNewLine(e)?(t.setLineBreak(!0),null):this._getText(t,e)},t.prototype._getText=function(t,e){switch(e.hasMetrics()||this._setTextMetrics(t,e),e._type){case"char":case"tcy":case"ruby":return e;case"word":return this._getWord(t,e)}throw console.error("Nehan::TextGenerator, undefined token:",e),"Nehan::TextGenerator, undefined token"},t.prototype._setTextMetrics=function(t,e){Nehan.Config.kerning&&(e instanceof Nehan.Char&&e.isKerningChar()?this._setTextSpacing(t,e):e instanceof Nehan.Word&&this._setTextSpacing(t,e)),e.setMetrics(this.style.flow,this.style.getFont())},t.prototype._setTextSpacing=function(t,e){var n=this.stream.peek(),r=t.getInlineLastElement(),i=n&&Nehan.Token.isText(n)?n:null;Nehan.Spacing.add(e,r,i)},t.prototype._getWord=function(t,e){var n=t.getInlineRestMeasure(),r=e.getAdvance(this.style.flow,this.style.letterSpacing||0);if(n>=r)return e.setDivided(!1),e;if(r<=t.getInlineMaxMeasure()&&!this.style.isWordBreakAll())return e;var i=e.cutMeasure(this.style.flow,this.style.getFont(),n);return e.isDivided()?(""!==e.data&&e.bodySize>0&&this.stream.prev(),i.bodySize=Math.min(n,i.bodySize),i):e},t.prototype._getMeasure=function(t){return t.getAdvance(this.style.flow,this.style.letterSpacing||0)},t.prototype._addElement=function(t,e,n){t.addInlineTextElement(e,n),this._onAddElement(t,e)},t}(),C=function(){function t(t,n){y.call(this,t,n),e(t)}var e=function(t){var e=t.getMarkupAttr("name");e&&s.addAnchor(e)};return Nehan.Class.extend(t,y),t.prototype._onComplete=function(t,n){e(this.style)},t}(),N=function(){function t(t,e){d.call(this,t,e)}return Nehan.Class.extend(t,d),t.prototype._onAddElement=function(t,e){if(1===t.getBlockLineNo()){this.style=this.style.parent;for(var n=this._child,r=this;n;){n.style=r.style;var i=n.peekLastCache();i&&n instanceof x&&i.setMetrics&&i.setMetrics(n.style.flow,n.style.getFont()),r=n,n=n._child}}},t}(),b=function(){function t(t,e){g.call(this,t,null),this.output=e}return Nehan.Class.extend(t,g),t.prototype.hasNext=function(){return!this._terminate},t.prototype["yield"]=function(t){return this._terminate?null:(this._terminate=!0,this.output)},t}(),k=function(){function t(t,e){d.call(this,t,e)}return Nehan.Class.extend(t,d),t.prototype["yield"]=function(t){return this.style.updateContextSize(t.getBlockRestExtent(),t.getInlineMaxMeasure()),d.prototype["yield"].call(this)},t}(),v=function(){function t(t,e,n){d.call(this,t,e),this.generators=n,this.setChildLayout(new d(t.clone({"float":"start"}),e))}return Nehan.Class.extend(t,g),t.prototype.hasNext=function(){return this._terminate?!1:this._hasNextFloat()||this.hasCache()},t.prototype._hasNextFloat=function(){return Nehan.List.exists(this.generators,function(t){return t.hasNext()})},t.prototype._yield=function(t){var e=this._yieldFloatStack(t),n=t.getInlineRestMeasure(),r=e.getExtent(),i=n;return 0>=n||0>=r?null:this._yieldFloat(t,e,i,n,r)},t.prototype._yieldFloat=function(t,e,n,r,i){if(0>=r)return null;if(e.isEmpty())return this._yieldFloatSpace(t,e.getLastGroup(),r,i);var o=this.style.flow,s=e.getLastGroup(),a=e.pop(o),h=r-a.getMeasure(o),l=this._yieldFloat(t,e,n,h,a.getExtent(o)),u=this._wrapFloat(a,l,r),p=i-a.getExtent(o);if(0>=p){if(!this.hasNext()){var c=this._parent,f=this._child,g=f._child||null;g&&(g._parent=c,g.style.forceUpdateContextSize(n,c.style.contentExtent)),c._child=g,c._cachedElements=f._cachedElements||[]}return u}var d=this._yieldFloatSpace(t,s,r,p);return this._wrapBlocks([u,d])},t.prototype._sortFloatRest=function(t,e){var n=t.getElements(),r=t.isFloatStart()?n.concat(e):[e].concat(n);return Nehan.List.filter(r,function(t){return null!==t})},t.prototype._wrapBlocks=function(t){var e=this.style.flow,n=Nehan.List.filter(t,function(t){return null!==t}),r=n[0].getLayoutMeasure(e),i=Nehan.List.sum(n,0,function(t){return t.getLayoutExtent(e)}),o=Nehan.List.exists(n,function(t){return t.breakAfter});return this.style.createChild("div",{"float":"start",measure:r}).createBlock({elements:n,breakAfter:o,extent:i})},t.prototype._wrapFloat=function(t,e,n){var r=this.style.flow,i=t.getExtent(r),o=this._sortFloatRest(t,e||null),s=Nehan.List.exists(o,function(t){return t.breakAfter});return this.style.createChild("div",{"float":"start",measure:n}).createBlock({elements:o,breakAfter:s,extent:i})},t.prototype._yieldFloatSpace=function(t,e,n,r){return this._child.style.forceUpdateContextSize(n,r),this._child.floatGroup=e,this.yieldChildLayout()},t.prototype._yieldFloatStack=function(t){var e=[],n=[];return Nehan.List.iter(this.generators,function(r){var i=r["yield"](t);i&&(i.hasNext=r.hasNext(),r.style.isFloatStart()?e.push(i):r.style.isFloatEnd()&&n.push(i))}),new Nehan.FloatGroupStack(this.style.flow,e,n)},t}(),_=function(){function t(t,e){g.call(this,t,null),this.generators=e}return Nehan.Class.extend(t,g),t.prototype._yield=function(t){if(this.hasCache())return this.popCache();var e=this._yieldParallelBlocks(t);if(null===e)return null;var n=this._wrapBlocks(t,e),r=n.getLayoutExtent(this.style.flow);return t.hasBlockSpaceFor(r)?(t.addBlockElement(n,r),n):(this.pushCache(n),null)},t.prototype.hasNext=function(t){return this._terminate?!1:this.hasCache()?!0:Nehan.List.exists(this.generators,function(t){return t.hasNext()})},t.prototype._yieldParallelBlocks=function(t){var e=Nehan.List.map(this.generators,function(e){return e["yield"](t)});return Nehan.List.forall(e,function(t){return null===t})?null:e},t.prototype._findMaxBlock=function(t){var e=this.style.flow;return Nehan.List.maxobj(t,function(t){return t?t.getLayoutExtent(e):0})},t.prototype._alignContentExtent=function(t,e){var n=this.style.flow,r=this.generators;return Nehan.List.map(t,function(t,i){return null===t?r[i].style.createBlock({elements:[],extent:e}):t.resizeExtent(n,e)})},t.prototype._wrapBlocks=function(t,e){var n=this.style.flow,r=this._findMaxBlock(e),i=r.getContentExtent(n),o=t.getBlockRestExtent()-i,s=this.style.getEdgeAfter(),a=this._alignContentExtent(e,i);return this.style.createBlock({elements:a,extent:r.getLayoutExtent(n),useBeforeEdge:this.isFirstOutput(),useAfterEdge:!this.hasNext()&&o>=s})},t}(),w=function(){function t(t,e){d.call(this,t,e),this.style.startOutlineContext()}return Nehan.Class.extend(t,d),t.prototype._onComplete=function(t,e){this.style.endOutlineContext()},t}(),S=function(){function t(t,e){d.call(this,t,e),this.style.startSectionContext()}return Nehan.Class.extend(t,d),t.prototype._onComplete=function(t,e){this.style.endSectionContext()},t}(),E=function(){function t(t,e){d.call(this,t,e),this.style.setListItemCount(this.stream.getTokenCount())}return Nehan.Class.extend(t,d),t}(),T=function(){function t(t,e){_.call(this,t,[this._createListMarkGenerator(t),this._createListBodyGenerator(t,e)])}return Nehan.Class.extend(t,_),t.prototype._createListMarkGenerator=function(t){var e=t.getListMarkerSize(),n=t.getChildIndex(),r=t.getListMarkerHtml(n+1),i=e.getMeasure(t.flow),o=t.createChild("li-marker",{"float":"start",measure:i},{"class":"nehan-li-marker"});return new d(o,new Nehan.TokenStream(r,{flow:t.flow}))},t.prototype._createListBodyGenerator=function(t,e){var n=t.getListMarkerSize(),r=t.contentMeasure-n.getMeasure(t.flow),i=t.createChild("li-body",{"float":"start",measure:r},{"class":"nehan-li-body"});return new d(i,e)},t}(),B=function(){function t(t,e){d.call(this,t,e),"auto"===t.getCssAttr("table-layout")&&(t.tablePartition=this._createAutoPartition(e),e.rewind())}return Nehan.Class.extend(t,d),t.prototype._createAutoPartition=function(t){for(var e=new Nehan.PartitionHashSet;t.hasNext();){var n=t.get();if(null===n)break;if(Nehan.Token.isTag(n))switch(n.getName()){case"tbody":case"thead":case"tfoot":var r=this._createAutoPartition(new Nehan.TokenStream(n.getContent(),{flow:this.style.flow,filter:Nehan.Closure.isTagName(["tr"])}));e=e.union(r);break;case"tr":var i=new Nehan.TokenStream(n.getContent(),{flow:this.style.flow,filter:Nehan.Closure.isTagName(["td","th"])}).getTokens(),o=i.length,s=this._getPartition(i);e.add(o,s)}}return e},t.prototype._getPartition=function(t){var e=t.length,n=Nehan.List.map(t,function(t){return this._getPartitionUnit(t,e)}.bind(this));return new Nehan.Partition(n)},t.prototype._getPartitionUnit=function(t,e){var n=t.getAttr("measure")||t.getAttr("width")||null;if(n)return new Nehan.PartitionUnit({weight:n,isStatic:!0});var r=(t.getContent(),t.getContent().replace(/<br \/>/g,"\n").replace(/<br>/g,"\n").split("\n")),i=Nehan.List.maxobj(r,function(t){return t.length}),o=Math.floor(this.style.contentMeasure/2),s=Math.floor(this.style.contentMeasure/(2*e)),a=i.length*this.style.getFontSize();return a=Math.max(s,Math.min(a,o)),a=Math.max(this.style.getFontSize(),a),new Nehan.PartitionUnit({weight:a,isStatic:!1})},t}(),L=function(){function t(t,e){var n=this._getGenerators(t,e);_.call(this,t,n)}return Nehan.Class.extend(t,_),t.prototype._getGenerators=function(t,e){var n=this._getChildStyles(t,e);return Nehan.List.map(n,function(t){return new M(t,this._createStream(t))}.bind(this))},t.prototype._getChildStyles=function(t,e){var n=e.getTokens(),r=t.contentMeasure,i=t.getTablePartition(),o=i?i.getSizes({partitionCount:n.length,measure:t.contentMeasure}):[];return Nehan.List.map(n,function(e,i){var s=new c(e,t),a=s.staticMeasure,h=a&&r>=a?a:Math.floor(r/(n.length-i));return o.length>0&&(h=o[i]),r-=h,s.floatDirection=Nehan.FloatDirections.get("start"),s.initContextMeasure(h),s})},t.prototype._getChildTags=function(t){return Nehan.List.filter(t.getTokens(),function(t){return t instanceof Nehan.Tag&&("td"===t.getName()||"th"===t.getName())})},t}(),M=function(){function t(t,e){w.call(this,t,e)}return Nehan.Class.extend(t,w),t}(),A=function(){function t(t,e){d.call(this,t,e)}return Nehan.Class.extend(t,d),t.prototype._getHeaderRank=function(t){return this.style.getMarkupName().match(/h([1-6])/)?parseInt(RegExp.$1,10):0},t.prototype._onComplete=function(t,e){var n=this.style.startHeaderContext({type:this.style.getMarkupName(),rank:this._getHeaderRank(),title:this.style.getMarkupContent()});e.id=Nehan.Css.addNehanHeaderPrefix(n)},t}(),P=function(){function t(t){var e=new Nehan.Tag("<body>",t),n=new c(e,null),r=new Nehan.TokenStream(t,{flow:n.flow});w.call(this,n,r)}return Nehan.Class.extend(t,w),t.prototype._onCreate=function(t,e){e.seekPos=this.stream.getSeekPos(),e.charPos=s.getCharPos(),e.percent=this.stream.getSeekPercent(),e.pageNo=s.getPageNo(),s.stepCharPos(e.charCount||0),s.stepPageNo(),s.getPageNo()>=Nehan.Config.maxPageCount&&this.setTerminate(!0)},t}(),z=function(){function t(t){this.stream=new Nehan.TokenStream(t,{filter:Nehan.Closure.isTagName(["head","body"])}),this.stream.isEmptyTokens()&&(this.stream.tags=[new Nehan.Tag("body",t)]),this.generator=this._createGenerator()}return t.prototype["yield"]=function(){return this.generator["yield"]()},t.prototype.hasNext=function(){return this.generator.hasNext()},t.prototype.setTerminate=function(t){this.generator.setTerminate(t)},t.prototype.addText=function(t){this.generator.addText(t)},t.prototype._createGenerator=function(){for(;this.stream.hasNext();){var t=this.stream.get();switch(t.getName()){case"head":this._parseDocumentHeader(new Nehan.TokenStream(t.getContent(),{filter:Nehan.Closure.isTagName(["title","meta","link","style","script"])}));break;case"body":return this._createBodyGenerator(t.getContent())}}return this._createBodyGenerator(this.stream.getSrc())},t.prototype._createBodyGenerator=function(t){return new P(t)},t.prototype._parseDocumentHeader=function(t){for(var e=new Nehan.DocumentHeader;t.hasNext();){var n=t.get();switch(n.getName()){case"title":e.setTitle(n.getContent());break;case"meta":e.addMeta(n);break;case"link":e.addLink(n);break;case"style":e.addStyle(n);break;case"script":e.addScript(n)}}s.setDocumentHeader(e)},t}(),I=function(){function t(t){this.stream=new Nehan.TokenStream(t,{filter:Nehan.Closure.isTagName(["!doctype","html"])}),this.stream.isEmptyTokens()&&(this.stream.tokens=[new Nehan.Tag("html",t)]),this.generator=this._createGenerator()}return t.prototype["yield"]=function(){return this.generator["yield"]()},t.prototype.hasNext=function(){return this.generator.hasNext()},t.prototype.setTerminate=function(t){this.generator.setTerminate(t)},t.prototype.addText=function(t){this.generator.addText(t)},t.prototype._createGenerator=function(){for(;this.stream.hasNext();){var t=this.stream.get();switch(t.getName()){case"!doctype":s.setDocumentType("html");break;case"html":return this._createHtmlGenerator(t)}}var e=new Nehan.Tag("<html>",this.stream.getSrc());return this._createHtmlGenerator(e)},t.prototype._createHtmlGenerator=function(t){return new z(t.getContent())},t}(),F=function(){function t(t){this.direction=t}return t.prototype.evaluate=function(t){return this._getEvaluator(t)._evaluate(t)},t.prototype._getEvaluator=function(t){var e=t.style.isTextVertical();return"vert"!==this.direction||e?"hori"===this.direction&&e?new R:this:new H},t.prototype._createElement=function(t,e){e=e||{};var n=e.css||{},r=e.attrs?e.attrs instanceof Nehan.TagAttrs?e.attrs.attrs:e.attrs:{},i=e.attrs?e.attrs.dataset:{},o=document.createElement(t);return e.id&&(o.id=e.id),e.className&&(o.className=e.className),e.content&&(o.innerHTML=e.content),"undefined"!=typeof e.rootBlockId&&(i.rootBlockId=e.rootBlockId),"undefined"!=typeof e.blockId&&(i.blockId=e.blockId),Nehan.Obj.iter(n,function(t,e){try{o.style[Nehan.Utils.camelize(t)]=e}catch(n){}}),Nehan.Obj.iter(r,function(t,e){if("style"!==t&&"class"!==t)try{o[t]=e}catch(n){console.error("try to set %o to %s but failed.",e,t)}}),Nehan.Args.copy(o.dataset,i),o},t.prototype._createClearFix=function(t){var e=document.createElement("div");return e.style.clear=t||"both",e},t.prototype._appendChild=function(t,e){e instanceof Array?Nehan.List.iter(e,function(e){this._appendChild(t,e)}.bind(this)):t.appendChild(e)},t.prototype._evaluate=function(t,e){var n=this._evalElementRoot(t,e||{}),r=n.innerHTML?n:Nehan.List.fold(t.elements,n,function(e,n){return"void"===n._type?e:(this._appendChild(e,this._evalElementChild(t,n)),n.withBr&&this._appendChild(e,document.createElement("br")),n.withClearFix&&this._appendChild(e,this._createClearFix()),e)}.bind(this)),i=t.getOnCreate();return i&&i(new f(r,t)),r},t.prototype._evalElementRoot=function(t,e){return e=e||{},this._createElement(e.name||"div",{id:t.getId(),className:t.getClassName(),attrs:t.getAttrs(),content:e.content||t.getContent(),rootBlockId:t.rootBlockId,blockId:t.blockId,css:e.css||t.getBoxCss()})},t.prototype._evalElementChild=function(t,e){switch(t.display){case"inline":return e instanceof o?this._evalInlineChildElement(t,e):this._evalInlineChildText(t,e);default:return this._evalBlockChildElement(t,e)}},t.prototype._evalBlockChildElement=function(t,e){switch(e.style.getMarkupName()){case"img":return this._evalImage(e);case"a":return this._evalLink(t,e);default:return this.evaluate(e)}},t.prototype._evalInlineChildElement=function(t,e){switch(e.style.getMarkupName()){case"img":return this._evalInlineImage(t,e);case"a":return this._evalLink(t,e);default:return this._evalInlineChildTree(t,e)}},t.prototype._evalInlineChildTree=function(t,e){return this._evaluate(e)},t.prototype._evalInlineChildText=function(t,e){return t.style.isTextEmphaEnable()&&Nehan.Token.isEmphaTargetable(e)?this._evalEmpha(t,e):this._evalTextElement(t,e)},t.prototype._evalImage=function(t){return this._evaluate(t,{name:"img"})},t.prototype._evalInlineImage=function(t,e){return this._evalImage(e)},t.prototype._evalLink=function(t,e){var n=new Nehan.Uri(e.style.getMarkupAttr("href")),r=n.getAnchorName();if(r){var i=s.getAnchorPageNo(r);e.classes.push("nehan-anchor-link"),e.style.markup.setAttr("data-page",i)}return this._evalLinkElement(t,e)},t.prototype._evalTextElement=function(t,e){switch(e._type){case"word":return this._evalWord(t,e);case"char":return this._evalChar(t,e);case"tcy":return this._evalTcy(t,e);case"ruby":return this._evalRuby(t,e);default:throw console.error("invalid text element:%o",e),"invalid text element"}},t}(),R=function(){function t(){F.call(this,"vert")}return Nehan.Class.extend(t,F),t.prototype._evalLinkElement=function(t,e){return this._evaluate(e,{name:e.isTextBlock()?"div":"a"})},t.prototype._evalRuby=function(t,e){return[this._evalRb(t,e),this._evalRt(t,e)]},t.prototype._evalRb=function(t,e){var n=new c(new Nehan.Tag("<rb>"),t.style),r=n.createLine({elements:e.getRbs()});return this._evaluate(r,{css:e.getCssVertRb(t)})},t.prototype._evalRt=function(t,e){var n=new y(new c(e.rt,t.style),new Nehan.TokenStream(e.getRtString(),{flow:t.style.flow}),null)["yield"]();return Nehan.Args.copy(n.css,e.getCssVertRt(t)),this._evaluate(n)},t.prototype._evalWord=function(t,e){return Nehan.Env.isTransformEnable?Nehan.Env.client.isTrident()?this._evalWordTransformTrident(t,e):this._evalWordTransform(t,e):Nehan.Env.client.isIE()?this._evalWordIE(t,e):""},t.prototype._evalWordTransform=function(t,e){var n=this._createElement("div",{css:e.getCssVertTrans(t)}),r=this._createElement("div",{content:e.data,className:"nehan-rotate-90",css:e.getCssVertTransBody(t)});return n.appendChild(r),n},t.prototype._evalWordTransformTrident=function(t,e){var n=this._createElement("div",{css:e.getCssVertTrans(t)}),r=this._createElement("div",{content:e.data,css:e.getCssVertTransBodyTrident(t)});return n.appendChild(r),n},t.prototype._evalWordIE=function(t,e){return this._createElement("div",{content:e.data,className:"nehan-vert-ie",css:e.getCssVertTransIE(t)})},t.prototype._evalRotateChar=function(t,e){return Nehan.Env.isTransformEnable?this._evalRotateCharTransform(t,e):Nehan.Env.client.isIE()?this._evalRotateCharIE(t,e):this._evalCharWithBr(t,e)},t.prototype._evalRotateCharTransform=function(t,e){var n=Nehan.Env.client.isIE()&&e.isDash()?e.getCssVertDashIE():{};return this._createElement("div",{content:e.getData(t.getFlow()),className:"nehan-rotate-90",css:n})},t.prototype._evalRotateCharIE=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),className:"nehan-vert-ie",css:e.getCssVertRotateCharIE(t)})},t.prototype._evalTcy=function(t,e){return this._createElement("div",{content:e.data,className:"nehan-tcy",css:e.getCssVert(t)})},t.prototype._evalChar=function(t,e){var n=Nehan.Config.useVerticalGlyphIfEnable&&Nehan.Env.isVerticalGlyphEnable;return e.isImgChar()?n?this._evalVerticalGlyph(t,e):this._evalImgChar(t,e):e.isSpace()?this._evalSpace(t,e):e.isTabSpace()?this._evalTabChar(t,e):e.isRotateChar()?n?this._evalVerticalGlyph(t,e):this._evalRotateChar(t,e):e.isSmallKana()?this._evalSmallKana(t,e):e.isPaddingEnable()?this._evalPaddingChar(t,e):t.letterSpacing?this._evalCharLetterSpacing(t,e):e.isSingleHalfChar()?this._evalCharSingleHalfChar(t,e):e.isHalfKana()?this._evalCharHalfKana(t,e):e.isPaddingEnable()?this._evalCharWithSpacing(t,e):this._evalCharWithBr(t,e)},t.prototype._evalCharWithSpacing=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),css:e.getCssPadding(t)})},t.prototype._evalCharWithBr=function(t,e){return e.withBr=!0,document.createTextNode(Nehan.Html.unescape(e.getData(t.getFlow())))},t.prototype._evalCharLetterSpacing=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),css:e.getCssVertLetterSpacing(t)})},t.prototype._evalCharSingleHalfChar=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),css:e.getCssVertSingleHalfChar(t)})},t.prototype._evalCharHalfKana=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),css:e.getCssVertHalfKana(t)})},t.prototype._evalEmpha=function(t,e){var n=this._evalEmphaSrc(t,e),r=this._evalEmphaText(t,e),i=this._createElement("div",{className:"nehan-empha-wrap",css:t.style.textEmpha.getCssVertEmphaWrap(t,e)});return i.appendChild(n),i.appendChild(r),i},t.prototype._evalEmphaSrc=function(t,e){return this._createElement("span",{content:e.getData(t.getFlow()),className:"nehan-empha-src"})},t.prototype._evalEmphaText=function(t,e){return this._createElement("span",{content:t.style.textEmpha.getText(),className:"nehan-empha-text",css:e.getCssVertEmphaText(t)})},t.prototype._evalPaddingChar=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),css:e.getCssPadding(t)})},t.prototype._evalImgChar=function(t,e){var n=t.color||new Nehan.Color(Nehan.Display.fontColor),r=n.getRgb(),i=Nehan.Palette.getColor(r).toUpperCase();return this._createElement("img",{className:"nehan-img-char",attrs:{src:e.getImgSrc(i)},css:e.getCssVertImgChar(t)})},t.prototype._evalVerticalGlyph=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),className:"nehan-vert-glyph",css:e.getCssVertGlyph(t)})},t.prototype._evalSmallKana=function(t,e){var n=t.style.textEmpha&&t.style.textEmpha.isEnable()?"span":"div";return this._createElement(n,{content:e.getData(t.getFlow()),css:e.getCssVertSmallKana()})},t.prototype._evalSpace=function(t,e){return this._createElement("div",{content:"&nbsp;",className:"nehan-space",css:e.getCssVertSpaceChar(t)})},t.prototype._evalTabChar=function(t,e){return this._createElement("div",{content:"&nbsp;",className:"nehan-tab",css:e.getCssVertTabChar(t)})},t}(),H=function(){function t(){F.call(this,"hori")}return Nehan.Class.extend(t,F),t.prototype._evalInlineChildTree=function(t,e){return this._evaluate(e,{name:"span"})},t.prototype._evalLinkElement=function(t,e){return this._evaluate(e,{name:e.isTextBlock()?"span":"a"})},t.prototype._evalInlineImage=function(t,e){return this._evaluate(e,{name:"img",css:e.getCssHoriInlineImage(t)})},t.prototype._evalRuby=function(t,e){return[this._evalRt(t,e),this._evalRb(t,e)]},t.prototype._evalRb=function(t,e){var n=new c(new Nehan.Tag("<rb>"),t.style),r=n.createLine({elements:e.getRbs()});return this._evaluate(r,{css:e.getCssHoriRb(t)})},t.prototype._evalRt=function(t,e){return this._createElement("div",{content:e.getRtString(),className:"nehan-rt",css:e.getCssHoriRt(t)})},t.prototype._evalWord=function(t,e){return this._createElement("span",{content:e.data,css:e.getCssHori(t)})},t.prototype._evalTcy=function(t,e){return this._createElement("span",{css:e.getCssHori(t),content:e.data})},t.prototype._evalChar=function(t,e){return e.isSpace()?this._evalSpace(t,e):e.isTabSpace()?this._evalTabChar(t,e):e.isCharRef()?document.createTextNode(Nehan.Html.unescape(e.getData(t.getFlow()))):e.isKerningChar()?this._evalKerningChar(t,e):e.isPaddingEnable()?this._evalCharWithSpacing(t,e):document.createTextNode(e.getData(t.getFlow()))},t.prototype._evalCharWithSpacing=function(t,e){return this._createElement("span",{content:e.getData(t.getFlow()),css:e.getCssPadding(t)})},t.prototype._evalEmpha=function(t,e){var n=this._evalEmphaSrc(t,e),r=this._evalEmphaText(t,e),i=this._createElement("span",{css:t.style.textEmpha.getCssHoriEmphaWrap(t,e)});return i.appendChild(r),i.appendChild(n),i},t.prototype._evalEmphaSrc=function(t,e){return this._createElement("div",{content:e.getData(t.getFlow()),className:"nehan-empha-src",css:e.getCssHoriEmphaSrc(t)})},t.prototype._evalEmphaText=function(t,e){return this._createElement("div",{content:t.style.textEmpha.getText(),className:"nehan-empha-text",css:e.getCssHoriEmphaText(t)})},t.prototype._evalKerningChar=function(t,e){var n=e.getCssPadding(t);return e.isKakkoStart()?(n["margin-left"]="-0.5em",this._createElement("span",{content:e.getData(t.getFlow()),className:"nehan-char-kakko-start",css:n})):e.isKakkoEnd()?(n["margin-right"]="-0.5em",this._createElement("span",{content:e.getData(t.getFlow()),className:"nehan-char-kakko-end",css:n})):e.isKutenTouten()?(n["margin-right"]="-0.5em",this._createElement("span",{content:e.getData(t.getFlow()),className:"nehan-char-kuto",css:n})):document.createTextNode(e.getData(t.getFlow()))},t.prototype._evalPaddingChar=function(t,e){return this._createElement("span",{content:e.getData(t.getFlow()),css:e.getCssPadding(t)})},t.prototype._evalSpace=function(t,e){return this._createElement("span",{content:"&nbsp;",className:"nehan-space",css:e.getCssHoriSpaceChar(t)})},t.prototype._evalTabChar=function(t,e){
return this._createElement("span",{content:"&nbsp;",className:"nehan-tab",css:e.getCssHoriTabChar(t)})},t}();return i.setValues(Nehan.globalStyle||{}),i.setValues(n.style||{}),e.prototype.createPageStream=function(t){return new l(t)},e.prototype.createOutlineElement=function(t){return this.documentContext.createBodyOutlineElement(t)},e.prototype.getAnchorPageNo=function(t){return this.documentContext.getAnchorPageNo(t)},e.prototype.setStyle=function(t,e){return this.selectors.setValue(t,e),this},e.prototype.setStyles=function(t){return this.selectors.setValues(t),this},new e},Nehan.PagedElement=function(){function t(t){this.pageNo=0,this.element=document.createElement("div"),this.engine=Nehan.createEngine(t),this._pageStream=null}return t.prototype.isLastPage=function(){return this.getPageNo()+1>=this.getPageCount()},t.prototype.getEngine=function(){return this.engine},t.prototype.getElement=function(){return this.element},t.prototype.getContent=function(){return this._pageStream?this._pageStream.text:""},t.prototype.getPageCount=function(){return this._pageStream?this._pageStream.getPageCount():0},t.prototype.getPage=function(t){return this._pageStream?this._pageStream.getPage(t):null},t.prototype.getPagedElement=function(t){var e=this.getPage(t);return e?e.element:null},t.prototype.getPageNo=function(){return this.pageNo},t.prototype.find=function(t){return this._pageStream?this._pageStream.find(t):null},t.prototype.filter=function(t){return this._pageStream?this._pageStream.filter(t):[]},t.prototype.setNextPage=function(){return this.pageNo+1<this.getPageCount()?this.setPage(this.pageNo+1):null},t.prototype.setPrevPage=function(){return this.pageNo>0?this.setPage(this.pageNo-1):null},t.prototype.setStyle=function(t,e){return this.engine.setStyle(t,e),this},t.prototype.setStyles=function(t){return this.engine.setStyles(t),this},t.prototype.setContent=function(t,e){return this._pageStream=this.engine.createPageStream(t),this._asyncGet(e||{}),this},t.prototype.addContent=function(t,e){this._pageStream.addText(t),this._asyncGet(e||{})},t.prototype.setPage=function(t){var e=this.getPage(t);if(null===e||null===e.element)return null;for(this.pageNo=t;this.element.firstChild;)this.element.removeChild(this.element.firstChild);return this.element.appendChild(e.element),e},t.prototype.createOutlineElement=function(t){return this.engine.createOutlineElement(t)},t.prototype._asyncGet=function(t){this._pageStream.asyncGet({capturePageText:t.capturePageText||!1,maxPageCount:t.maxPageCount||-1,onProgress:function(e,n){0===e.pageNo&&this.setPage(e.pageNo),t.onProgress&&t.onProgress(e,this)}.bind(this),onComplete:function(e,n){t.onComplete&&t.onComplete(e,this)}.bind(this)})},t}(),Nehan.createPagedElement=function(t){return new Nehan.PagedElement(t||{})};